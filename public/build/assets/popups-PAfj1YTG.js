import{f as M,b as q}from"./components-ur4KxgCU.js";import{c as O}from"./runtime-dom.esm-bundler-DUkN6N6G.js";import{n as Q,b as F,N,d as B,c as z}from"./ns-prompt-popup-Bpr2kol9.js";import{n as W,a as H}from"./ns-orders-preview-popup-CBWyOQ5Z.js";import{n as D}from"./ns-procurement-quantity-b-hAHL3B.js";import{n as E}from"./currency-BCJk0SN4.js";import{n as f,d as x,P as U,b as L}from"./bootstrap-CNAo4FMT.js";import{_ as a}from"./lang-BINodpp-.js";import{_ as T}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{r as p,c,o as d,a as h,F as P,b as e,t as l,f as m,n as j,e as V,g as S,w as C,i as w,s as R}from"./runtime-core.esm-bundler-Cugm6hpa.js";import"./ns-avatar-BAhZCTsF.js";import"./ns-avatar-image-BfMW3dTV.js";import"./chart-CD-SFYzA.js";const I={name:"ns-products-convertion",props:["popup","unitQuantity","product"],data(){return{unitQuantities:[],isLoading:!1,unitPair:{from:{unit:{},unitQuantity:{},selected:!0,quantity:0,realQuantity:0,fields:[{label:a("Assigned Unit"),name:"assigned_unit",value:"",type:"select",options:[]}]},to:{unit:{},unitQuantity:{},selected:!1,quantity:0,fields:[{label:a("Assigned Unit"),name:"assigned_unit",value:"",type:"select",options:[]}]}},selected:""}},mounted(){this.loadProductQuantities(),console.log(this)},methods:{__:a,async submitConvertion(){if(this.unitPair.from.quantity===0)return f.error(a("The quantity should be greater than 0"));if(Math.floor(this.unitPair.to.quantity)===0)return f.error(a(`The provided quantity can't result in any convertion for unit "{destination}"`).replace("{destination}",this.unitPair.to.unit.name));if(this.unitPair.from.quantity!==this.unitPair.from.realQuantity)try{const i=await new Promise((t,s)=>{U.show(Q,{title:a("Conversion Warning"),message:a("Only {quantity}({source}) can be converted to {destinationCount}({destination}). Would you like to proceed ?").replace("{quantity}",this.unitPair.from.realQuantity).replace("{destinationCount}",Math.floor(this.unitPair.to.quantity)).replace("{source}",this.unitPair.from.unit.name).replace("{destination}",this.unitPair.to.unit.name),onAction:r=>{r?t(!0):s(!1)}})});return this.proceedConversionSubmissions()}catch{return}try{const i=await new Promise((t,s)=>{U.show(Q,{title:a("Confirm Conversion"),message:a("You're about to convert {quantity}({source}) to {destinationCount}({destination}). Would you like to proceed?").replace("{quantity}",this.unitPair.from.quantity).replace("{destinationCount}",Math.floor(this.unitPair.to.quantity)).replace("{source}",this.unitPair.from.unit.name).replace("{destination}",this.unitPair.to.unit.name),onAction:r=>{r?t(!0):s(!1)}})});return this.proceedConversionSubmissions()}catch{return}},proceedConversionSubmissions(){this.isLoading=!0,nsHttpClient.post(`/api/products/${this.unitQuantity.product_id}/units/conversion`,{from:this.unitPair.from.unit.id,to:this.unitPair.to.unit.id,quantity:this.unitPair.from.realQuantity}).subscribe({next:i=>(this.isLoading=!1,this.popup.close(),this.popup.params.resolve(i),x.success(a("Conversion Successful"),a("The product {product} has been converted successfully.").replace("{product}",this.product.name))),error:i=>(this.isLoading=!1,this.popup.params.reject(i),x.error(a("An error occured"),i.message||a("An error occured while converting the product {product}").replace("{product}",this.product.name)))})},handlePairUnitUpdated(i){const t=this.selectedUnitPair();t.unitQuantity=this.unitQuantities.filter(r=>r.unit.id===i.value)[0],t.unit=t.unitQuantity.unit,t.fields[0].value=i.value;const s=t===this.unitPair.from?this.unitPair.to:this.unitPair.from;s.unit.id===t.unit.id&&(s.unitQuantity=this.unitQuantities.filter(r=>r.unit.id!==t.unit.id)[0],s.unit=s.unitQuantity.unit,s.fields[0].value=s.unit.id),this.updateFromPairQuantity(this.unitPair.from.quantity)},updateFromPairQuantity(i){i.length===0&&(i=0),i>this.unitPair.from.unitQuantity.quantity&&(i=this.unitPair.from.unitQuantity.quantity,f.info(a("The quantity has been set to the maximum available"))),this.unitPair.from.quantity=parseFloat(i);const t=this.unitQuantities.filter(o=>o.unit.base_unit)[0];if(t.length===0)return x.error(a("An error occured"),a("The product {product} has no base unit").replace("{product}",this.product.name));const r=this.unitPair.from.quantity*this.unitPair.from.unit.value*t.unit.value/this.unitPair.to.unit.value;this.unitPair.from.unit.value<this.unitPair.to.unit.value?this.unitPair.from.realQuantity=Math.floor(r)*this.unitPair.to.unit.value:this.unitPair.from.realQuantity=this.unitPair.from.quantity,this.unitPair.to.quantity=r},switchPair(){const i=this.unitPair.from.unit,t=this.unitPair.to.unit;this.unitPair.from.unit=t,this.unitPair.from.unitQuantity=this.unitQuantities.filter(s=>s.unit.id===t.id)[0],this.unitPair.from.quantity=Math.floor(this.unitPair.to.quantity),this.unitPair.to.unit=i,this.unitPair.to.unitQuantity=this.unitQuantities.filter(s=>s.unit.id===i.id)[0],this.updateFromPairQuantity(this.unitPair.from.quantity)},selectedUnitPair(){return this.unitPair[this.unitPair.from.selected?"from":"to"]},setVisible(i,t){const s=t==="from"?"to":"from";i[t].selected=!0,i[s].selected=!1},loadProductQuantities(){nsHttpClient.get("/api/products/"+this.unitQuantity.product_id+"/units/quantities").subscribe({next:i=>{this.unitQuantities=i,this.unitPair.from.unit=this.unitQuantity.unit,this.unitPair.from.unitQuantity=this.unitQuantity,this.unitPair.from.fields[0].value=this.unitQuantity.unit.id,this.unitPair.from.fields[0].options=i.map(t=>({label:t.unit.name,value:t.unit.id})),this.unitPair.to.unit=i.filter(t=>t.unit.id!==this.unitQuantity.unit.id)[0].unit,this.unitPair.to.unitQuantity=i.filter(t=>t.unit.id!==this.unitQuantity.unit.id)[0],this.unitPair.to.fields[0].value=this.unitPair.to.unit.id,this.unitPair.to.fields[0].options=i.map(t=>({label:t.unit.name,value:t.unit.id}))}})}}},Y={class:"shadow-lg w-[85.71vw] lg:w-[60vw] ns-box overflow-hidden flex flex-col"},G={class:"p-2 border-b ns-box-header text-fontcolor text-center font-medium flex justify-between items-center"},J={class:"relative"},K={class:"border-b border-box-edge"},X={class:"flex"},Z={class:"font-bold text-3xl"},$={class:"border-r border-box-edge relative"},tt={class:"font-bold text-3xl"},it={class:"p-2 border-b border-box-edge"},et={class:""},nt={key:0,class:"top-0 left-0 absolute h-full w-full flex items-center justify-center",style:{background:"rgb(121 121 121 / 20%)"}},st={key:1,class:"flex items-center h-full justify-center"};function ot(i,t,s,r,o,n){const b=p("ns-close-button"),_=p("ns-field"),y=p("ns-numpad"),v=p("ns-spinner");return d(),c("div",Y,[o.unitQuantities.length>0?(d(),c(P,{key:0},[e("div",G,[e("div",null,l(n.__("Unit Conversion : {product}").replace("{product}",s.product.name)),1),e("div",null,[m(b,{onClick:t[0]||(t[0]=u=>s.popup.close())})])]),e("div",J,[e("div",K,[e("div",X,[e("div",{class:j(["p-2 w-full md:w-1/2 flex flex-col items-center justify-center",o.unitPair.from.selected?"bg-info-primary text-white":""]),onClick:t[1]||(t[1]=u=>n.setVisible(o.unitPair,"from"))},[e("span",null,l(o.unitPair.from.unit.name),1),e("h3",Z,l(o.unitPair.from.quantity),1)],2),e("div",$,[e("div",{class:"rounded-full h-12 w-12 flex items-center justify-center absolute shadow bg-input-button p-2",onClick:t[2]||(t[2]=u=>n.switchPair()),style:{position:"absolute",left:"-22px",top:"14px"}},[...t[8]||(t[8]=[e("i",{class:"las la-exchange-alt text-3xl"},null,-1)])])]),e("div",{class:j(["p-2 w-full md:w-1/2 flex flex-col items-center justify-center",o.unitPair.to.selected?"bg-info-primary text-white":""]),onClick:t[3]||(t[3]=u=>n.setVisible(o.unitPair,"to"))},[e("span",null,l(o.unitPair.to.unit.name),1),e("h3",tt,l(Math.floor(o.unitPair.to.quantity)),1)],2)])]),e("div",it,[(d(!0),c(P,null,V(n.selectedUnitPair().fields,u=>(d(),S(_,{onChange:t[4]||(t[4]=g=>n.handlePairUnitUpdated(g)),field:u},null,8,["field"]))),256))]),e("div",et,[m(y,{onNext:t[6]||(t[6]=u=>n.submitConvertion()),value:o.unitPair.from.quantity,onChanged:t[7]||(t[7]=u=>n.updateFromPairQuantity(u))},{"numpad-footer":C(()=>[e("div",{onClick:t[5]||(t[5]=u=>n.updateFromPairQuantity(o.unitPair.from.unitQuantity.quantity)),class:"w-full ns-numpad-key h-24 font-bold flex items-center justify-center cursor-pointer col-span-3"},l(n.__("Convert {quantity} available").replace("{quantity}",o.unitPair.from.unitQuantity.quantity)),1)]),_:1},8,["value"])]),o.isLoading?(d(),c("div",nt,[m(v,{size:"24"})])):h("",!0)])],64)):h("",!0),o.unitQuantities.length===0?(d(),c("div",st,[m(v)])):h("",!0)])}const rt=T(I,[["render",ot]]),ut={name:"ns-products-preview",props:["popup","product"],computed:{product(){return this.popup.params.product}},methods:{__:a,nsCurrency:E,changeActiveTab(i){this.active=i,this.active==="units-quantities"&&this.loadProductQuantities()},loadProductQuantities(){console.log("is loadinfg"),this.hasLoadedUnitQuantities=!1,L.get(`/api/products/${this.product.id}/units/quantities`).subscribe({next:i=>{this.unitQuantities=i,this.hasLoadedUnitQuantities=!0}})},async convert(i,t){try{const s=await new Promise((r,o)=>{Popup.show(rt,{unitQuantity:i,product:t,resolve:r,reject:o})});this.loadProductQuantities()}catch(s){console.log({exception:s})}},async convertToLinkedProduct(i,t){if(!i.linked_product_id){f.error(a("This unit is not linked to any product.")).subscribe();return}if(confirm(this.__("Convert to Linked Product")+`

`+this.__("This will convert using the unit value defined in the unit group. Proceed?")))try{const r=await L.post(`/api/products/unit-quantities/${i.id}/convert-to-linked`,{quantity:1}).toPromise();r.status==="success"?(f.success(r.message).subscribe(),this.loadProductQuantities()):f.error(r.message||a("An error occurred")).subscribe()}catch(r){console.error(r);const o=r.error?.message||r.message||a("An error occurred while converting");f.error(o).subscribe()}}},data(){return{active:"units-quantities",unitQuantities:[],hasLoadedUnitQuantities:!1}},mounted(){this.loadProductQuantities()}},at={class:"shadow-lg w-[85.71vw] lg:w-[60vw] ns-box overflow-hidden flex flex-col"},lt={class:"p-2 border-b ns-box-header text-fontcolor text-center font-medium flex justify-between items-center"},dt={class:"flex-auto overflow-y-auto ns-box-body"},ct={class:"p-2"},pt={key:0,class:"table ns-table w-full"},ft={class:"p-1 border"},ht={width:"150",class:"text-right p-1 border"},mt={width:"150",class:"text-right p-1 border"},Pt={width:"150",class:"text-right p-1 border"},vt={class:"p-1 border text-left"},bt=["onClick"],_t=["onClick"],yt={class:"p-1 border text-right"},gt={class:"p-1 border text-right"},xt={class:"p-1 border text-right"};function wt(i,t,s,r,o,n){const b=p("ns-close-button"),_=p("ns-spinner"),y=p("ns-tabs-item"),v=p("ns-tabs");return d(),c("div",at,[e("div",lt,[e("div",null,l(n.__("Previewing :"))+" "+l(n.product.name),1),e("div",null,[m(b,{onClick:t[0]||(t[0]=u=>s.popup.close())})])]),e("div",dt,[e("div",ct,[m(v,{active:o.active,onActive:t[1]||(t[1]=u=>n.changeActiveTab(u))},{default:C(()=>[m(y,{label:n.__("Units & Quantities"),identifier:"units-quantities"},{default:C(()=>[o.hasLoadedUnitQuantities?(d(),c("table",pt,[e("thead",null,[e("tr",null,[e("th",ft,l(n.__("Unit")),1),e("th",ht,l(n.__("Sale Price")),1),e("th",mt,l(n.__("Wholesale Price")),1),e("th",Pt,l(n.__("Quantity")),1)])]),e("tbody",null,[(d(!0),c(P,null,V(o.unitQuantities,u=>(d(),c("tr",{key:u.id},[e("td",vt,[w(l(u.unit.name)+" ",1),n.product.rawType==="materialized"&&n.product.rawStockManagement==="enabled"?(d(),c(P,{key:0},[t[3]||(t[3]=w(" — ",-1)),e("a",{onClick:g=>n.convert(u,n.product),class:"text-sm text-info-secondary hover:underline border-dashed",href:"javascript:void(0)"},l(n.__("Convert")),9,bt),u.linked_product_id?(d(),c(P,{key:0},[t[2]||(t[2]=w(" — ",-1)),e("a",{onClick:g=>n.convertToLinkedProduct(u,n.product),class:"text-sm text-success-secondary hover:underline border-dashed",href:"javascript:void(0)"},l(n.__("To Linked")),9,_t)],64)):h("",!0)],64)):h("",!0)]),e("td",yt,l(n.nsCurrency(u.sale_price)),1),e("td",gt,l(n.nsCurrency(u.wholesale_price)),1),e("td",xt,l(u.quantity),1)]))),128))])])):h("",!0),o.hasLoadedUnitQuantities?h("",!0):(d(),S(_,{key:1,size:"16",border:"4"}))]),_:1},8,["label"])]),_:1},8,["active"])])])])}const Qt=T(ut,[["render",wt]]),A={nsOrderPreview:H,nsProductPreview:Qt,nsAlertPopup:z,nsConfirmPopup:Q,nsPromptPopup:B,nsMediaPopup:M,nsProcurementQuantity:D,nsOrdersRefund:W,nsSelectPopup:N,nsPOSLoadingPopup:F};for(let i in A)window[i]=A[i];const k=O({data(){return{popups:[],defaultClass:"absolute top-0 left-0 w-full h-full items-center flex overflow-y-auto justify-center is-popup"}},mounted(){nsState.subscribe(i=>{i.popups!==void 0&&(document.body.focus(),this.popups=R(i.popups),this.$forceUpdate())})},methods:{closePopup(i,t){(Object.values(t.target.classList).includes("is-popup")&&i.config!==void 0&&[void 0,!0].includes(i.config.closeOnOverlayClick)||Object.keys(i.config).length===0)&&(i.params&&typeof i.params.reject=="function"?(i.params.reject(!1),typeof i.close=="function"&&i.close(),t.stopPropagation()):i.close())},preventPropagation(i){i.stopImmediatePropagation()}}});for(let i in q)k.component(i,q[i]);document.addEventListener("DOMContentLoaded",()=>{k.mount("#dashboard-popups"),window.nsPopups=k});
