# 付款码支付功能 - 开发文档

## 文档信息

| 项目 | 信息 |
|-----|------|
| 文档名称 | 付款码支付功能开发文档 |
| 版本 | v1.0 |
| 创建日期 | 2026-01-25 |
| 功能模块 | POS 付款码支付系统 |
| 技术栈 | Laravel 12 + Vue 3 + TypeScript |

---

## 目录

1. [功能概述](#1-功能概述)
2. [技术架构](#2-技术架构)
3. [数据库设计](#3-数据库设计)
4. [后端开发](#4-后端开发)
5. [前端开发](#5-前端开发)
6. [API 接口文档](#6-api-接口文档)
7. [配置说明](#7-配置说明)
8. [开发指南](#8-开发指南)
9. [安全说明](#9-安全说明)
10. [故障排查](#10-故障排查)

---

## 1. 功能概述

### 1.1 功能简介

付款码支付功能允许商户通过扫描顾客的支付宝或微信付款码快速完成收款。

### 1.2 核心功能

- **支付宝付款码支付**：支持扫描支付宝付款码（10-18位数字）
- **微信付款码支付**：支持扫描微信付款码（10-18位数字）
- **配置管理**：后台配置支付宝/微信支付参数
- **连接测试**：验证配置是否正确
- **交易记录**：完整的交易日志记录
- **支付回调**：处理异步支付通知

### 1.3 支付流程

```
顾客出示付款码 → 收银员扫描/输入 → 系统验证 →
调用支付网关 → 处理支付 → 更新订单 → 完成收款
```

---

## 2. 技术架构

### 2.1 系统架构图

```
┌─────────────────────────────────────────────────────────┐
│                       前端层                           │
│  Vue 3 + TypeScript + TailwindCSS                     │
│  ┌─────────────────────────────────────────────────┐  │
│  │  支付组件 (alipay-payment.vue, wechat-payment.vue)│  │
│  └─────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                          ↓ HTTP/REST API
┌─────────────────────────────────────────────────────────┐
│                      控制器层                           │
│  PaymentCodeController                                │
│  - 处理支付请求                                         │
│  - 处理配置测试                                         │
│  - 处理支付回调                                         │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                       服务层                            │
│  ┌──────────────────────────────────────────────────┐  │
│  │  PaymentCodeService (核心服务)                     │  │
│  │  - 支付码验证                                       │  │
│  │  - 交易记录管理                                     │  │
│  │  - 支付流程编排                                     │  │
│  └──────────────────────────────────────────────────┘  │
│  ┌──────────────┐  ┌──────────────┐                    │
│  │AlipayGateway│  │WeChatGateway│                    │
│  │ 支付宝网关   │  │ 微信网关     │                    │
│  └──────────────┘  └──────────────┘                    │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                       数据层                             │
│  ┌──────────────────────────────────────────────────┐  │
│  │  PaymentCodeTransaction (交易记录模型)             │  │
│  │  nexopos_payment_code_transactions 表               │  │
│  └──────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────┐  │
│  │  PaymentType (支付类型模型)                        │  │
│  │  nexopos_payments_types 表                          │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### 2.2 目录结构

```
NexoPOS/
├── app/
│   ├── Models/
│   │   └── PaymentCodeTransaction.php          # 交易记录模型
│   ├── Services/
│   │   ├── PaymentCodeService.php            # 核心服务
│   │   └── Gateways/
│   │       ├── AlipayGateway.php            # 支付宝网关
│   │       └── WeChatGateway.php            # 微信网关
│   ├── Http/Controllers/Dashboard/
│   │   └── PaymentCodeController.php         # API 控制器
│   └── Settings/pos/
│       └── payment-codes.php                  # 配置文件
├── database/
│   ├── migrations/create/
│   │   └── 2025_01_25_000000_create_payment_code_transactions_table.php
│   └── seeders/
│       └── PaymentCodePaymentTypesSeeder.php # 支付类型 Seeder
├── routes/api/api/
│   └── payment-codes.php                      # 路由定义
└── resources/ts/pages/dashboard/pos/payments/
    ├── alipay-payment.vue                     # 支付宝组件
    └── wechat-payment.vue                     # 微信组件
```

---

## 3. 数据库设计

### 3.1 交易记录表 (nexopos_payment_code_transactions)

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|-------|------|------|----------|--------|------|
| id | BIGINT | 20 | NO | AUTO_INCREMENT | 主键 |
| order_id | INT | 11 | NO | - | 关联订单ID |
| order_payment_id | BIGINT | 20 | YES | NULL | 关联订单支付ID |
| payment_type | VARCHAR | 50 | NO | - | 支付类型 (alipay/wechat) |
| payment_code | VARCHAR | 255 | NO | - | 付款码（加密存储） |
| transaction_id | VARCHAR | 255 | YES | NULL | 第三方交易号 |
| amount | DECIMAL | 18,5 | NO | - | 交易金额 |
| status | VARCHAR | 50 | NO | pending | 交易状态 |
| response_data | TEXT | - | YES | NULL | 支付响应数据（JSON） |
| error_message | TEXT | - | YES | NULL | 错误信息 |
| author | INT | 11 | NO | - | 操作员ID |
| created_at | TIMESTAMP | - | YES | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | YES | CURRENT_TIMESTAMP | 更新时间 |

**索引**：
- PRIMARY KEY (`id`)
- INDEX `idx_payment_code_transactions_order_id` (`order_id`)
- INDEX `idx_payment_code_transactions_payment_type` (`payment_type`)
- UNIQUE INDEX `idx_payment_code_transactions_transaction_id` (`transaction_id`)
- INDEX `idx_payment_code_transactions_created_at` (`created_at`)

### 3.2 交易状态枚举

| 状态值 | 说明 | 使用场景 |
|-------|------|---------|
| pending | 处理中 | 支付请求已发送，等待响应 |
| success | 成功 | 支付成功完成 |
| failed | 失败 | 支付失败（余额不足、超时等） |
| refunded | 已退款 | 订单已退款 |
| cancelled | 已取消 | 订单已取消 |

### 3.3 ER 图

```
┌──────────────────────┐
│   Order (订单)         │
├──────────────────────┤
│ id (PK)              │
│ total                │
│ ...                  │
└──────────┬───────────┘
           │ 1
           │
           │ N
┌──────────▼───────────┐       ┌──────────────────────┐
│ PaymentCodeTransaction│       │ PaymentType (支付类型) │
├──────────────────────┤       ├──────────────────────┤
│ id (PK)              │       │ id (PK)              │
│ order_id (FK)        │◄──────│ identifier           │
│ order_payment_id(FK) │       │ label                │
│ payment_type         │       │ ...                  │
│ ...                  │       └──────────────────────┘
└──────────────────────┘
```

---

## 4. 后端开发

### 4.1 模型层

#### PaymentCodeTransaction 模型

**位置**: `app/Models/PaymentCodeTransaction.php`

**核心功能**：
- 与订单、支付、用户建立关联
- 提供作用域查询（alipay, wechat, success, failed）
- 访问器（支付类型文本、状态文本、脱敏付款码）

**使用示例**：
```php
// 创建交易记录
$transaction = PaymentCodeTransaction::create([
    'order_id' => $orderId,
    'payment_type' => 'alipay',
    'payment_code' => $encryptedCode,
    'amount' => 50.00,
    'author' => auth()->id(),
]);

// 查询成功的支付宝交易
$transactions = PaymentCodeTransaction::alipay()->success()->get();

// 获取脱敏付款码
echo $transaction->masked_payment_code; // **** **** **** 6789
```

### 4.2 服务层

#### PaymentCodeService

**位置**: `app/Services/PaymentCodeService.php`

**核心方法**：

```php
// 处理支付
public function processPayment(
    int $orderId,
    string $paymentType,
    string $paymentCode,
    float $amount,
    int $authorId
): array

// 验证付款码格式
public function validatePaymentCode(string $code, string $type): bool

// 创建交易记录
public function createTransaction(array $data): PaymentCodeTransaction

// 更新交易状态
public function updateTransactionStatus(
    int $transactionId,
    string $status,
    array $responseData = []
): bool

// 处理支付回调
public function handlePaymentCallback(string $type, array $data): bool
```

#### AlipayGateway

**位置**: `app/Services/Gateways/AlipayGateway.php`

**核心方法**：

```php
// 条码支付
public function pay(string $paymentCode, float $amount, int $orderId): array

// 查询订单
public function query(string $transactionId): array

// 申请退款
public function refund(string $transactionId, float $amount): array

// 验证回调签名
public function verifyCallback(array $data): bool

// 测试连接
public function testConnection(): array
```

**签名生成**：
- 使用 RSA2 签名算法 (SHA256WithRSAEncryption)
- 参数按字母顺序排序
- 签名结果 Base64 编码

#### WeChatGateway

**位置**: `app/Services/Gateways/WeChatGateway.php`

**核心方法**：

```php
// 付款码支付
public function pay(string $paymentCode, float $amount, int $orderId): array

// 查询订单
public function query(string $transactionId): array

// 申请退款
public function refund(string $transactionId, float $amount): array

// 验证回调签名
public function verifyCallback(array $data): bool

// 测试连接
public function testConnection(): array
```

**API v3 签名**：
- 使用商户私钥签名
- 签名算法：SHA256-RSA2048
- Authorization 头格式：`WECHATPAY2-SHA256-RSA2048`

### 4.3 控制器层

#### PaymentCodeController

**位置**: `app/Http/Controllers/Dashboard/PaymentCodeController.php`

**路由映射**：

```php
// 处理支付
POST /api/payment-codes/pay
→ PaymentCodeController@pay

// 测试连接
POST /api/payment-codes/config/test
→ PaymentCodeController@testConnection

// 获取配置
GET /api/payment-codes/config
→ PaymentCodeController@getConfig

// 获取交易记录
GET /api/payment-codes/transactions
→ PaymentCodeController@getTransactions

// 获取单个交易
GET /api/payment-codes/transactions/{id}
→ PaymentCodeController@getTransaction

// 支付宝回调
POST /api/payment-codes/notify/alipay
→ PaymentCodeController@handleAlipayCallback

// 微信回调
POST /api/payment-codes/notify/wechat
→ PaymentCodeController@handleWeChatCallback
```

### 4.4 配置管理

#### 配置文件

**位置**: `app/Settings/pos/payment-codes.php`

**配置项**：

**支付宝配置**：
- `ns_payment_alipay_enabled`: 是否启用
- `ns_payment_alipay_app_id`: 应用ID
- `ns_payment_alipay_private_key`: 应用私钥
- `ns_payment_alipay_public_key`: 支付宝公钥
- `ns_payment_alipay_gateway`: 网关地址

**微信配置**：
- `ns_payment_wechat_enabled`: 是否启用
- `ns_payment_wechat_mch_id`: 商户号
- `ns_payment_wechat_app_id`: 应用ID
- `ns_payment_wechat_apiv3_key`: API v3 密钥
- `ns_payment_wechat_cert_serial`: 证书序列号
- `ns_payment_wechat_cert_path`: 商户证书
- `ns_payment_wechat_key_path`: 商户密钥

---

## 5. 前端开发

### 5.1 支付组件架构

#### 组件继承结构

```
sample-payment.vue (基础组件)
├── alipay-payment.vue (支付宝)
└── wechat-payment.vue (微信)
```

#### 组件生命周期

```typescript
mounted() {
    // 1. 订阅订单数据
    this.orderSubscription = POS.order.subscribe(order => {
        this.order = order;
    });

    // 2. 自动聚焦输入框
    this.$refs.codeInput?.focus();

    // 3. 检查摄像头支持
    this.hasCamera = !!navigator.mediaDevices?.getUserMedia;
}
```

### 5.2 支付宝组件

**位置**: `resources/ts/pages/dashboard/pos/payments/alipay-payment.vue`

**核心功能**：

```typescript
// 数据属性
data() {
    return {
        paymentCode: '',      // 付款码
        processing: false,    // 处理中状态
        showScanner: false,    // 扫码器显示
        hasCamera: false,      // 摄像头支持
        errorMessage: '',     // 错误信息
        successMessage: '',   // 成功信息
    };
}

// 计算属性
computed: {
    isValidCode() {
        return /^\d{10,18}$/.test(this.paymentCode);
    },
    maskedCode() {
        // 格式化显示：1234 5678 9012 3456
        return this.paymentCode.replace(/(\d{4})(?=\d)/g, '$1 ');
    }
}

// 核心方法
async processPayment() {
    // 1. 验证付款码
    if (!this.isValidCode || this.processing) return;

    // 2. 发送支付请求
    const response = await nsHttpClient.post('/api/payment-codes/pay', {
        order_id: this.order.id,
        payment_type: 'alipay-payment',
        payment_code: this.paymentCode,
        amount: remainingAmount,
    });

    // 3. 处理响应
    if (response.status === 'success') {
        // 添加支付到订单
        POS.addPayment({ ... });
        // 提交订单
        this.$emit('submit');
    }
}
```

### 5.3 微信组件

**位置**: `resources/ts/pages/dashboard/pos/payments/wechat-payment.vue`

**功能与支付宝组件相同**，区别仅在于：
- `payment_type` 为 `wechat-payment`
- UI 样式（绿色主题）

### 5.4 状态管理

#### POS 对象状态

```typescript
// 订单状态
POS.order.subscribe(order => {
    console.log('订单总金额:', order.total);
    console.log('已支付:', order.tendered);
    console.log('找零:', order.change);
});

// 设置状态
POS.settings.subscribe(settings => {
    console.log('支付类型:', settings.types);
});
```

### 5.5 错误处理

```typescript
try {
    const response = await nsHttpClient.post('/api/payment-codes/pay', data);
} catch (error) {
    // 错误处理
    this.errorMessage = error.response?.data?.message ||
                        error.message ||
                        __('An error occurred');

    // 显示通知
    nsSnackBar.error(this.errorMessage);
}
```

---

## 6. API 接口文档

### 6.1 处理支付

**接口**: `POST /api/payment-codes/pay`

**权限**: `nexopos.make-orders`

**请求参数**：

```json
{
  "order_id": 123,
  "payment_type": "alipay-payment",
  "payment_code": "134567890123456789",
  "amount": 50.00
}
```

**响应示例**：

```json
// 成功
{
  "status": "success",
  "message": "支付成功",
  "transaction_id": 1,
  "gateway_transaction_id": "20260125220014..."
}

// 失败
{
  "status": "error",
  "message": "余额不足"
}
```

### 6.2 测试连接

**接口**: `POST /api/payment-codes/config/test`

**权限**: `nexopos.manage-settings`

**请求参数**：

```json
{
  "type": "alipay"
}
```

**响应示例**：

```json
// 成功
{
  "success": true,
  "message": "Connection test successful. Configuration is valid."
}

// 失败
{
  "success": false,
  "message": "App ID is missing"
}
```

### 6.3 获取配置

**接口**: `GET /api/payment-codes/config`

**权限**: `nexopos.manage-settings`

**响应示例**：

```json
{
  "status": "success",
  "data": {
    "alipay": {
      "enabled": false,
      "app_id": "2021001234567890",
      "has_config": true
    },
    "wechat": {
      "enabled": false,
      "mch_id": "1234567890",
      "has_config": true
    }
  }
}
```

### 6.4 获取交易记录

**接口**: `GET /api/payment-codes/transactions`

**权限**: `nexopos.manage-orders`

**查询参数**：

| 参数 | 类型 | 必填 | 说明 |
|-----|------|------|------|
| order_id | int | 否 | 筛选订单ID |
| payment_type | string | 否 | 筛选支付类型 (alipay/wechat) |
| status | string | 否 | 筛选状态 (success/failed) |
| per_page | int | 否 | 每页数量，默认15 |

**响应示例**：

```json
{
  "status": "success",
  "data": {
    "current_page": 1,
    "data": [
      {
        "id": 1,
        "order_id": 123,
        "payment_type": "alipay",
        "amount": "50.00000",
        "status": "success",
        "transaction_id": "20260125220014...",
        "created_at": "2026-01-25 19:33:00",
        "order": { ... },
        "author": { ... }
      }
    ],
    "per_page": 15,
    "total": 100
  }
}
```

### 6.5 支付回调

**支付宝回调**: `POST /api/payment-codes/notify/alipay`

**微信回调**: `POST /api/payment-codes/notify/wechat`

**权限**: 无（公开接口）

**响应**：
- 成功: `success`
- 失败: `fail` (HTTP 400)

---

## 7. 配置说明

### 7.1 支付宝配置

#### 获取参数

1. **应用ID (App ID)**
   - 登录支付宝开放平台：https://open.alipay.com
   - 进入"应用详情" → "应用信息"
   - 复制 APPID

2. **应用私钥**
   ```bash
   # 生成 RSA2 私钥
   openssl genrsa -out app_private_key.pem 2048

   # 转换为 PKCS#8 格式
   openssl rsa -in app_private_key.pem -pubout -out app_public_key.pem

   # 查看私钥（去除头尾和换行）
   cat app_private_key.pem | grep -v 'BEGIN' | grep -v 'END' | tr -d '\n'
   ```

3. **支付宝公钥**
   - 上传应用公钥到支付宝
   - 下载支付宝公钥
   - 复制内容到配置

#### 配置示例

```env
# 正式环境
ns_payment_alipay_gateway=https://openapi.alipay.com/gateway.do

# 沙箱环境（测试用）
ns_payment_alipay_gateway=https://openapi.alisdk.com/gateway.do
```

### 7.2 微信支付配置

#### 获取参数

1. **商户号 (Mch ID)**
   - 登录微信支付商户平台：https://pay.weixin.qq.com
   - 进入"账户中心" → "商户信息"
   - 复制商户号

2. **应用ID (App ID)**
   - 微信公众平台：https://mp.weixin.qq.com
   - 开发 → 开发者ID

3. **API v3 密钥**
   - 商户平台 → 账户中心 → API安全 → API v3 密钥
   - 设置32位字符串

4. **商户证书**
   ```bash
   # 下载证书（apiclient_cert.pem, apiclient_key.pem）
   # 商户平台 → 账户中心 → API安全 → 申请商户证书
   ```

5. **证书序列号**
   - 商户平台 → 账户中心 → API安全 → 查看证书序列号

#### 配置示例

```
API v3 密钥: 32位随机字符串（例如：abc123...xyz）
证书序列号: 从证书文件获取
商户证书: 复制 apiclient_cert.pem 内容
商户密钥: 复制 apiclient_key.pem 内容
```

---

## 8. 开发指南

### 8.1 本地开发设置

#### 1. 运行迁移

```bash
php artisan migrate
php artisan db:seed --class=PaymentCodePaymentTypesSeeder
```

#### 2. 清除缓存

```bash
php artisan config:clear
php artisan cache:clear
php artisan route:clear
```

#### 3. 启动开发服务器

```bash
# 终端 1
php artisan serve

# 终端 2
npm run dev
```

### 8.2 调试技巧

#### 后端调试

```php
// 使用 Laravel 日志
use Illuminate\Support\Facades\Log;

Log::info('Payment processing', [
    'order_id' => $orderId,
    'amount' => $amount
]);

// 使用 dump() 调试
dump($transaction->toArray());

// 使用 dd() 立即停止
dd($result);
```

#### 前端调试

```typescript
// 控制台输出
console.log('Payment code:', this.paymentCode);

// 显示通知
nsSnackBar.success('Payment successful');
nsSnackBar.error('Payment failed');

// 显示弹窗
Popup.show(nsPosConfirmPopupVue, {
    title: __('Confirm Payment'),
    message: __('Amount: ') + nsCurrency(this.order.total)
});
```

### 8.3 代码规范

#### PHP 代码风格

- 遵循 PSR-12 标准
- 使用 Laravel Pint 格式化：`./vendor/bin/pint`
- 类名使用 PascalCase
- 方法名使用 camelCase
- 常量全大写下划线分隔

#### TypeScript 代码风格

- 使用 TypeScript 接口
- 组件使用 PascalCase
- 变量使用 camelCase
- 常量全大写下划线分隔
- 使用 ESLint 检查

---

## 9. 安全说明

### 9.1 数据加密

#### 付款码加密

```php
// 加密存储
$encrypted = encrypt($paymentCode);

// 解密读取
$decrypted = decrypt($encrypted);
```

#### 密钥保护

- 私钥存储在配置表中（加密）
- 使用 Laravel 的加密服务
- 生产环境使用 HTTPS

### 9.2 签名验证

#### 支付宝签名验证

```php
// 1. 构建待签名字符串
$stringToBeSigned = http_build_query($sortedParams);

// 2. 使用公钥验证
$publicKey = "-----BEGIN PUBLIC KEY-----\n" .
    wordwrap($this->publicKey, 64, "\n", true) .
    "\n-----END PUBLIC KEY-----";

$result = openssl_verify(
    $stringToBeSigned,
    base64_decode($sign),
    $publicKey,
    OPENSSL_ALGO_SHA256
);
```

#### 微信签名验证

```php
// 1. 构建签名字符串
$message = $timestamp . "\n" . $nonce . "\n" . $body . "\n";

// 2. 使用平台公钥验证
$result = openssl_verify(
    $message,
    base64_decode($signature),
    $platformPublicKey,
    'sha256WithRSAEncryption'
);
```

### 9.3 回调安全

#### 防重放攻击

```php
// 检查订单状态
if ($transaction->status !== 'pending') {
    return response('Transaction already processed');
}

// 验证时间戳
$callbackTime = $data['timestamp'] ?? 0;
if (time() - $callbackTime > 300) { // 5分钟
    return response('Request expired', 400);
}
```

#### 防伪造请求

```php
// 验证签名
if (!$this->verifyCallback($data)) {
    Log::warning('Invalid signature', $data);
    return response('fail', 400);
}
```

---

## 10. 故障排查

### 10.1 常见问题

#### 问题 1: 迁移不执行

**症状**：运行 `php artisan migrate` 无响应

**原因**：
- 迁移文件命名格式错误
- 迁移已运行
- 路由文件路径错误

**解决方案**：
```bash
# 检查迁移状态
php artisan migrate:status

# 强制运行特定迁移
php artisan migrate: --path=database/migrations/create/2025_01_25_000000_create_payment_code_transactions_table.php

# 回滚后重新运行
php artisan migrate:rollback --step=1
php artisan migrate
```

#### 问题 2: 路由 404

**症状**：访问 API 返回 404

**原因**：
- 路由缓存未清除
- 路由文件路径错误

**解决方案**：
```bash
# 清除路由缓存
php artisan route:clear
php artisan config:clear

# 检查路由是否注册
php artisan route:list --path=payment-codes
```

#### 问题 3: 支付失败

**症状**：支付请求返回错误

**原因**：
- 配置参数错误
- 网络问题
- 付款码无效

**解决方案**：
```php
// 1. 检查配置
dd([
    'app_id' => ns()->option->get('ns_payment_alipay_app_id'),
    'gateway' => ns()->option->get('ns_payment_alipay_gateway')
]);

// 2. 测试连接
$result = $gateway->testConnection();
dd($result);

// 3. 查看日志
tail -f storage/logs/laravel.log
```

#### 问题 4: 前端无法加载

**症状**：支付组件不显示

**原因**：
- 支付类型未激活
- 前端路由未注册

**解决方案**：
```bash
# 1. 检查支付类型
php artisan tinker --execute='use App\Models\PaymentType; PaymentType::where("identifier", "alipay-payment")->update(["active" => true]);'

# 2. 清除配置缓存
php artisan config:clear

# 3. 重新编译前端
npm run build
```

### 10.2 日志查看

```bash
# Laravel 日志
tail -f storage/logs/laravel.log

# PHP 错误日志
tail -f storage/logs/laravel.log | grep ERROR

# 查询最近的支付记录
php artisan tinker --execute='use App\Models\PaymentCodeTransaction; PaymentCodeTransaction::latest()->limit(10)->get()->toArray();'
```

### 10.3 调试模式

#### 开启调试模式

```env
# .env
APP_DEBUG=true
APP_LOG_LEVEL=debug
```

#### SQL 查询日志

```php
// DatabaseSeeder 中启用
DB::listen(function ($query) {
    logger($query->sql);
    logger($query->bindings);
});
```

---

## 附录

### A. 错误代码对照表

#### 支付宝错误码

| 错误码 | 说明 | 处理建议 |
|-------|------|---------|
| ACQ.INVALID_PARAMETER | 参数无效 | 检查请求参数格式 |
| ACQ.SYSTEM_ERROR | 系统错误 | 重试或联系技术支持 |
| ACQ.PAYMENT_AUTH_CODE_INVALID | 付款码无效 | 提示用户刷新付款码 |
| ACQ.BALANCE_NOT_ENOUGH | 余额不足 | 提示用户充值或更换支付方式 |
| ACQ.PAYMENT_CODE_EXPIRED | 付款码过期 | 提示用户刷新付款码 |

#### 微信支付错误码

| 错误码 | 说明 | 处理建议 |
|-------|------|---------|
| PARAM_ERROR | 参数错误 | 检查请求参数格式 |
| SYSTEMERROR | 系统错误 | 重试或联系技术支持 |
| PAYMENT_AUTH_CODE_INVALID | 付款码无效 | 提示用户刷新付款码 |
| NOT_ENOUGH | 余额不足 | 提示用户充值或更换支付方式 |
| AUTHCODEEXPIRE | 付款码过期 | 提示用户刷新付款码 |
| USER_ACCOUNT_ABSENT | 账号异常 | 提示用户检查微信账户 |

### B. 相关文档链接

- [支付宝开放平台文档](https://opendocs.alipay.com)
- [支付宝条码支付文档](https://opendocs.alipay.com/open/028r8t)
- [微信支付开发文档](https://pay.weixin.qq.com/wiki/doc/api/index.html)
- [微信支付付款码文档](https://pay.weixin.qq.com/wiki/doc/api/down.html)
- [NexoPOS 官方文档](https://my.nexopos.com/en/documentation)

---

**文档版本**: v1.0
**最后更新**: 2026-01-25
**维护者**: 开发团队
