# ä»˜æ¬¾ç å®ç°æ£€æŸ¥æŠ¥å‘Š

## ğŸ“Š æ£€æŸ¥æ—¥æœŸ
2025-01-25

## âœ… æ£€æŸ¥ç»“æœæ€»ç»“

### æ”¯ä»˜å®å½“é¢ä»˜ - âœ… ç¬¦åˆè¦æ±‚
- **æ¥å£**: `alipay.trade.pay`ï¼ˆå½“é¢ä»˜ - æ¡ç æ”¯ä»˜ï¼‰
- **æ–‡æ¡£**: [æ”¯ä»˜å®å½“é¢ä»˜](https://opendocs.alipay.com/open/02e7qg)
- **ç­¾åæ–¹å¼**: RSA2ï¼ˆSHA256WithRSAEncryptionï¼‰
- **å‚æ•°æ ¼å¼**: JSONï¼ˆapplication/x-www-form-urlencodedï¼‰
- **çŠ¶æ€**: âœ… å®Œå…¨ç¬¦åˆå®˜æ–¹è¦æ±‚

### å¾®ä¿¡æ”¯ä»˜ä»˜æ¬¾ç  - âœ… å·²ä¿®æ­£ä¸ºç¬¦åˆè¦æ±‚
- **æ¥å£**: `/pay/micropay`ï¼ˆä»˜æ¬¾ç æ”¯ä»˜/Micropayï¼‰
- **æ–‡æ¡£**: [å¾®ä¿¡ä»˜æ¬¾ç æ”¯ä»˜ï¼ˆV2ï¼‰](https://pay.weixin.qq.com/doc/v2/merchant/4011937125)
- **ç­¾åæ–¹å¼**: MD5
- **å‚æ•°æ ¼å¼**: XML
- **API ç‰ˆæœ¬**: V2ï¼ˆä¸æ˜¯ V3ï¼‰
- **çŠ¶æ€**: âœ… å·²ä¿®æ”¹ä¸ºç¬¦åˆ V2 å®˜æ–¹è¦æ±‚

---

## ğŸ“‹ è¯¦ç»†æ£€æŸ¥

### 1. æ”¯ä»˜å®å½“é¢ä»˜ï¼ˆalipay.trade.payï¼‰

#### âœ… æ­£ç¡®å®ç°

**è¯·æ±‚æ–¹æ³•**: POST
**è¯·æ±‚åœ°å€**: `https://openapi.alipay.com/gateway.do`

**è¯·æ±‚å‚æ•°**:
```php
$params = [
    'app_id' => $appId,
    'method' => 'alipay.trade.pay',  // âœ… æ­£ç¡®çš„æ¥å£æ–¹æ³•
    'charset' => 'UTF-8',
    'sign_type' => 'RSA2',           // âœ… RSA2 ç­¾å
    'timestamp' => date('Y-m-d H:i:s'),
    'version' => '1.0',
    'biz_content' => json_encode([
        'out_trade_no' => 'ORDER-' . $orderId . '-' . time(),
        'total_amount' => number_format($amount, 2, '.', ''),
        'scene' => 'bar_code',        // âœ… æ¡ç æ”¯ä»˜åœºæ™¯
        'auth_code' => $paymentCode,  // âœ… ä»˜æ¬¾ç 
    ], JSON_UNESCAPED_UNICODE),
];
```

**ç­¾åç”Ÿæˆ**:
- âœ… å‚æ•°æŒ‰å­—æ¯é¡ºåºæ’åº
- âœ… ä½¿ç”¨ RSA2ï¼ˆSHA256WithRSAEncryptionï¼‰
- âœ… Base64 ç¼–ç ç­¾åç»“æœ
- âœ… ç¬¦åˆ [æ”¯ä»˜å®ç­¾åéªŒè¯](https://opendocs.alipay.com/open/291/106074) è§„èŒƒ

**å“åº”å¤„ç†**:
- âœ… æ­£ç¡®è§£æ `alipay_trade_pay_response`
- âœ… æ£€æŸ¥ `code === '10000'` è¡¨ç¤ºæˆåŠŸ
- âœ… æå– `trade_no` ä½œä¸ºäº¤æ˜“å·

---

### 2. å¾®ä¿¡æ”¯ä»˜ä»˜æ¬¾ç ï¼ˆMicropay - V2ï¼‰

#### âœ… å·²ä¿®æ­£ä¸º V2 å®ç°

**ä¿®æ”¹å‰é—®é¢˜**:
- âŒ ä½¿ç”¨ V3 APIï¼ˆ`/v3/pay/transactions/codepay`ï¼‰
- âŒ ä½¿ç”¨ V3 ç­¾åæ–¹å¼ï¼ˆSHA256-RSA2048ï¼‰
- âŒ è¯·æ±‚æ ¼å¼ä¸º JSON

**ä¿®æ”¹å**:
- âœ… ä½¿ç”¨ V2 APIï¼ˆ`/pay/micropay`ï¼‰
- âœ… ä½¿ç”¨ MD5 ç­¾å
- âœ… è¯·æ±‚æ ¼å¼ä¸º XML

**è¯·æ±‚æ–¹æ³•**: POST
**è¯·æ±‚åœ°å€**: `https://api.mch.weixin.qq.com/pay/micropay`

**è¯·æ±‚å‚æ•°**ï¼ˆXML æ ¼å¼ï¼‰:
```php
$params = [
    'appid' => $appId,
    'mch_id' => $mchId,
    'nonce_str' => md5(uniqid(mt_rand(), true)),
    'body' => 'è®¢å•å· #' . $orderId,
    'out_trade_no' => 'ORDER-' . $orderId . '-' . time(),
    'total_fee' => intval($amount * 100), // âœ… è½¬æ¢ä¸ºåˆ†
    'spbill_create_ip' => request()->ip(),
    'auth_code' => $paymentCode, // âœ… 18ä½ä»˜æ¬¾ç 
];
```

**ç­¾åç”Ÿæˆ**ï¼ˆMD5ï¼‰:
```php
protected function generateMd5Sign(array $params): string
{
    // 1. è¿‡æ»¤ç©ºå€¼
    $params = array_filter($params, function($value) {
        return $value !== '' && $value !== null;
    });

    // 2. æŒ‰å­—æ¯é¡ºåºæ’åº
    ksort($params);

    // 3. æ‹¼æ¥æˆå­—ç¬¦ä¸²
    $stringToBeSigned = http_build_query($params, '', '&');

    // 4. åœ¨å­—ç¬¦ä¸²æœ«å°¾æ‹¼æ¥ key
    $stringToBeSigned .= '&key=' . $this->apiKey;

    // 5. MD5 åŠ å¯†å¹¶è½¬ä¸ºå¤§å†™
    return strtoupper(md5($stringToBeSigned));
}
```

**XML è½¬æ¢**:
```php
protected function arrayToXml(array $arr): string
{
    $xml = '<xml>';
    foreach ($arr as $key => $val) {
        if (is_numeric($val)) {
            $xml .= "<{$key}>{$val}</{$key}>";
        } else {
            $xml .= "<{$key}><![CDATA[{$val}]]></{$key}>";
        }
    }
    $xml .= '</xml>';
    return $xml;
}
```

**å“åº”å¤„ç†**:
```php
if ($result['return_code'] === 'SUCCESS') {
    if ($result['result_code'] === 'SUCCESS') {
        return [
            'success' => true,
            'transaction_id' => $result['transaction_id'],
            'message' => 'Payment successful',
        ];
    } else {
        $errorCode = $result['err_code'];
        $errorMsg = $result['err_code_des'];
        // é”™è¯¯å¤„ç†
    }
}
```

---

## ğŸ”§ ä¿®æ”¹å†…å®¹

### 1. WeChatGateway.php
**æ–‡ä»¶**: `app/Services/Gateways/WeChatGateway.php`

**ä¸»è¦ä¿®æ”¹**:
- âœ… API URL ä» V3 æ”¹ä¸º V2ï¼ˆ`https://api.mch.weixin.qq.com`ï¼‰
- âœ… æ¥å£è·¯å¾„ä» `/v3/pay/transactions/codepay` æ”¹ä¸º `/pay/micropay`
- âœ… ç­¾åæ–¹å¼ä» SHA256-RSA2048 æ”¹ä¸º MD5
- âœ… è¯·æ±‚æ ¼å¼ä» JSON æ”¹ä¸º XML
- âœ… å“åº”æ ¼å¼ä» JSON æ”¹ä¸º XML
- âœ… æ·»åŠ  `generateMd5Sign()` æ–¹æ³•
- âœ… æ·»åŠ  `arrayToXml()` æ–¹æ³•
- âœ… æ·»åŠ  `xmlToArray()` æ–¹æ³•
- âœ… ç§»é™¤ V3 ç›¸å…³çš„è¯ä¹¦é…ç½®

### 2. å¾®ä¿¡é…ç½®é¡µé¢
**æ–‡ä»¶**: `app/Settings/pos/payment-codes/wechat.php`

**ç§»é™¤çš„å­—æ®µ**ï¼ˆV3 ä¸“ç”¨ï¼‰:
- âŒ WeChat API v3 Key
- âŒ WeChat Certificate Serial Number
- âŒ WeChat Merchant Certificate
- âŒ WeChat Merchant Private Key

**ä¿ç•™çš„å­—æ®µ**ï¼ˆV2 å¿…éœ€ï¼‰:
- âœ… Enable WeChat Payment Codeï¼ˆå¯ç”¨å¾®ä¿¡ä»˜æ¬¾ç ï¼‰
- âœ… WeChat Merchant IDï¼ˆå•†æˆ·å·ï¼‰
- âœ… WeChat App IDï¼ˆåº”ç”¨ IDï¼‰
- âœ… WeChat API Key (v2)ï¼ˆAPI å¯†é’¥ï¼Œç”¨äº MD5 ç­¾åï¼‰

---

## ğŸ“Œ é…ç½®è¯´æ˜

### æ”¯ä»˜å®å½“é¢ä»˜é…ç½®
| é…ç½®é¡¹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|
| App ID | æ”¯ä»˜å®åº”ç”¨ ID | 2021001234567890 |
| Private Key | åº”ç”¨ç§é’¥ï¼ˆRSA2ï¼‰ | MIIEvQIBADANBgkqhkiG9w... |
| Public Key | æ”¯ä»˜å®å…¬é’¥ | MIIBIjANBgkqhkiG9w0B... |
| Gateway URL | ç½‘å…³åœ°å€ | https://openapi.alipay.com/gateway.do |

**æµ‹è¯•ç¯å¢ƒ**: `https://openapi.alisdk.com/gateway.do`

### å¾®ä¿¡æ”¯ä»˜ä»˜æ¬¾ç é…ç½®ï¼ˆV2ï¼‰
| é…ç½®é¡¹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|
| Merchant ID | å¾®ä¿¡å•†æˆ·å· | 1234567890 |
| App ID | å¾®ä¿¡åº”ç”¨ ID | wx1234567890abcdef |
| API Key (v2) | API å¯†é’¥ï¼ˆ32å­—ç¬¦ï¼‰ | 192006250b4c09247ec02edce69f6a2d |

**é‡è¦**: API Key (v2) æ˜¯åœ¨å¾®ä¿¡å•†æˆ·å¹³å°ä¸­è®¾ç½®çš„ 32 ä½å¯†é’¥ï¼Œç”¨äº MD5 ç­¾åã€‚

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### æ”¯ä»˜å®æµ‹è¯•
1. ä½¿ç”¨æ”¯ä»˜å®æ²™ç®±ç¯å¢ƒ
2. è·å–æ²™ç®±åº”ç”¨ ID å’Œå¯†é’¥
3. ä½¿ç”¨æ”¯ä»˜å®æä¾›çš„æµ‹è¯•ä»˜æ¬¾ç 

### å¾®ä¿¡æ”¯ä»˜æµ‹è¯•
1. ä½¿ç”¨å¾®ä¿¡æ”¯ä»˜å•†æˆ·å·
2. ç¡®ä¿å•†æˆ·å·å·²å¼€é€šä»˜æ¬¾ç æ”¯ä»˜åŠŸèƒ½
3. ä½¿ç”¨çœŸå®çš„å¾®ä¿¡ä»˜æ¬¾ç ï¼ˆ18ä½æ•°å­—ï¼‰è¿›è¡Œæµ‹è¯•
4. æ³¨æ„ï¼šå¾®ä¿¡æ”¯ä»˜æ²¡æœ‰å…¬å¼€çš„æ²™ç®±ç¯å¢ƒï¼Œéœ€è¦ä½¿ç”¨çœŸå®å•†æˆ·å·

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

### æ”¯ä»˜å®
- [å½“é¢ä»˜äº§å“æ–‡æ¡£](https://opendocs.alipay.com/open/02e7qg)
- [æ”¯ä»˜å®ç­¾åéªŒè¯](https://opendocs.alipay.com/open/291/106074)
- [alipay.trade.pay æ¥å£](https://opendocs.alipay.com/api/alipay.trade.pay)

### å¾®ä¿¡æ”¯ä»˜
- [ä»˜æ¬¾ç æ”¯ä»˜ï¼ˆV2ï¼‰](https://pay.weixin.qq.com/doc/v2/merchant/4011937125)
- [å¾®ä¿¡æ”¯ä»˜å®‰å…¨è§„èŒƒ](https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay6_0.shtml)
- [æ¥å£è§„åˆ™](https://pay.weixin.qq.com/wiki/doc/api/micropay.php?chapter=4_3)

---

## âœ… éªŒè¯æ¸…å•

- [x] æ”¯ä»˜å®ä½¿ç”¨ `alipay.trade.pay` æ¥å£
- [x] æ”¯ä»˜å®ä½¿ç”¨ RSA2 ç­¾å
- [x] å¾®ä¿¡æ”¯ä»˜ä½¿ç”¨ V2 `/pay/micropay` æ¥å£
- [x] å¾®ä¿¡æ”¯ä»˜ä½¿ç”¨ MD5 ç­¾å
- [x] å¾®ä¿¡æ”¯ä»˜ä½¿ç”¨ XML æ ¼å¼
- [x] ç§»é™¤äº†å¾®ä¿¡ V3 ç›¸å…³é…ç½®
- [x] æ›´æ–°äº†é…ç½®é¡µé¢
- [x] æ›´æ–°äº†è¯­è¨€æ–‡ä»¶
- [x] æ¸…é™¤äº†åº”ç”¨ç¼“å­˜

---

## ğŸ¯ æ€»ç»“

### ç¬¦åˆè¦æ±‚çš„éƒ¨åˆ†
1. âœ… æ”¯ä»˜å®å½“é¢ä»˜æ¥å£å®Œå…¨ç¬¦åˆå®˜æ–¹è§„èŒƒ
2. âœ… å¾®ä¿¡æ”¯ä»˜å·²ä¿®æ”¹ä¸º V2 Micropay API
3. âœ… ç­¾åæ–¹å¼ç¬¦åˆå®˜æ–¹è¦æ±‚ï¼ˆRSA2 å’Œ MD5ï¼‰
4. âœ… å‚æ•°æ ¼å¼ç¬¦åˆå®˜æ–¹è¦æ±‚ï¼ˆJSON å’Œ XMLï¼‰

### ä¸å†éœ€è¦çš„éƒ¨åˆ†ï¼ˆå·²ç§»é™¤ï¼‰
1. âŒ å¾®ä¿¡æ”¯ä»˜ V3 APIï¼ˆcodepayï¼‰
2. âŒ å¾®ä¿¡æ”¯ä»˜ V3 ç­¾åï¼ˆSHA256-RSA2048ï¼‰
3. âŒ å¾®ä¿¡æ”¯ä»˜è¯ä¹¦é…ç½®ï¼ˆV3 éœ€è¦ï¼ŒV2 ä¸éœ€è¦ï¼‰

### å½“å‰çŠ¶æ€
**æ‰€æœ‰å®ç°ç°å·²ç¬¦åˆå¾®ä¿¡æ”¯ä»˜ V2 å’Œæ”¯ä»˜å®å½“é¢ä»˜çš„å®˜æ–¹è§„èŒƒã€‚**
