# NexoPOS 付款码支付功能需求文档

## 文档信息

| 项目 | 信息 |
|-----|------|
| 文档名称 | 付款码支付功能需求文档 |
| 文档版本 | v1.0 |
| 创建日期 | 2026-01-25 |
| 项目名称 | NexoPOS 付款码支付集成 |
| 文档状态 | 需求分析 |

---

## 目录

1. [需求概述](#1-需求概述)
2. [现有系统分析](#2-现有系统分析)
3. [功能需求](#3-功能需求)
4. [数据库设计](#4-数据库设计)
5. [前端设计](#5-前端设计)
6. [后端设计](#6-后端设计)
7. [安全要求](#7-安全要求)
8. [使用流程](#8-使用流程)
9. [测试要求](#9-测试要求)
10. [部署说明](#10-部署说明)

---

## 1. 需求概述

### 1.1 项目背景

NexoPOS 是一个现代化的点对点销售系统，目前支持现金、银行卡、信用卡和账户余额支付。为了满足中国市场的支付习惯，需要集成支付宝和微信支付的付款码功能。

### 1.2 项目目标

实现支付宝和微信付款码的自动识别和支付功能，使商户能够通过扫描顾客出示的付款码快速完成收款。

### 1.3 核心功能

- 支持支付宝付款码扫描支付
- 支持微信付款码扫描支付
- 后台配置管理界面
- 支付配置测试功能
- 完整的交易日志记录
- 报表系统集成

### 1.4 目标用户

- 商户收银员
- 系统管理员
- 顾客（使用支付宝/微信付款）

---

## 2. 现有系统分析

### 2.1 现有支付方式

NexoPOS 目前支持以下支付方式：

| 支付方式 | 标识符 | 说明 |
|---------|--------|------|
| 现金支付 | `cash-payment` | 基础现金支付，支持找零 |
| 银行卡支付 | `bank-payment` | 银行转账支付 |
| 信用卡支付 | `creditcard-payment` | 信用卡刷卡支付 |
| 账户支付 | `account-payment` | 客户账户余额支付 |

### 2.2 现有数据库表结构

#### 支付类型表 (nexopos_payments_types)

| 字段名 | 类型 | 说明 |
|-------|------|------|
| id | bigint(20) | 主键 |
| label | varchar(255) | 显示标签 |
| identifier | varchar(255) | 唯一标识符 |
| priority | int(11) | 显示优先级 |
| description | text | 描述 |
| author | int(11) | 创建者ID |
| active | boolean | 是否启用 |
| readonly | boolean | 是否只读 |
| created_at | timestamp | 创建时间 |
| updated_at | timestamp | 更新时间 |

#### 订单支付表 (nexopos_orders_payments)

| 字段名 | 类型 | 说明 |
|-------|------|------|
| id | bigint(20) | 主键 |
| order_id | int(11) | 订单ID |
| value | decimal(18,5) | 支付金额 |
| author | int(11) | 操作者ID |
| identifier | varchar(255) | 支付类型标识符 |
| uuid | varchar(255) | 唯一标识符 |
| created_at | timestamp | 创建时间 |
| updated_at | timestamp | 更新时间 |

#### 系统设置表 (nexopos_options)

| 字段名 | 类型 | 说明 |
|-------|------|------|
| id | int(10) | 主键 |
| user_id | int(11) | 用户ID |
| key | varchar(255) | 设置键 |
| value | text | 设置值 |
| array | boolean | 是否为数组 |
| created_at | timestamp | 创建时间 |
| updated_at | timestamp | 更新时间 |

### 2.3 现有前端组件

#### 支付组件位置
- 基础组件：`resources/ts/pages/dashboard/pos/payments/sample-payment.vue`
- 现金支付：`resources/ts/pages/dashboard/pos/payments/cash-payment.vue`
- 信用卡支付：`resources/ts/pages/dashboard/pos/payments/creditcard-payment.vue`
- 银行支付：`resources/ts/pages/dashboard/pos/payments/bank-payment.vue`
- 账户支付：`resources/ts/pages/dashboard/pos/payments/account-payment.vue`

#### 支付流程组件
- 支付弹窗：`resources/ts/popups/ns-pos-payment-popup.vue`
- 支付队列：`resources/ts/pages/dashboard/pos/queues/order/payment-queue.ts`

### 2.4 现有后端服务

- 订单服务：`app/Services/OrdersService.php`
- 支付类型模型：`app/Models/PaymentType.php`
- 订单支付模型：`app/Models/OrderPayment.php`
- 配置管理：`app/Services/Options.php`

### 2.5 现有报表系统

- 支付类型报表：`resources/ts/pages/dashboard/reports/ns-payment-types-report.vue`
- 报表接口：`POST /api/reports/payment-types`

---

## 3. 功能需求

### 3.1 功能模块划分

#### 3.1.1 支付配置管理模块

**功能描述**：
在后台设置页面添加"付款码设置"页签，用于配置支付宝和微信支付的参数。

**主要功能**：

1. **启用/禁用控制**
   - 启用/禁用支付宝付款码
   - 启用/禁用微信付款码
   - 独立开关控制

2. **支付宝配置**
   - 应用ID (App ID)
   - 应用私钥文件上传
   - 支付宝公钥文件上传
   - 网关地址（可选，支持沙箱环境切换）

3. **微信配置**
   - 商户号 (Mch ID)
   - 应用密钥 (App Secret)
   - API 密钥 (API Key)
   - 商户证书序列号
   - 商户证书文件上传（apiclient_cert.pem）
   - 商户密钥文件上传（apiclient_key.pem）

4. **配置验证**
   - 测试支付宝连接功能
   - 测试微信连接功能
   - 显示验证结果（成功/失败+详细错误信息）

#### 3.1.2 付款码识别模块

**功能描述**：
在 POS 页面集成付款码扫描功能，支持扫描枪和摄像头两种方式。

**主要功能**：

1. **扫描枪支持**
   - 条形码输入框自动识别付款码格式
   - 支付宝付款码识别（以 10-18 位数字开头）
   - 微信付款码识别（以 10-18 位数字开头）

2. **摄像头扫描**（可选功能）
   - 调用设备摄像头
   - 实时识别二维码
   - 自动定位和解析付款码

3. **手动输入**
   - 支持手动输入付款码
   - 格式验证

#### 3.1.3 支付处理模块

**功能描述**：
后端处理付款码支付请求，对接支付宝和微信官方 SDK。

**主要功能**：

1. **支付宝支付**
   - 使用支付宝官方 SDK
   - 调用条码支付接口 (alipay.trade.pay)
   - 处理支付结果
   - 异步通知处理

2. **微信支付**
   - 使用微信官方 SDK
   - 调用付款码支付接口
   - 处理支付结果
   - 异步通知处理

3. **支付流程控制**
   - 金额验证
   - 支付码重复使用检查
   - 支付失败重试机制
   - 超时处理

#### 3.1.4 交易记录模块

**功能描述**：
完整记录每笔付款码交易，便于对账和问题排查。

**主要功能**：

1. **交易日志**
   - 交易流水号
   - 支付方式（支付宝/微信）
   - 付款码（脱敏存储）
   - 交易金额
   - 交易状态
   - 交易时间
   - 第三方交易号
   - 错误信息（如失败）

2. **日志查询**
   - 按日期范围查询
   - 按支付方式查询
   - 按订单号查询
   - 导出功能

#### 3.1.5 报表集成模块

**功能描述**：
将付款码支付数据集成到现有报表系统。

**主要功能**：

1. **支付类型报表**
   - 支付宝支付统计
   - 微信支付统计
   - 按日期、门店、收银员分组

2. **对账报表**
   - 交易明细
   - 成功率统计
   - 退款统计

### 3.2 用户角色与权限

| 角色 | 权限 |
|-----|------|
| 系统管理员 | 配置付款码参数、查看所有交易记录 |
| 店长 | 查看本店交易记录、导出报表 |
| 收银员 | 使用付款码收款、查看本人交易记录 |
| 财务人员 | 查看和导出所有交易报表 |

### 3.3 非功能性需求

#### 3.3.1 性能要求

- 支付请求响应时间 < 3 秒
- 支持 50+ 并发支付请求
- 摄像头扫码识别时间 < 2 秒

#### 3.3.2 可用性要求

- 支付成功率 > 99%
- 系统可用性 > 99.5%
- 支持断网重试机制

#### 3.3.3 兼容性要求

- 支持支付宝官方 SDK 最新版本
- 支持微信支付官方 SDK 最新版本
- 兼容主流扫码枪设备
- 兼容主流浏览器（Chrome、Edge、Firefox）

---

## 4. 数据库设计

### 4.1 新增数据表

#### 付款码交易记录表 (nexopos_payment_code_transactions)

| 字段名 | 类型 | 是否必填 | 默认值 | 说明 |
|-------|------|---------|-------|------|
| id | bigint(20) UNSIGNED | 是 | AUTO_INCREMENT | 主键 |
| order_id | int(11) | 是 | - | 关联订单ID |
| order_payment_id | bigint(20) | 是 | - | 关联订单支付ID |
| payment_type | varchar(50) | 是 | - | 支付类型 (alipay/wechat) |
| payment_code | varchar(255) | 是 | - | 付款码（加密存储） |
| transaction_id | varchar(255) | 否 | NULL | 第三方交易号 |
| amount | decimal(18,5) | 是 | - | 交易金额 |
| status | varchar(50) | 是 | pending | 交易状态 |
| response_data | text | 否 | NULL | 支付响应数据（JSON） |
| error_message | text | 否 | NULL | 错误信息 |
| author | int(11) | 是 | - | 操作员ID |
| created_at | timestamp | 是 | CURRENT_TIMESTAMP | 交易时间 |
| updated_at | timestamp | 是 | CURRENT_TIMESTAMP | 更新时间 |

**索引设计**：
- 主键索引：`id`
- 订单索引：`order_id`
- 支付类型索引：`payment_type`
- 交易时间索引：`created_at`
- 唯一索引：`transaction_id`

**交易状态枚举**：
- `pending`: 处理中
- `success`: 成功
- `failed`: 失败
- `refunded`: 已退款
- `cancelled`: 已取消

### 4.2 扩展现有表

#### 支付类型表扩展

需要在 `nexopos_payments_types` 表中新增两条记录：

| label | identifier | priority | active |
|-------|-----------|----------|--------|
| 支付宝 | `alipay-payment` | 5 | true |
| 微信支付 | `wechat-payment` | 6 | true |

#### 订单支付表扩展

`nexopos_orders_payments` 表无需修改，通过 `identifier` 字段关联新的支付类型。

### 4.3 配置存储设计

使用现有的 `nexopos_options` 表存储付款码配置：

| 配置键 | 说明 | 数据类型 |
|-------|------|---------|
| ns_payment_alipay_enabled | 是否启用支付宝 | boolean |
| ns_payment_alipay_app_id | 支付宝应用ID | string |
| ns_payment_alipay_private_key | 支付宝应用私钥 | encrypted string |
| ns_payment_alipay_public_key | 支付宝公钥 | string |
| ns_payment_alipay_gateway | 支付宝网关地址 | string |
| ns_payment_wechat_enabled | 是否启用微信支付 | boolean |
| ns_payment_wechat_mch_id | 微信商户号 | string |
| ns_payment_wechat_app_id | 微信应用ID | string |
| ns_payment_wechat_api_key | 微信API密钥 | encrypted string |
| ns_payment_wechat_cert_serial | 证书序列号 | string |
| ns_payment_wechat_cert_path | 证书文件路径 | string |
| ns_payment_wechat_key_path | 密钥文件路径 | string |

---

## 5. 前端设计

### 5.1 配置管理界面

#### 页面位置

在设置页面新增"付款码设置"页签。

#### 布局结构

```
┌─────────────────────────────────────────────────┐
│ POS 设置                                         │
├─────────────────────────────────────────────────┤
│ [常规] [付款码] [其他...]                        │
├─────────────────────────────────────────────────┤
│                                                  │
│ ┌─ 支付宝设置 ────────────────────────────────┐ │
│ │ ☑ 启用支付宝付款码                          │ │
│ │                                              │ │
│ │ 应用ID: [_________________________]         │ │
│ │                                              │ │
│ │ 应用私钥: [浏览...] [已上传/未上传]         │ │
│ │                                              │ │
│ │ 支付宝公钥: [浏览...] [已上传/未上传]         │ │
│ │                                              │ │
│ │ 网关地址: [https://openapi.alipay.com/...]  │ │
│ │                                              │ │
│ │ [测试连接]                                    │ │
│ └──────────────────────────────────────────────┘ │
│                                                  │
│ ┌─ 微信支付设置 ──────────────────────────────┐ │
│ │ ☑ 启用微信付款码                            │ │
│ │                                              │ │
│ │ 商户号: [_________________________]         │ │
│ │                                              │ │
│ │ 应用ID: [_________________________]         │ │
│ │                                              │ │
│ │ API密钥: [_________________________]         │ │
│ │                                              │ │
│ │ 证书序列号: [_________________________]     │ │
│ │                                              │ │
│ │ 商户证书: [浏览...] [已上传/未上传]         │ │
│ │                                              │ │
│ │ 商户密钥: [浏览...] [已上传/未上传]         │ │
│ │                                              │ │
│ │ [测试连接]                                    │ │
│ └──────────────────────────────────────────────┘ │
│                                                  │
│ [保存设置]                                        │
└─────────────────────────────────────────────────┘
```

#### 交互说明

1. **启用/禁用切换**
   - 复选框控制是否启用该支付方式
   - 禁用时隐藏配置选项
   - 禁用时 POS 页面不显示该支付选项

2. **文件上传**
   - 支持点击浏览选择文件
   - 显示文件上传状态（已上传/未上传）
   - 文件加密存储
   - 支持删除和重新上传

3. **测试连接**
   - 点击"测试连接"按钮验证配置
   - 显示加载状态
   - 显示验证结果：
     - 成功：绿色提示"连接成功"
     - 失败：红色提示+详细错误信息

4. **保存设置**
   - 验证必填字段
   - 显示保存进度
   - 保存成功后显示确认提示

### 5.2 POS 支付界面

#### 支付方式选择

在支付弹窗中新增支付宝和微信支付选项。

```
┌─────────────────────────────────────────┐
│ 选择支付方式                             │
├─────────────────────────────────────────┤
│ ○ 现金                                  │
│ ○ 银行卡                                │
│ ○ 支付宝 📱                             │
│ ○ 微信支付 💬                           │
│ ○ 账户                                  │
├─────────────────────────────────────────┤
│ [确认]                                   │
└─────────────────────────────────────────┘
```

#### 付款码输入界面

```
┌─────────────────────────────────────────┐
│ 支付宝支付                        💵50.00│
├─────────────────────────────────────────┤
│                                          │
│ 应收金额: ¥50.00                        │
│                                          │
│ ┌─────────────────────────────────────┐ │
│ │ 📷 扫描付款码或手动输入             │ │
│ │ [_________________________]         │ │
│ └─────────────────────────────────────┘ │
│                                          │
│ 💡 提示：请出示支付宝付款码              │
│                                          │
│ [扫描] [确认支付] [取消]                 │
└─────────────────────────────────────────┘
```

### 5.3 交易记录查询界面

```
┌─────────────────────────────────────────┐
│ 付款码交易记录                           │
├─────────────────────────────────────────┤
│ 筛选:                                    │
│ 日期: [2026-01-01] 至 [2026-01-25]      │
│ 支付方式: [全部 ▼]                       │
│ 状态: [全部 ▼]                           │
│ [查询] [导出]                            │
├─────────────────────────────────────────┤
│ 时间       订单号   支付方式 金额  状态  │
│ 01-25 10:23 #12345  支付宝   ¥50.00 成功│
│ 01-25 10:20 #12344  微信    ¥38.50 成功│
│ 01-25 10:15 #12343  支付宝   ¥12.00 失败│
│ ...                                      │
└─────────────────────────────────────────┘
```

### 5.4 组件设计

#### 新增组件列表

1. **配置管理组件**
   - `ns-payment-code-settings.vue` - 付款码设置主页面
   - `ns-alipay-settings.vue` - 支付宝配置卡片
   - `ns-wechat-settings.vue` - 微信配置卡片
   - `ns-payment-test-connection.vue` - 连接测试组件

2. **支付组件**
   - `ns-alipay-payment.vue` - 支付宝支付组件
   - `ns-wechat-payment.vue` - 微信支付组件
   - `ns-payment-code-scanner.vue` - 付款码扫描组件

3. **报表组件**
   - `ns-payment-code-transactions.vue` - 交易记录列表
   - `ns-payment-code-report.vue` - 付款码统计报表

---

## 6. 后端设计

### 6.1 SDK 集成

#### 6.1.1 支付宝 SDK

**推荐版本**：支付宝官方 PHP SDK (最新稳定版)

**主要接口**：
- 条码支付：`alipay.trade.pay`
- 查询订单：`alipay.trade.query`
- 申请退款：`alipay.trade.refund`

**Composer 依赖**：
```
alipaysdk/easysdk: ^2.2
```

**配置参数**：
- 协议：HTTPS
- 网关：正式环境/沙箱环境
- 应用ID：从配置读取
- 应用私钥：从加密配置读取
- 支付宝公钥：从配置读取

#### 6.1.2 微信支付 SDK

**推荐版本**：微信支付官方 PHP SDK (最新稳定版)

**主要接口**：
- 付款码支付：`pay/transaction/codepay`
- 查询订单：`pay/transactions/out-trade-no/{no}`
- 申请退款：`refund/domestic/refunds`

**Composer 依赖**：
```
wechatpay/wechatpay-guzzle-middleware: ^1.2
```

**配置参数**：
- 商户号：从配置读取
- 商户证书：从文件读取
- 商户密钥：从文件读取
- API v3 密钥：从加密配置读取

### 6.2 服务层设计

#### 核心服务类

1. **PaymentCodeService** - 付款码核心服务
   - 处理付款码支付请求
   - 验证付款码格式
   - 调用对应支付网关

2. **AlipayGateway** - 支付宝网关
   - 初始化支付宝 SDK
   - 调用支付宝支付接口
   - 处理支付响应
   - 处理异步通知

3. **WeChatGateway** - 微信支付网关
   - 初始化微信 SDK
   - 调用微信支付接口
   - 处理支付响应
   - 处理异步通知

4. **PaymentCodeTransactionService** - 交易记录服务
   - 创建交易记录
   - 更新交易状态
   - 查询交易记录
   - 导出交易数据

5. **PaymentCodeConfigService** - 配置管理服务
   - 保存配置
   - 读取配置
   - 验证配置
   - 测试连接

### 6.3 API 接口设计

#### 配置管理接口

```
POST /api/payment-codes/config
GET /api/payment-codes/config
POST /api/payment-codes/config/test
```

#### 支付接口

```
POST /api/payment-codes/pay
参数：
{
  "order_id": 123,
  "payment_type": "alipay", // or "wechat"
  "payment_code": "134567890123456789",
  "amount": 50.00
}

响应：
{
  "status": "success",
  "message": "支付成功",
  "data": {
    "transaction_id": "20260125220014...",
    "order_id": 123,
    "amount": 50.00
  }
}
```

#### 交易记录接口

```
GET /api/payment-codes/transactions
参数：
?start_date=2026-01-01&end_date=2026-01-25&payment_type=alipay

GET /api/payment-codes/transactions/{id}
```

#### 回调通知接口

```
POST /api/payment-codes/notify/alipay
POST /api/payment-codes/notify/wechat
```

### 6.4 支付流程设计

#### 付款码支付流程

```
┌─────────┐
│ 收银员   │
└────┬────┘
     │ 1. 选择支付方式
     ↓
┌─────────┐
│ POS前端 │
└────┬────┘
     │ 2. 输入付款码
     ↓
┌─────────┐
│ 后端API │
└────┬────┘
     │ 3. 验证付款码格式
     │ 4. 创建交易记录
     ↓
┌─────────┐
 │ 支付网关│
 └────┬────┘
      │ 5. 调用官方SDK
      │ 6. 提交支付请求
      ↓
   ┌────────┐
   │官方平台│
   └───┬────┘
       │ 7. 返回支付结果
       ↓
┌─────────┐
│ 支付网关│
└────┬────┘
     │ 8. 验证签名
     │ 9. 解析响应
     ↓
┌─────────┐
│ 后端API │
└────┬────┘
     │ 10. 更新交易记录
     │ 11. 更新订单状态
     ↓
┌─────────┐
│ POS前端 │
└────┬────┘
     │ 12. 显示支付结果
     │ 13. 打印小票
     ↓
┌─────────┐
│ 收银员   │
└─────────┘
```

---

## 7. 安全要求

### 7.1 支付回调验证

#### 验证机制

1. **支付宝回调验证**
   - 验证 RSA2 签名
   - 验证通知来源 IP
   - 验证通知时间（防重放攻击）
   - 验证订单金额

2. **微信回调验证**
   - 验证 AES 签名
   - 验证平台证书序列号
   - 验证通知时间戳
   - 验证订单金额

#### 防重放攻击

- 使用 nonce 机制
- 时间戳验证（5分钟有效期）
- 订单状态检查（防止重复处理）

### 7.2 敏感信息加密

#### 加密要求

1. **配置加密**
   - 应用私钥：AES-256-GCM 加密存储
   - API 密钥：AES-256-GCM 加密存储
   - 使用 Laravel 加密服务

2. **传输加密**
   - 全程 HTTPS 传输
   - 付款码不记录完整日志（仅记录后4位）
   - 响应数据脱敏

3. **数据库加密**
   - 付款码字段使用 SHA-256 哈希
   - 交易流水号明文存储（用于对账）

#### 密钥管理

- 密钥文件权限：600
- 定期轮换密钥
- 禁止密钥提交到版本控制

### 7.3 交易日志

#### 日志记录内容

1. **请求日志**
   - 订单ID
   - 支付类型
   - 付款码（脱敏）
   - 金额
   - 时间戳

2. **响应日志**
   - 第三方交易号
   - 支付状态
   - 错误代码
   - 响应时间

3. **异常日志**
   - 异常类型
   - 异常堆栈
   - 上下文数据

#### 日志存储

- 使用 Laravel 日志系统
- 日志级别：INFO（正常）、WARNING（异常）、ERROR（失败）
- 日志保留期：180 天
- 支持日志导出和备份

### 7.4 金额验证

#### 验证机制

1. **订单金额验证**
   - 支付金额 = 订单应收金额
   - 不允许超额支付
   - 支持部分支付（需记录）

2. **精度处理**
   - 使用 decimal(18,5) 存储
   - 前端展示保留2位小数
   - 计算使用 bcadd/bcmul 等高精度函数

3. **防篡改**
   - 订单创建后金额锁定
   - 支付前再次验证金额
   - 使用签名验证接口参数

### 7.5 权限控制

#### 操作权限

1. **配置管理**
   - 仅系统管理员可修改
   - 记录配置变更日志
   - 配置修改需二次确认

2. **支付操作**
   - 仅收银员角色可执行支付
   - 记录操作员信息
   - 支持操作追溯

3. **报表查看**
   - 按角色分级访问
   - 敏感数据脱敏显示
   - 导出需要审批

---

## 8. 使用流程

### 8.1 系统配置流程

```
步骤 1: 登录 NexoPOS 系统
  └─> 使用管理员账号登录后台

步骤 2: 进入设置页面
  └─> 导航到：设置 > POS 设置 > 付款码设置

步骤 3: 配置支付宝
  ├─> 勾选"启用支付宝付款码"
  ├─> 填写应用ID
  ├─> 上传应用私钥文件
  ├─> 上传支付宝公钥文件
  ├─> 配置网关地址（可选）
  └─> 点击"测试连接"验证配置

步骤 4: 配置微信支付
  ├─> 勾选"启用微信付款码"
  ├─> 填写商户号
  ├─> 填写应用ID
  ├─> 填写API密钥
  ├─> 填写证书序列号
  ├─> 上传商户证书文件
  ├─> 上传商户密钥文件
  └─> 点击"测试连接"验证配置

步骤 5: 保存配置
  └─> 点击"保存设置"按钮

步骤 6: 验证生效
  └─> 进入POS页面，查看支付方式列表
```

### 8.2 收银流程

#### 场景：顾客使用支付宝付款码支付

```
┌─────────────────────────────────────────────────┐
│ 步骤 1: 扫描商品条形码                          │
├─────────────────────────────────────────────────┤
│ 顾客将商品条形码对准扫码枪                      │
│ 系统自动识别并添加商品到购物车                  │
│ 重复此步骤直到所有商品添加完成                  │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│ 步骤 2: 查看购物车                              │
├─────────────────────────────────────────────────┤
│ 系统显示商品清单、数量、单价                    │
│ 计算小计、折扣、税费、总计                      │
│ 收银员确认商品和金额                            │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│ 步骤 3: 点击支付按钮                            │
├─────────────────────────────────────────────────┤
│ 收银员点击"支付"按钮                            │
│ 系统打开支付方式选择弹窗                        │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│ 步骤 4: 选择支付方式                            │
├─────────────────────────────────────────────────┤
│ 顾客：使用支付宝支付                            │
│ 收银员：选择"支付宝"选项                        │
│ 系统打开支付宝支付弹窗                          │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│ 步骤 5: 扫描付款码                              │
├─────────────────────────────────────────────────┤
│ 顾客打开手机支付宝，出示付款码                  │
│ 收银员使用扫码枪扫描付款码                      │
│ ┌─────────────────────────────────────────┐   │
│ │ 系统自动识别付款码格式                   │   │
│ │ - 识别为支付宝付款码（10-18位数字）      │   │
│ │ - 显示付款码后4位                        │   │
│ │ - 显示应收金额                          │   │
│ └─────────────────────────────────────────┘   │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│ 步骤 6: 确认支付                                │
├─────────────────────────────────────────────────┤
│ 系统弹出确认对话框：                            │
│ ┌─────────────────────────────────────────┐   │
│ │ 确认支付                                │   │
│ │                                         │   │
│ │ 支付方式：支付宝                         │   │
│ │ 付款码：**** **** **** 6789             │   │
│ │ 支付金额：¥50.00                        │   │
│ │                                         │   │
│ │ [取消]  [确认支付]                      │   │
│ └─────────────────────────────────────────┘   │
│                                          │   │
│ 收银员点击"确认支付"                        │   │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│ 步骤 7: 处理支付                                │
├─────────────────────────────────────────────────┤
│ 系统执行以下操作：                              │
│ 1. 创建交易记录（状态：处理中）                │
│ 2. 调用支付宝支付接口                          │
│ 3. 提交付款码和金额                            │
│ 4. 等待支付宝响应                              │
│ 5. 验证响应签名                                │
│ 6. 更新交易记录（状态：成功/失败）            │
└─────────────────────────────────────────────────┘
                    ↓
        ┌──────────────┴──────────────┐
        │                             │
   支付成功                      支付失败
        │                             │
        ↓                             ↓
┌──────────────────┐         ┌──────────────────┐
│ 显示成功界面     │         │ 显示失败界面     │
│ ├─ 支付成功 ✓    │         │ ├─ 支付失败 ✗    │
│ ├─ 交易号：xxx   │         │ ├─ 错误原因      │
│ ├─ 金额：¥50.00  │         │ └─ [重试] [取消] │
│ └─ [打印小票]    │         └──────────────────┘
└──────────────────┘
        ↓
┌─────────────────────────────────────────────────┐
│ 步骤 8: 打印小票                                │
├─────────────────────────────────────────────────┤
│ 系统自动打印小票：                              │
│ ┌─────────────────────────────────────────┐   │
│ │ NexoPOS 销售小票                        │   │
│ │ ========================================│   │
│ │ 时间：2026-01-25 10:23:45              │   │
│ │ 订单号：#12345                          │   │
│ │ ----------------------------------------│   │
│ │ 商品          数量   单价   小计        │   │
│ │ 可口可乐       2      5.00   10.00      │   │
│ │ 面包           1      8.00   8.00       │   │
│ │ ----------------------------------------│   │
│ │ 小计：                   18.00          │   │
│ │ 税费：                    2.00          │   │
│ │ 总计：                   50.00          │   │
│ │ ----------------------------------------│   │
│ │ 支付方式：支付宝                        │   │
│ │ 付款码：**** **** **** 6789             │   │
│ │ 交易号：20260125220014...              │   │
│ │ ========================================│   │
│ │ 感谢您的光临！                          │   │
│ └─────────────────────────────────────────┘   │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│ 步骤 9: 清空购物车                              │
├─────────────────────────────────────────────────┤
│ 系统自动清空购物车                              │
│ 准备接待下一位顾客                              │
└─────────────────────────────────────────────────┘
```

### 8.3 微信付款码支付流程

微信付款码支付流程与支付宝类似，区别在于：

1. 付款码格式识别不同
2. 调用微信支付接口
3. 返回微信交易号

其他步骤完全相同。

### 8.4 异常处理流程

#### 支付失败处理

```
支付失败
    ↓
显示错误提示
    ↓
┌───────────┬───────────┬───────────┐
│ 余额不足   │ 付款码过期 │ 网络异常  │
├───────────┼───────────┼───────────┤
│ 提示顾客   │ 提示顾客   │ 自动重试  │
│ 更换支付   │ 刷新付款码 │ 最多3次   │
│ 方式       │             │          │
└───────────┴───────────┴───────────┘
```

#### 网络异常处理

- 自动重试机制（最多3次）
- 超时时间：15秒
- 失败后提示手动重试或更换支付方式

---

## 9. 测试要求

### 9.1 单元测试

#### 后端单元测试

测试覆盖范围：

1. **配置管理测试**
   - 配置保存和读取
   - 配置加密和解密
   - 配置验证逻辑

2. **支付网关测试**
   - SDK 初始化
   - 支付请求构造
   - 响应解析
   - 签名验证

3. **服务层测试**
   - 付款码格式验证
   - 金额验证
   - 交易记录创建和更新
   - 异常处理

测试文件位置：
- `tests/Unit/PaymentCode/AlipayGatewayTest.php`
- `tests/Unit/PaymentCode/WeChatGatewayTest.php`
- `tests/Unit/PaymentCode/PaymentCodeServiceTest.php`

#### 前端单元测试

测试覆盖范围：

1. **组件测试**
   - 配置界面组件
   - 支付组件
   - 扫码组件

2. **工具函数测试**
   - 付款码格式验证
   - 金额格式化
   - 加密解密

测试文件位置：
- `resources/ts/tests/payment-code/`

### 9.2 集成测试

#### 支付流程测试

测试场景：

1. **支付宝支付成功流程**
   - 输入有效付款码
   - 验证支付成功
   - 验证订单状态更新
   - 验证交易记录创建

2. **微信支付成功流程**
   - 输入有效付款码
   - 验证支付成功
   - 验证订单状态更新
   - 验证交易记录创建

3. **支付失败流程**
   - 余额不足
   - 付款码过期
   - 网络异常
   - 验证错误处理

4. **配置管理流程**
   - 保存支付宝配置
   - 保存微信配置
   - 测试连接功能
   - 配置验证

测试文件位置：
- `tests/Feature/PaymentCode/PaymentCodeTest.php`

### 9.3 性能测试

#### 测试指标

1. **响应时间**
   - 支付接口响应 < 3秒
   - 配置保存 < 1秒
   - 交易记录查询 < 2秒

2. **并发处理**
   - 支持50并发支付请求
   - 100并发查询请求
   - 系统稳定性测试（1小时）

3. **压力测试**
   - 峰值流量测试（100 TPS）
   - 长时间运行稳定性（24小时）

### 9.4 安全测试

#### 测试内容

1. **签名验证**
   - 伪造签名测试
   - 重放攻击测试
   - 中间人攻击测试

2. **数据加密**
   - 敏感信息存储加密
   - 传输加密验证
   - 密钥泄露测试

3. **权限控制**
   - 未授权访问测试
   - 越权操作测试
   - SQL注入测试

4. **金额安全**
   - 金额篡改测试
   - 超额支付测试
   - 重复支付测试

### 9.5 用户体验测试

#### 测试场景

1. **正常流程**
   - 配置管理界面易用性
   - 支付流程流畅性
   - 错误提示清晰性

2. **异常场景**
   - 网络断开处理
   - 支付失败处理
   - 超时处理

3. **兼容性测试**
   - 不同浏览器测试
   - 不同设备测试（PC、平板）
   - 不同扫码枪测试

### 9.6 沙箱测试

#### 支付宝沙箱测试

使用支付宝沙箱环境进行完整流程测试：

- 沙箱应用配置
- 沙箱付款码获取
- 支付流程验证
- 退款流程验证

#### 微信沙箱测试

使用微信支付模拟器进行测试：

- 模拟支付成功
- 模拟支付失败
- 回调通知验证

---

## 10. 部署说明

### 10.1 环境要求

#### 服务器要求

- PHP >= 8.2
- MySQL >= 5.7 或 MariaDB >= 10.3
- Composer 最新版本
- OpenSSL 扩展
- cURL 扩展
- GD 扩展（用于二维码生成）

#### 浏览器要求

- Chrome 90+（推荐）
- Edge 90+
- Firefox 88+
- Safari 14+

#### 硬件要求

- 支持 HTTPS
- 摄像头（可选，用于扫码）
- 扫码枪（推荐）

### 10.2 依赖安装

#### Composer 依赖

需要安装以下 PHP 包：

```
# 支付宝 SDK
alipaysdk/easysdk: ^2.2

# 微信支付 SDK
wechatpay/wechatpay-guzzle-middleware: ^1.2

# 二维码生成（如需显示收款码）
endroid/qr-code: ^4.8
```

#### NPM 依赖

需要安装以下前端包：

```
# 二维码扫描（如使用摄像头扫描）
html5-qrcode: ^2.3.8
```

### 10.3 数据库迁移

执行迁移命令：

```bash
php artisan migrate
```

迁移内容包括：

1. 创建交易记录表
2. 插入默认支付类型
3. 更新配置表

### 10.4 配置文件

#### 环境变量

在 `.env` 文件中添加：

```env
# 支付宝配置
ALIPAY_GATEWAY=https://openapi.alipay.com/gateway.do
ALIPAY_SANDBOX_GATEWAY=https://openapi.alisdk.com/gateway.do

# 微信支付配置
WECHATPAY_MCH_ID=
WECHATPAY_APIV3_KEY=
```

#### 配置发布

发布配置文件：

```bash
php artisan vendor:publish --tag=payment-code-config
```

### 10.5 文件权限

设置以下文件和目录权限：

```bash
# 证书文件存储目录
storage/app/payment-codes/certs  700

# 日志目录
storage/logs  755
```

### 10.6 HTTPS 配置

#### 为什么需要 HTTPS

支付宝和微信支付要求所有通信必须使用 HTTPS 协议。

#### 配置步骤

1. 申请 SSL 证书
2. 配置 Web 服务器（Apache/Nginx）
3. 强制 HTTPS 重定向
4. 验证证书有效性

### 10.7 防火墙配置

#### 出站规则

允许服务器访问以下域名：

```
# 支付宝
openapi.alipay.com:443

# 微信支付
api.mch.weixin.qq.com:443
```

#### 入站规则

允许访问以下端口：

```
# HTTPS
443/tcp

# SSH（管理用）
22/tcp
```

### 10.8 日志配置

#### 日志级别

生产环境设置为 `production`：

```env
APP_ENV=production
APP_LOG_LEVEL=warning
```

#### 日志轮转

配置日志轮转，避免日志文件过大：

```bash
# /etc/logrotate.d/nexopos
/path/to/nexopos/storage/logs/*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
}
```

### 10.9 备份策略

#### 数据备份

1. **数据库备份**
   - 每日自动备份
   - 保留30天
   - 异地备份

2. **文件备份**
   - 证书文件
   - 配置文件
   - 日志文件

#### 配置备份

- 导出配置到加密文件
- 定期测试配置恢复

### 10.10 监控和告警

#### 监控指标

1. **支付成功率**
   - 正常：> 99%
   - 告警：< 95%

2. **响应时间**
   - 正常：< 3秒
   - 告警：> 5秒

3. **错误率**
   - 正常：< 1%
   - 告警：> 5%

#### 告警方式

- 邮件通知
- 短信通知
- 系统内通知

### 10.11 回滚计划

如发生问题，回滚步骤：

1. 在支付类型管理中禁用付款码支付
2. 恢复之前的数据库备份
3. 回滚代码到上一个版本
4. 验证系统正常运行
5. 通知相关人员

---

## 附录

### A. 支付宝官方文档

- 支付宝开放平台：https://open.alipay.com
- 条码支付文档：https://opendocs.alipay.com/open/028r8t
- SDK 文档：https://opendocs.alipay.com/open/02ivfa

### B. 微信支付官方文档

- 微信支付商户平台：https://pay.weixin.qq.com
- 付款码支付文档：https://pay.weixin.qq.com/wiki/doc/api/index.html
- SDK 文档：https://pay.weixin.qq.com/wiki/doc/apiv3/index.shtml

### C. 付款码格式规范

#### 支付宝付款码

- 格式：10-18 位纯数字
- 示例：134567890123456789
- 刷新周期：每分钟刷新一次

#### 微信付款码

- 格式：10-18 位纯数字
- 示例：134567890123456789
- 刷新周期：每分钟刷新一次

**注意**：支付宝和微信付款码格式相同，需要根据用户选择的支付方式来判断。

### D. 常见错误码

#### 支付宝错误码

| 错误码 | 说明 | 处理建议 |
|-------|------|---------|
| ACQ.INVALID_PARAMETER | 参数无效 | 检查请求参数 |
| ACQ.SYSTEM_ERROR | 系统错误 | 重试或联系技术支持 |
| ACQ.PAYMENT_AUTH_CODE_INVALID | 付款码无效 | 提示用户刷新付款码 |
| ACQ.BALANCE_NOT_ENOUGH | 余额不足 | 提示用户充值或更换支付方式 |
| ACQ.PAYMENT_CODE_EXPIRED | 付款码过期 | 提示用户刷新付款码 |

#### 微信支付错误码

| 错误码 | 说明 | 处理建议 |
|-------|------|---------|
| PARAM_ERROR | 参数错误 | 检查请求参数 |
| SYSTEMERROR | 系统错误 | 重试或联系技术支持 |
| PAYMENT_AUTH_CODE_INVALID | 付款码无效 | 提示用户刷新付款码 |
| NOT_ENOUGH | 余额不足 | 提示用户充值或更换支付方式 |
| AUTHCODEEXPIRE | 付款码过期 | 提示用户刷新付款码 |

### E. 术语表

| 术语 | 说明 |
|-----|------|
| 付款码 | 用户出示的条形码/二维码，用于扫码支付 |
| 条码支付 | 商户通过扫描用户付款码完成支付 |
| 交易号 | 第三方支付平台返回的唯一交易标识 |
| 商户号 | 在支付平台注册的商户唯一标识 |
| 应用ID | 应用程序的唯一标识 |
| API密钥 | 用于调用API的密钥 |
| 公钥/私钥 | 用于签名的非对称加密密钥对 |
| 签名 | 用于验证数据完整性和来源的加密字符串 |
| 回调 | 支付平台异步通知支付结果 |
| 退款 | 原路退回到付款账户 |
| 对账 | 核对交易记录与支付平台记录 |

---

## 变更记录

| 版本 | 日期 | 修改人 | 修改内容 |
|-----|------|-------|---------|
| v1.0 | 2026-01-25 | - | 初始版本 |

---

**文档结束**
