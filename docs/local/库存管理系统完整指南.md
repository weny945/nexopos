# NexoPOS åº“å­˜ç®¡ç†ç³»ç»Ÿå®Œæ•´æŒ‡å—

> æ–‡æ¡£ç”Ÿæˆæ—¶é—´: 2026-01-23
> NexoPOS ç‰ˆæœ¬: Laravel 12.29.0
> é€‚ç”¨èŒƒå›´: åº“å­˜ç®¡ç†ã€å•†å“åˆ›å»ºã€æ¡å½¢ç æ‰«æã€é‡‡è´­ç®¡ç†

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [å•†å“åˆ›å»ºä¸ç®¡ç†](#å•†å“åˆ›å»ºä¸ç®¡ç†)
3. [åº“å­˜æ§åˆ¶æµç¨‹](#åº“å­˜æ§åˆ¶æµç¨‹)
4. [é‡‡è´­ç®¡ç†](#é‡‡è´­ç®¡ç†)
5. [æ¡å½¢ç ç³»ç»Ÿ](#æ¡å½¢ç ç³»ç»Ÿ)
6. [å‰ç«¯æ“ä½œæŒ‡å—](#å‰ç«¯æ“ä½œæŒ‡å—)
7. [API æ¥å£è¯´æ˜](#api-æ¥å£è¯´æ˜)
8. [æ•°æ®åº“ç»“æ„](#æ•°æ®åº“ç»“æ„)

---

## ç³»ç»Ÿæ¦‚è¿°

NexoPOS é‡‡ç”¨**ä¼ä¸šçº§åº“å­˜ç®¡ç†æ¶æ„**ï¼Œå…·æœ‰ä»¥ä¸‹æ ¸å¿ƒç‰¹æ€§ï¼š

### æ ¸å¿ƒç‰¹æ€§
- âœ… **ç²¾ç¡®åº“å­˜è¿½è¸ª** - æ¯æ¬¡åº“å­˜å˜åŠ¨éƒ½æœ‰å®Œæ•´å®¡è®¡è®°å½•
- âœ… **å¤šå•ä½ç®¡ç†** - æ”¯æŒåŒä¸€å•†å“çš„å¤šç§é”€å”®å•ä½ï¼ˆä»¶/ç®±/å¨ç­‰ï¼‰
- âœ… **æ¡å½¢ç æ‰«æ** - åŸç”Ÿæ”¯æŒæ‰«ææªï¼ŒåŒ…æ‹¬ç§°é‡å•†å“æ¡å½¢ç 
- âœ… **è‡ªåŠ¨æˆæœ¬æ ¸ç®—** - è‡ªåŠ¨è®¡ç®— COGSï¼ˆé”€å”®æˆæœ¬ï¼‰
- âœ… **ä½åº“å­˜è­¦æŠ¥** - å¯é…ç½®åº“å­˜é¢„è­¦é˜ˆå€¼
- âœ… **æ‰¹æ¬¡ç®¡ç†** - é‡‡è´­æ‰¹æ¬¡è¿½æº¯å’Œä¿è´¨æœŸç®¡ç†
- âœ… **è´Ÿåº“å­˜æ§åˆ¶** - å¯é…ç½®æ˜¯å¦å…è®¸è´Ÿåº“å­˜

### æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‰ç«¯ Vue 3 é¡µé¢                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ å•†å“ç®¡ç†  â”‚  â”‚ åº“å­˜è°ƒæ•´  â”‚  â”‚ é‡‡è´­ç®¡ç†  â”‚  â”‚ POS æ”¶é“¶ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ HTTP API (RESTful)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Laravel æ§åˆ¶å™¨å±‚                        â”‚
â”‚         ProductsController  â”‚  ProcurementController      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æœåŠ¡å±‚ (æ ¸å¿ƒä¸šåŠ¡é€»è¾‘)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ProductServiceâ”‚  â”‚BarcodeServiceâ”‚  â”‚ProcurementSvcâ”‚  â”‚
â”‚  â”‚  - åˆ›å»ºå•†å“    â”‚  â”‚ - ç”Ÿæˆæ¡å½¢ç   â”‚  â”‚  - é‡‡è´­å…¥åº“   â”‚  â”‚
â”‚  â”‚  - åº“å­˜è°ƒæ•´    â”‚  â”‚ - è§£æPLUç   â”‚  â”‚  - æˆæœ¬è®¡ç®—   â”‚  â”‚
â”‚  â”‚  - æˆæœ¬æ ¸ç®—    â”‚  â”‚ - éªŒè¯å”¯ä¸€æ€§  â”‚  â”‚  - æ‰¹æ¬¡ç®¡ç†   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æ•°æ®åº“å±‚ (MySQL)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ns_products  â”‚  â”‚ns_products_  â”‚  â”‚ns_products_  â”‚  â”‚
â”‚  â”‚ (å•†å“ä¸»è¡¨)    â”‚  â”‚unit_quantitiesâ”‚ â”‚ histories    â”‚  â”‚
â”‚  â”‚              â”‚  â”‚ (åº“å­˜/ä»·æ ¼)   â”‚  â”‚ (å®¡è®¡æ—¥å¿—)    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ns_procurementsâ”‚ â”‚ns_procurementsâ”‚                   â”‚
â”‚  â”‚ (é‡‡è´­å•)      â”‚  â”‚_products      â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å•†å“åˆ›å»ºä¸ç®¡ç†

### 1. å•†å“ç±»å‹

NexoPOS æ”¯æŒ **4 ç§å•†å“ç±»å‹**ï¼š

| ç±»å‹ | è¯´æ˜ | åº“å­˜ç®¡ç† | ä½¿ç”¨åœºæ™¯ |
|------|------|----------|----------|
| **ç®€å•å•†å“** (Simple) | æ ‡å‡†å®ä½“/è™šæ‹Ÿå•†å“ | âœ… æ”¯æŒ | æ™®é€šé›¶å”®å•†å“ |
| **å¯å˜å•†å“** (Variable) | å¸¦æœ‰å¤šç§å˜ä½“çš„å•†å“ï¼ˆå¦‚é¢œè‰²ã€å°ºå¯¸ï¼‰ | âœ… æŒ‰å˜ä½“è¿½è¸ª | æœè£…ã€é‹å­ç­‰ |
| **ç»„åˆå•†å“** (Grouped) | ç”±å¤šä¸ªå­å•†å“ç»„æˆçš„å¥—é¤ | âœ… è‡ªåŠ¨æ‰£å‡å­é¡¹ | å¥—é¤ã€ç¤¼ç›’ |
| **è™šæ‹Ÿå•†å“** (Dematerialized) | æ— å®ä½“çš„æœåŠ¡/æ•°å­—äº§å“ | âŒ ä¸è¿½è¸ª | æœåŠ¡è´¹ã€ä¼šå‘˜å¡ |

### 2. åˆ›å»ºå•†å“æµç¨‹

#### å‰ç«¯æ“ä½œè·¯å¾„
```
ä»ªè¡¨æ¿ â†’ å•†å“ â†’ åˆ›å»ºå•†å“
URL: /dashboard/products/create
```

#### å¿…å¡«å­—æ®µ

**åŸºæœ¬ä¿¡æ¯**
- `name` - å•†å“åç§° âœ… å¿…å¡«
- `type` - å•†å“ç±»å‹ï¼ˆmaterialized/dematerialized/groupedï¼‰
- `product_type` - äº§å“ç±»å‹ï¼ˆproduct/variableï¼‰
- `category_id` - æ‰€å±åˆ†ç±» âœ… æ¨èå¡«å†™
- `barcode` - æ¡å½¢ç ï¼ˆç•™ç©ºåˆ™è‡ªåŠ¨ç”Ÿæˆï¼‰
- `sku` - åº“å­˜å•ä½ä»£ç ï¼ˆç•™ç©ºåˆ™è‡ªåŠ¨ç”Ÿæˆï¼‰
- `barcode_type` - æ¡å½¢ç ç±»å‹ï¼ˆean8/ean13/code128 ç­‰ï¼‰

**åº“å­˜é…ç½®**
- `stock_management` - æ˜¯å¦å¯ç”¨åº“å­˜ç®¡ç†ï¼ˆenabled/disabledï¼‰
- `accurate_tracking` - ç²¾ç¡®è¿½è¸ªï¼ˆæ˜¯å¦æŒ‰æ‰¹æ¬¡ç®¡ç†ï¼‰
- `auto_cogs` - è‡ªåŠ¨è®¡ç®—é”€å”®æˆæœ¬

**ç¨åŠ¡é…ç½®**
- `tax_group_id` - ç¨ç»„ ID
- `tax_type` - ç¨æ”¶ç±»å‹ï¼ˆinclusive/exclusiveï¼‰

**å•ä½å’Œä»·æ ¼**
- `unit_group` - å•ä½ç»„ ID âœ… å¿…å¡«
- æ¯ä¸ªé”€å”®å•ä½éœ€é…ç½®ï¼š
  - `unit_id` - å•ä½ ID
  - `sale_price` - é”€å”®ä»·æ ¼
  - `wholesale_price` - æ‰¹å‘ä»·æ ¼
  - `low_quantity` - ä½åº“å­˜é˜ˆå€¼
  - `stock_alert_enabled` - æ˜¯å¦å¯ç”¨åº“å­˜è­¦æŠ¥

#### åç«¯æœåŠ¡æ–¹æ³•

**æ–‡ä»¶ä½ç½®**: `app/Services/ProductService.php`

```php
// åˆ›å»ºå•†å“ä¸»æ–¹æ³•
ProductService::create(array $data): Product

// åˆ›å»ºç®€å•å•†å“
ProductService::createSimpleProduct(array $fields): Product

// åˆ›å»ºå¯å˜å•†å“ï¼ˆå¸¦å˜ä½“ï¼‰
ProductService::createVariableProduct(array $fields): Product

// æ›´æ–°å•†å“
ProductService::update(Product $product, array $fields): array
```

**æ ¸å¿ƒé€»è¾‘**:
1. éªŒè¯æ¡å½¢ç å”¯ä¸€æ€§
2. è‡ªåŠ¨ç”Ÿæˆ SKUï¼ˆå¦‚æœæœªæä¾›ï¼‰
3. è‡ªåŠ¨ç”Ÿæˆæ¡å½¢ç ï¼ˆé»˜è®¤ EAN8ï¼‰
4. åˆ›å»ºå•†å“å•ä½æ•°é‡è®°å½•
5. ä¸ºæ¯ä¸ªå•ä½ç”Ÿæˆå”¯ä¸€æ¡å½¢ç  `{product_barcode}-{quantity_id}`
6. ä¿å­˜å›¾ç‰‡åº“å’Œç¨åŠ¡é…ç½®
7. è§¦å‘ `ProductAfterCreatedEvent` äº‹ä»¶

### 3. å•†å“å­—æ®µè¯¦è§£

#### nexopos_products è¡¨æ ¸å¿ƒå­—æ®µ

```sql
CREATE TABLE `ns_products` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `name` varchar(255) NOT NULL COMMENT 'å•†å“åç§°',
  `sku` varchar(255) UNIQUE COMMENT 'SKUä»£ç ',
  `barcode` varchar(255) UNIQUE COMMENT 'æ¡å½¢ç ',
  `barcode_type` varchar(255) COMMENT 'æ¡å½¢ç ç±»å‹',

  -- å•†å“ç±»å‹
  `type` enum('materialized','dematerialized','grouped') COMMENT 'å®ä½“/è™šæ‹Ÿ/ç»„åˆ',
  `product_type` enum('product','variable','variation') COMMENT 'æ™®é€š/å¯å˜/å˜ä½“',

  -- åº“å­˜é…ç½®
  `stock_management` enum('enabled','disabled') DEFAULT 'enabled',
  `accurate_tracking` tinyint(1) DEFAULT 0 COMMENT 'æ˜¯å¦æŒ‰æ‰¹æ¬¡ç²¾ç¡®è¿½è¸ª',
  `auto_cogs` tinyint(1) DEFAULT 1 COMMENT 'è‡ªåŠ¨è®¡ç®—æˆæœ¬',

  -- åˆ†ç±»å’Œå…³ç³»
  `category_id` bigint COMMENT 'åˆ†ç±»ID',
  `parent_id` bigint COMMENT 'çˆ¶å•†å“IDï¼ˆç”¨äºå˜ä½“ï¼‰',
  `unit_group` bigint NOT NULL COMMENT 'å•ä½ç»„ID',

  -- ç¨åŠ¡
  `tax_group_id` bigint COMMENT 'ç¨ç»„ID',
  `tax_type` enum('inclusive','exclusive') COMMENT 'å«ç¨/ä¸å«ç¨',
  `tax_value` decimal(18,5) COMMENT 'ç¨ç‡',

  -- çŠ¶æ€
  `status` enum('available','unavailable') DEFAULT 'available',
  `searchable` tinyint(1) DEFAULT 1 COMMENT 'æ˜¯å¦å¯æœç´¢',

  -- æè¿°å’Œå›¾ç‰‡
  `description` text COMMENT 'å•†å“æè¿°',

  -- æ—¶é—´æˆ³
  `created_at` timestamp,
  `updated_at` timestamp,

  INDEX idx_barcode (barcode),
  INDEX idx_sku (sku),
  INDEX idx_category (category_id),
  INDEX idx_status (status)
) COMMENT='å•†å“ä¸»è¡¨';
```

---

## åº“å­˜æ§åˆ¶æµç¨‹

### 1. åº“å­˜å­˜å‚¨ç»“æ„

åº“å­˜æ•°é‡å­˜å‚¨åœ¨ **`ns_products_unit_quantities`** è¡¨ä¸­ï¼Œæ¯ä¸ªå•†å“çš„æ¯ä¸ªé”€å”®å•ä½éƒ½æœ‰ç‹¬ç«‹è®°å½•ã€‚

#### nexopos_products_unit_quantities è¡¨

```sql
CREATE TABLE `ns_products_unit_quantities` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `product_id` bigint NOT NULL COMMENT 'å•†å“ID',
  `unit_id` bigint NOT NULL COMMENT 'å•ä½ID',

  -- åº“å­˜æ•°é‡ï¼ˆæ ¸å¿ƒå­—æ®µï¼‰
  `quantity` decimal(18,5) DEFAULT 0 COMMENT 'å½“å‰åº“å­˜',
  `low_quantity` decimal(18,5) DEFAULT 0 COMMENT 'ä½åº“å­˜é˜ˆå€¼',
  `stock_alert_enabled` tinyint(1) DEFAULT 0 COMMENT 'æ˜¯å¦å¯ç”¨åº“å­˜è­¦æŠ¥',

  -- æ¡å½¢ç å’Œç§°é‡
  `barcode` varchar(255) UNIQUE COMMENT 'å•ä½æ¡å½¢ç ',
  `scale_plu` varchar(20) UNIQUE COMMENT 'ç”µå­ç§¤PLUç ',
  `is_weighable` tinyint(1) DEFAULT 0 COMMENT 'æ˜¯å¦ç§°é‡å•†å“',

  -- ä»·æ ¼ï¼ˆå«ç¨/ä¸å«ç¨ï¼‰
  `sale_price` decimal(18,5) COMMENT 'é”€å”®ä»·',
  `sale_price_edit` decimal(18,5) COMMENT 'å®é™…é”€å”®ä»·',
  `sale_price_with_tax` decimal(18,5) COMMENT 'å«ç¨é”€å”®ä»·',
  `sale_price_without_tax` decimal(18,5) COMMENT 'ä¸å«ç¨é”€å”®ä»·',

  `wholesale_price` decimal(18,5) COMMENT 'æ‰¹å‘ä»·',
  `wholesale_price_edit` decimal(18,5),
  `wholesale_price_with_tax` decimal(18,5),
  `wholesale_price_without_tax` decimal(18,5),

  `custom_price` decimal(18,5) COMMENT 'è‡ªå®šä¹‰ä»·æ ¼',
  `custom_price_edit` decimal(18,5),

  -- æˆæœ¬
  `cogs` decimal(18,5) COMMENT 'é”€å”®æˆæœ¬ï¼ˆCOGSï¼‰',

  -- æ˜¾ç¤ºæ§åˆ¶
  `visible` tinyint(1) DEFAULT 1 COMMENT 'æ˜¯å¦åœ¨POSæ˜¾ç¤º',

  -- å•ä½è½¬æ¢
  `convert_unit_id` bigint COMMENT 'è½¬æ¢ç›®æ ‡å•ä½ID',

  UNIQUE KEY unique_product_unit (product_id, unit_id),
  INDEX idx_barcode (barcode),
  INDEX idx_plu (scale_plu)
) COMMENT='å•†å“å•ä½åº“å­˜è¡¨';
```

### 2. åº“å­˜æ“ä½œç±»å‹

**æ–‡ä»¶ä½ç½®**: `app/Models/ProductHistory.php`

#### å¢åŠ åº“å­˜çš„æ“ä½œ

```php
const STOCK_INCREASE = [
    'STOCKED',           // é‡‡è´­å…¥åº“
    'ADDED',             // æ‰‹åŠ¨æ·»åŠ 
    'RETURNED',          // é€€è´§å…¥åº“
    'TRANSFER_IN',       // è°ƒæ‹¨å…¥åº“
    'CONVERT_IN',        // å•ä½è½¬æ¢å¢åŠ 
    'ADJUSTMENT_RETURN', // è°ƒæ•´é€€å›
    'VOID_RETURN',       // ä½œåºŸé€€å›
];
```

#### å‡å°‘åº“å­˜çš„æ“ä½œ

```php
const STOCK_REDUCE = [
    'SOLD',              // é”€å”®å‡ºåº“
    'REMOVED',           // æ‰‹åŠ¨ç§»é™¤
    'DEFECTIVE',         // æŸåæŠ¥åºŸ
    'LOST',              // é—å¤±
    'TRANSFER_OUT',      // è°ƒæ‹¨å‡ºåº“
    'CONVERT_OUT',       // å•ä½è½¬æ¢å‡å°‘
    'ADJUSTMENT_SALE',   // è°ƒæ•´é”€å”®
    'DELETED',           // åˆ é™¤å•†å“
];
```

### 3. åº“å­˜è°ƒæ•´æ ¸å¿ƒæ–¹æ³•

**æ–‡ä»¶ä½ç½®**: `app/Services/ProductService.php`

#### 3.1 æ ¸å¿ƒè°ƒæ•´æ–¹æ³•

```php
/**
 * åº“å­˜è°ƒæ•´ä¸»æ–¹æ³•
 *
 * @param string $action æ“ä½œç±»å‹ï¼ˆSTOCKED/SOLD/ADDEDç­‰ï¼‰
 * @param array $data è°ƒæ•´æ•°æ®
 * @return array
 */
ProductService::stockAdjustment(string $action, array $data): array

// å‚æ•°è¯´æ˜ï¼š
$data = [
    'product_id' => 123,              // å•†å“ID
    'unit_id' => 456,                 // å•ä½ID
    'quantity' => 10.5,               // æ•°é‡
    'unit_price' => 50.00,            // å•ä»·
    'description' => 'é‡‡è´­å…¥åº“',       // æè¿°
    'procurement_product_id' => 789,  // é‡‡è´­å•†å“IDï¼ˆå¯é€‰ï¼‰
    'order_id' => 101,                // è®¢å•IDï¼ˆå¯é€‰ï¼‰
];
```

#### 3.2 ç›´æ¥è®¾ç½®åº“å­˜

```php
/**
 * ç›´æ¥è®¾ç½®å•†å“åº“å­˜ä¸ºæŒ‡å®šæ•°é‡
 */
ProductService::setQuantity(
    int $product_id,
    int $unit_id,
    float $quantity
): ProductUnitQuantity
```

#### 3.3 å¢åŠ /å‡å°‘åº“å­˜

```php
// å¢åŠ åº“å­˜
ProductService::increaseUnitQuantities(
    int $product_id,
    int $unit_id,
    float $quantity
): void

// å‡å°‘åº“å­˜
ProductService::reduceUnitQuantities(
    int $product_id,
    int $unit_id,
    float $quantity
): void
```

### 4. åº“å­˜å†å²è®°å½•

æ¯æ¬¡åº“å­˜å˜åŠ¨éƒ½ä¼šåœ¨ **`ns_products_histories`** è¡¨ä¸­åˆ›å»ºè®°å½•ã€‚

#### nexopos_products_histories è¡¨

```sql
CREATE TABLE `ns_products_histories` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `product_id` bigint NOT NULL COMMENT 'å•†å“ID',
  `unit_id` bigint NOT NULL COMMENT 'å•ä½ID',

  -- æ“ä½œç±»å‹
  `operation_type` varchar(50) NOT NULL COMMENT 'æ“ä½œç±»å‹ï¼ˆSOLD/STOCKEDç­‰ï¼‰',

  -- æ•°é‡å˜åŒ–
  `before_quantity` decimal(18,5) COMMENT 'å˜åŠ¨å‰æ•°é‡',
  `quantity` decimal(18,5) COMMENT 'å˜åŠ¨æ•°é‡',
  `after_quantity` decimal(18,5) COMMENT 'å˜åŠ¨åæ•°é‡',

  -- é‡‘é¢
  `unit_price` decimal(18,5) COMMENT 'å•ä»·',
  `total_price` decimal(18,5) COMMENT 'æ€»ä»·',

  -- å…³è”å¼•ç”¨
  `procurement_id` bigint COMMENT 'é‡‡è´­å•ID',
  `procurement_product_id` bigint COMMENT 'é‡‡è´­å•†å“ID',
  `order_id` bigint COMMENT 'è®¢å•ID',
  `order_product_id` bigint COMMENT 'è®¢å•å•†å“ID',

  -- æè¿°å’Œæ“ä½œäºº
  `description` text COMMENT 'æè¿°',
  `author` bigint COMMENT 'æ“ä½œäººID',

  `created_at` timestamp,
  `updated_at` timestamp,

  INDEX idx_product (product_id),
  INDEX idx_operation (operation_type),
  INDEX idx_order (order_id),
  INDEX idx_procurement (procurement_id)
) COMMENT='åº“å­˜å˜åŠ¨å†å²';
```

### 5. åº“å­˜è°ƒæ•´å‰ç«¯æ“ä½œ

#### é¡µé¢è·¯å¾„
```
ä»ªè¡¨æ¿ â†’ å•†å“ â†’ åº“å­˜è°ƒæ•´
URL: /dashboard/products/stock-adjustment
æ–‡ä»¶: resources/ts/pages/dashboard/products/ns-stock-adjustment.vue
```

#### æ“ä½œæ­¥éª¤

1. **æœç´¢å•†å“**
   - æ”¯æŒä»é‡‡è´­å†å²ä¸­æœç´¢ï¼ˆç²¾ç¡®è¿½è¸ªå•†å“ï¼‰
   - æ”¯æŒæŒ‰å•†å“åç§°/SKU/æ¡å½¢ç æœç´¢

2. **é€‰æ‹©è°ƒæ•´ç±»å‹**
   - Addedï¼ˆæ·»åŠ ï¼‰- å¢åŠ åº“å­˜
   - Removedï¼ˆç§»é™¤ï¼‰- å‡å°‘åº“å­˜
   - Deletedï¼ˆåˆ é™¤ï¼‰- åˆ é™¤åº“å­˜

3. **å¡«å†™è°ƒæ•´ä¿¡æ¯**
   - é€‰æ‹©å•ä½
   - è¾“å…¥æ•°é‡
   - å¡«å†™åŸå› æè¿°

4. **æäº¤è°ƒæ•´**
   - API: `POST /api/products/adjustments`
   - è‡ªåŠ¨è®°å½•å†å²
   - è§¦å‘ä½åº“å­˜æ£€æŸ¥

---

## é‡‡è´­ç®¡ç†

### 1. é‡‡è´­æµç¨‹

```
åˆ›å»ºé‡‡è´­å• â†’ æ·»åŠ å•†å“ â†’ è®¾ç½®æ•°é‡å’Œä»·æ ¼ â†’ ç¡®è®¤å…¥åº“ â†’ æ›´æ–°åº“å­˜
```

#### é‡‡è´­çŠ¶æ€æµè½¬

```
DRAFT (è‰ç¨¿) â†’ PENDING (å¾…å¤„ç†) â†’ DELIVERED (å·²é€è¾¾) â†’ STOCKED (å·²å…¥åº“)
```

#### æ”¯ä»˜çŠ¶æ€

```
UNPAID (æœªä»˜æ¬¾) â‡„ PAID (å·²ä»˜æ¬¾)
```

### 2. é‡‡è´­å•æ•°æ®ç»“æ„

#### nexopos_procurements è¡¨

```sql
CREATE TABLE `ns_procurements` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `name` varchar(255) NOT NULL COMMENT 'é‡‡è´­å•åç§°',
  `provider_id` bigint NOT NULL COMMENT 'ä¾›åº”å•†ID',

  -- çŠ¶æ€
  `status` enum('DRAFT','PENDING','DELIVERED','STOCKED') DEFAULT 'DRAFT',
  `payment_status` enum('UNPAID','PAID') DEFAULT 'UNPAID',

  -- é‡‘é¢
  `value` decimal(18,5) COMMENT 'æ€»é‡‘é¢',
  `cost` decimal(18,5) COMMENT 'æˆæœ¬',
  `tax_value` decimal(18,5) COMMENT 'ç¨é¢',

  -- å‘ç¥¨ä¿¡æ¯
  `invoice_reference` varchar(255) COMMENT 'å‘ç¥¨å·',
  `delivery_time` datetime COMMENT 'é€è¾¾æ—¶é—´',
  `author` bigint COMMENT 'åˆ›å»ºäºº',

  `created_at` timestamp,
  `updated_at` timestamp
) COMMENT='é‡‡è´­å•ä¸»è¡¨';
```

#### nexopos_procurements_products è¡¨

```sql
CREATE TABLE `ns_procurements_products` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `procurement_id` bigint NOT NULL COMMENT 'é‡‡è´­å•ID',
  `product_id` bigint NOT NULL COMMENT 'å•†å“ID',
  `unit_id` bigint NOT NULL COMMENT 'å•ä½ID',

  -- æ•°é‡
  `quantity` decimal(18,5) COMMENT 'é‡‡è´­æ•°é‡',
  `available_quantity` decimal(18,5) COMMENT 'å‰©ä½™å¯ç”¨æ•°é‡',

  -- ä»·æ ¼
  `purchase_price` decimal(18,5) COMMENT 'é‡‡è´­ä»·',
  `gross_purchase_price` decimal(18,5) COMMENT 'å«ç¨é‡‡è´­ä»·',
  `net_purchase_price` decimal(18,5) COMMENT 'ä¸å«ç¨é‡‡è´­ä»·',
  `total_purchase_price` decimal(18,5) COMMENT 'æ€»é‡‡è´­ä»·',

  -- æ¡å½¢ç ï¼ˆå¯åœ¨é‡‡è´­æ—¶ä¿®æ”¹ï¼‰
  `barcode` varchar(255) COMMENT 'æ¡å½¢ç ',

  -- ä¿è´¨æœŸ
  `expiration_date` datetime COMMENT 'è¿‡æœŸæ—¶é—´',

  -- ç¨åŠ¡
  `tax_group_id` bigint COMMENT 'ç¨ç»„',
  `tax_type` varchar(50) COMMENT 'ç¨ç±»å‹',
  `tax_value` decimal(18,5) COMMENT 'ç¨é¢',

  -- æˆæœ¬
  `cogs` decimal(18,5) COMMENT 'COGS',

  -- å•ä½è½¬æ¢
  `convert_unit_id` bigint COMMENT 'è½¬æ¢å•ä½ID',

  `author` bigint,
  `created_at` timestamp,
  `updated_at` timestamp,

  INDEX idx_procurement (procurement_id),
  INDEX idx_product (product_id)
) COMMENT='é‡‡è´­å•†å“æ˜ç»†';
```

### 3. é‡‡è´­å…¥åº“é€»è¾‘

**æ–‡ä»¶ä½ç½®**: `app/Services/ProcurementService.php`

```php
/**
 * é‡‡è´­å•†å“å…¥åº“ï¼ˆå¢åŠ åº“å­˜ï¼‰
 */
ProcurementService::procurementStockEntry(
    ProcurementProduct $product,
    float $quantity = null
): array

/**
 * é‡‡è´­å•†å“å‡ºåº“ï¼ˆå‡å°‘åº“å­˜ï¼Œç”¨äºä¿®æ­£ï¼‰
 */
ProcurementService::procurementStockOuting(
    ProcurementProduct $product,
    float $quantity = null
): array
```

#### å…¥åº“æµç¨‹

1. **éªŒè¯å•†å“çŠ¶æ€** - æ£€æŸ¥æ˜¯å¦å¯ç”¨åº“å­˜ç®¡ç†
2. **è®¡ç®—æ•°é‡** - å¦‚æœæœªæŒ‡å®šåˆ™ä½¿ç”¨é‡‡è´­æ•°é‡
3. **æ›´æ–°åº“å­˜** - è°ƒç”¨ `ProductService::stockAdjustment()`
4. **è®°å½•å†å²** - æ“ä½œç±»å‹ä¸º `STOCKED`
5. **æ›´æ–° available_quantity** - å‡å°‘å¯ç”¨æ•°é‡
6. **è§¦å‘äº‹ä»¶** - `ProductAfterStockAdjustmentEvent`

### 4. å‰ç«¯é‡‡è´­æ“ä½œ

#### é¡µé¢è·¯å¾„
```
ä»ªè¡¨æ¿ â†’ é‡‡è´­ â†’ åˆ›å»ºé‡‡è´­å•
URL: /dashboard/procurements/create
æ–‡ä»¶: resources/ts/pages/dashboard/procurements/ns-procurement.vue
```

#### æ“ä½œæ­¥éª¤

1. **é€‰æ‹©ä¾›åº”å•†**
2. **æ·»åŠ å•†å“**
   - æ–‡ä»¶: `resources/ts/pages/dashboard/procurements/manage-products.vue`
   - æœç´¢å•†å“ï¼ˆæŒ‰åç§°/SKU/æ¡å½¢ç ï¼‰
   - é€‰æ‹©å•ä½
   - è¾“å…¥æ•°é‡å’Œé‡‡è´­ä»·
   - è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆå¯é€‰ï¼‰

3. **ä¿å­˜é‡‡è´­å•** - çŠ¶æ€ä¸º DRAFT
4. **ç¡®è®¤å…¥åº“** - çŠ¶æ€å˜æ›´ä¸º STOCKED
5. **è‡ªåŠ¨æ›´æ–°åº“å­˜** - è°ƒç”¨å…¥åº“æ–¹æ³•

---

## æ¡å½¢ç ç³»ç»Ÿ

### 1. æ¡å½¢ç æ”¯æŒæ¦‚è¿°

**âœ… NexoPOS åŸç”Ÿæ”¯æŒæ¡å½¢ç æ‰«æå™¨ï¼**

ç³»ç»Ÿæä¾›ä¸¤ç§æ¡å½¢ç æ”¯æŒï¼š
1. **æ ‡å‡†å•†å“æ¡å½¢ç ** - å¸¸è§„å•†å“è¯†åˆ«
2. **ç§°é‡å•†å“æ¡å½¢ç ï¼ˆPLUï¼‰** - ç”µå­ç§¤ç”Ÿæˆçš„å¸¦é‡é‡/ä»·æ ¼çš„æ¡å½¢ç 

### 2. æ”¯æŒçš„æ¡å½¢ç æ ¼å¼

**æ–‡ä»¶ä½ç½®**: `app/Services/BarcodeService.php`

| æ ¼å¼ | å¸¸é‡ | è¯´æ˜ | åº”ç”¨åœºæ™¯ |
|------|------|------|----------|
| **EAN-8** | `BarcodeService::TYPE_EAN8` | 8ä½æ¬§æ´²å•†å“ç¼–ç  | å°åŒ…è£…å•†å“ |
| **EAN-13** | `BarcodeService::TYPE_EAN13` | 13ä½æ¬§æ´²å•†å“ç¼–ç ï¼ˆæœ€å¸¸ç”¨ï¼‰ | é›¶å”®å•†å“ |
| **CODE128** | `BarcodeService::TYPE_CODE128` | é«˜å¯†åº¦æ¡å½¢ç  | ç‰©æµã€ä»“å‚¨ |
| **CODE39** | `BarcodeService::TYPE_CODE39` | 39ç  | å·¥ä¸šåº”ç”¨ |
| **CODE11** | `BarcodeService::TYPE_CODE11` | 11ç  | ç”µä¿¡è¡Œä¸š |
| **UPC-A** | `BarcodeService::TYPE_UPCA` | ç¾å›½é€šç”¨å•†å“ç  | åŒ—ç¾é›¶å”® |
| **UPC-E** | `BarcodeService::TYPE_UPCE` | UPCå‹ç¼©ç‰ˆ | å°åŒ…è£…å•†å“ |
| **CODABAR** | `BarcodeService::TYPE_CODABAR` | åº“å¾·å·´ç  | å›¾ä¹¦é¦†ã€è¡€åº“ |

### 3. æ¡å½¢ç è‡ªåŠ¨ç”Ÿæˆ

#### 3.1 å•†å“æ¡å½¢ç ç”Ÿæˆ

```php
// è‡ªåŠ¨ç”Ÿæˆå”¯ä¸€æ¡å½¢ç 
BarcodeService::generate(string $type): string

// ç”Ÿæˆéšæœºæ¡å½¢ç ï¼ˆéªŒè¯å”¯ä¸€æ€§ï¼‰
BarcodeService::generateRandomBarcode(string $code): string
```

**é€»è¾‘**:
- ä½¿ç”¨ Faker åº“ç”Ÿæˆ EAN ç 
- è‡ªåŠ¨æ£€æŸ¥æ•°æ®åº“é˜²æ­¢é‡å¤
- CODE ç±»å‹ä½¿ç”¨éšæœºå­—ç¬¦ä¸²
- ä¿è¯å…¨å±€å”¯ä¸€æ€§

#### 3.2 å•ä½æ¡å½¢ç ç”Ÿæˆ

æ¯ä¸ªå•†å“çš„æ¯ä¸ªé”€å”®å•ä½éƒ½æœ‰ç‹¬ç«‹æ¡å½¢ç ï¼š

```
æ ¼å¼: {å•†å“æ¡å½¢ç }-{å•ä½æ•°é‡ID}
ç¤ºä¾‹: 12345678-1, 12345678-2
```

å­˜å‚¨ä½ç½®: `ns_products_unit_quantities.barcode`

### 4. ç§°é‡å•†å“æ¡å½¢ç ï¼ˆPLUï¼‰

#### 4.1 PLU ç ç»“æ„

ç”µå­ç§¤ç”Ÿæˆçš„æ¡å½¢ç åŒ…å«å•†å“ä»£ç å’Œé‡é‡/ä»·æ ¼ä¿¡æ¯ã€‚

**æ ‡å‡†æ ¼å¼** (EAN-13):
```
[å‰ç¼€][å•†å“ä»£ç ][æ•°å€¼][æ ¡éªŒä½]
 2     12345     01500   3

ç¤ºä¾‹: 2123450150003
- å‰ç¼€: 2 (å¯é…ç½®)
- å•†å“ä»£ç : 12345 (PLU)
- æ•°å€¼: 01500 (é‡é‡1.5kg æˆ– ä»·æ ¼15.00å…ƒ)
- æ ¡éªŒä½: 3 (EAN-13æ ¡éªŒç )
```

#### 4.2 é…ç½®é¡¹

**é…ç½®ä½ç½®**: `è®¾ç½® â†’ POS â†’ Scale Barcode`
**é…ç½®æ–‡ä»¶**: `app/Settings/pos/scale-barcode.php`

| é…ç½®é¡¹ | é€‰é¡¹é”® | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|--------|------|
| **å¯ç”¨çŠ¶æ€** | `ns_scale_barcode_enabled` | `no` | æ˜¯å¦å¯ç”¨ç§°é‡æ¡å½¢ç  |
| **å‰ç¼€** | `ns_scale_barcode_prefix` | `2` | æ¡å½¢ç å‰ç¼€ï¼ˆé€šå¸¸ä¸º2æˆ–21-29ï¼‰ |
| **ç±»å‹** | `ns_scale_barcode_type` | `weight` | `weight`ï¼ˆé‡é‡ï¼‰æˆ– `price`ï¼ˆä»·æ ¼ï¼‰ |
| **å•†å“ä»£ç é•¿åº¦** | `ns_scale_barcode_product_length` | `5` | PLUç ä½æ•° |
| **æ•°å€¼é•¿åº¦** | `ns_scale_barcode_value_length` | `5` | é‡é‡/ä»·æ ¼ä½æ•° |

#### 4.3 PLU æ ¸å¿ƒæ–¹æ³•

**æ–‡ä»¶ä½ç½®**: `app/Services/ProductService.php`

```php
/**
 * æ£€æŸ¥æ˜¯å¦ä¸ºç§°é‡æ¡å½¢ç 
 */
ProductService::isScaleBarcode(string $barcode): bool

/**
 * è§£æç§°é‡æ¡å½¢ç 
 *
 * @return array{
 *   product_code: string,  // PLUç 
 *   value: float,          // é‡é‡(kg)æˆ–ä»·æ ¼(å…ƒ)
 *   type: string,          // 'weight' æˆ– 'price'
 *   original_barcode: string
 * }
 */
ProductService::parseScaleBarcode(string $barcode): array

/**
 * ä¸ºå•†å“å•ä½ç”ŸæˆPLUç 
 */
ProductService::generateScalePLU(int $productId, int $unitQuantityId): string

/**
 * éªŒè¯PLUå”¯ä¸€æ€§
 */
ProductService::isPLUUnique(string $plu): bool
```

#### 4.4 ç§°é‡å•†å“è®¾ç½®

åœ¨å•†å“å•ä½é…ç½®ä¸­ï¼š
- `is_weighable` = 1 - æ ‡è®°ä¸ºç§°é‡å•†å“
- `scale_plu` - å­˜å‚¨ç”Ÿæˆçš„PLUç ï¼ˆ5ä½æ•°å­—ï¼‰

å­˜å‚¨åœ¨ `ns_products_unit_quantities` è¡¨ã€‚

### 5. POS æ¡å½¢ç æ‰«æåŠŸèƒ½

#### 5.1 å‰ç«¯é¡µé¢

**æ–‡ä»¶ä½ç½®**: `resources/ts/pages/dashboard/pos/ns-pos-grid.vue`

#### 5.2 æ¡å½¢ç è¾“å…¥æ¡†

```vue
<!-- ç¬¬ 23 è¡Œ -->
<input
  ref="search"
  v-model="barcode"
  type="text"
  class="flex-auto outline-hidden px-2"
>
```

#### 5.3 è‡ªåŠ¨èšç„¦æŒ‰é’®

```vue
<!-- ç¬¬ 20-22 è¡Œ -->
<button
  :title="__( 'Toggle auto focus.' )"
  @click="options.ns_pos_force_autofocus = ! options.ns_pos_force_autofocus"
  :class="options.ns_pos_force_autofocus ? 'pos-button-clicked' : ''"
  class="outline-hidden w-10 h-10 border-r"
>
  <i class="las la-barcode"></i>
</button>
```

**åŠŸèƒ½**:
- ç‚¹å‡»åˆ‡æ¢è‡ªåŠ¨èšç„¦çŠ¶æ€
- å¯ç”¨åæ¯ 500ms è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
- æ— å¼¹çª—æ—¶è‡ªåŠ¨èšç„¦ï¼Œç¡®ä¿æ‰«ææªè¾“å…¥

#### 5.4 æ¡å½¢ç æœç´¢é€»è¾‘

**Watch ç›‘å¬** (ç¬¬ 158-166 è¡Œ):
```javascript
watch: {
  barcode() {
    if (this.options.ns_pos_force_autofocus) {
      clearTimeout(this.searchTimeout);

      // 200ms é˜²æŠ–
      this.searchTimeout = setTimeout(() => {
        this.submitSearch(this.barcode);
      }, 200);
    }
  }
}
```

**æœç´¢æ–¹æ³•** (ç¬¬ 321-388 è¡Œ):
```javascript
submitSearch(value) {
  if (value.length > 0) {
    // API è¯·æ±‚
    const url = `/api/products/search/using-barcode/${value}`;

    nsHttpClient.get(url).subscribe({
      next: result => {
        // æ¸…ç©ºè¾“å…¥æ¡†
        this.barcode = '';

        // æ„å»ºå•†å“å¯¹è±¡
        const product = {
          name: result.product.name,
          id: result.product.id,
          unit_id: result.unit.id,
          unit_price: result.unitQuantity.sale_price,
          // ... å…¶ä»–å­—æ®µ
        };

        // å¤„ç†ç§°é‡æ¡å½¢ç 
        if (result.scale) {
          const scaleData = result.scale;

          if (scaleData.type === 'weight') {
            // è®¾ç½®é‡é‡
            product.quantity = scaleData.value;

            nsSnackBar.info(
              __('Scale barcode detected: {weight} {unit}')
                .replace('{weight}', scaleData.value.toFixed(3))
                .replace('{unit}', scaleData.unit?.name || 'kg')
            );
          } else if (scaleData.type === 'price') {
            // æ ¹æ®ä»·æ ¼è®¡ç®—æ•°é‡
            const unitPrice = result.unitQuantity.sale_price;
            if (unitPrice > 0) {
              product.quantity = scaleData.value / unitPrice;
            }

            nsSnackBar.info(
              __('Scale barcode detected: {price}')
                .replace('{price}', nsCurrency(scaleData.value))
            );
          }
        }

        // æ·»åŠ åˆ°è´­ç‰©è½¦
        POS.addToCart(product);
      },
      error: (error) => {
        this.barcode = '';
        nsSnackBar.error(error.message);
      }
    });
  }
}
```

### 6. åç«¯æ¡å½¢ç æœç´¢ API

**æ–‡ä»¶ä½ç½®**: `app/Http/Controllers/Dashboard/ProductsController.php`

**è·¯ç”±**: `GET /api/products/search/using-barcode/{barcode}`

**æ–¹æ³•**: `searchUsingArgument($reference)` (ç¬¬ 531-639 è¡Œ)

#### æœç´¢é€»è¾‘æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¥æ”¶æ¡å½¢ç  $reference                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ£€æŸ¥æ˜¯å¦ä¸ºç§°é‡æ¡å½¢ç ?                 â”‚
â”‚  ProductService::isScaleBarcode()   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ æ˜¯                 â”‚ å¦
          â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è§£æç§°é‡æ¡å½¢ç          â”‚  â”‚ æŒ‰æ¡å½¢ç æŸ¥è¯¢å•†å“       â”‚
â”‚ parseScaleBarcode()  â”‚  â”‚ 1. é‡‡è´­å•†å“æ¡å½¢ç      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ 2. å•ä½æ¡å½¢ç          â”‚
          â”‚               â”‚ 3. å•†å“ä¸»æ¡å½¢ç        â”‚
          â–¼               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚ æå–PLUç              â”‚            â”‚
â”‚ scale_plu = 12345    â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
          â”‚                         â”‚
          â–¼                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚ æŸ¥è¯¢å•ä½æ•°é‡è¡¨         â”‚            â”‚
â”‚ WHERE scale_plu=12345â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
          â”‚                         â”‚
          â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿”å›ç»“æœ                             â”‚
â”‚  - product: å•†å“ä¿¡æ¯                  â”‚
â”‚  - unit: å•ä½ä¿¡æ¯                     â”‚
â”‚  - unitQuantity: åº“å­˜å’Œä»·æ ¼            â”‚
â”‚  - scale: ç§°é‡æ•°æ®ï¼ˆå¦‚æœæœ‰ï¼‰           â”‚
â”‚    - product_code: PLU               â”‚
â”‚    - value: é‡é‡/ä»·æ ¼                 â”‚
â”‚    - type: weight/price              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ä»£ç å®ç° (ç®€åŒ–ç‰ˆ)

```php
public function searchUsingArgument($reference)
{
    // 1. æ£€æŸ¥æ˜¯å¦ä¸ºç§°é‡æ¡å½¢ç 
    if ($this->productService->isScaleBarcode($reference)) {
        try {
            // è§£ææ¡å½¢ç 
            $scaleData = $this->productService->parseScaleBarcode($reference);
            $plu = $scaleData['product_code'];

            // æŸ¥è¯¢PLU
            $unitQuantity = ProductUnitQuantity::where('scale_plu', $plu)
                ->with('product', 'unit')
                ->first();

            if ($unitQuantity && $unitQuantity->product) {
                $product = Product::find($unitQuantity->product_id);
                $product->load('unit_quantities.unit', 'tax_group.taxes');

                return [
                    'type' => 'product',
                    'unit' => $unitQuantity->unit,
                    'unitQuantity' => $unitQuantity,
                    'product' => $product->toArray(),
                    'scale' => $scaleData  // åŒ…å«é‡é‡/ä»·æ ¼ä¿¡æ¯
                ];
            }

            throw new NotFoundException("No product found with PLU: {$plu}");
        } catch (Exception $e) {
            throw $e;
        }
    }

    // 2. å¸¸è§„æ¡å½¢ç æŸ¥è¯¢
    // 2.1 æŸ¥è¯¢é‡‡è´­å•†å“æ¡å½¢ç 
    $procurementProduct = ProcurementProduct::barcode($reference)->first();

    // 2.2 æŸ¥è¯¢å•ä½æ¡å½¢ç 
    $productUnitQuantity = ProductUnitQuantity::barcode($reference)
        ->with('unit')
        ->first();

    // 2.3 æŸ¥è¯¢å•†å“ä¸»æ¡å½¢ç 
    $product = Product::barcode($reference)
        ->onSale()
        ->first();

    // 3. è¿”å›æŸ¥è¯¢ç»“æœ
    if ($procurementProduct instanceof ProcurementProduct) {
        $product = $procurementProduct->product;
        $product->load('tax_group.taxes');

        // æ£€æŸ¥è¿‡æœŸå•†å“
        if ($this->dateService->copy()->greaterThan($procurementProduct->expiration_date)
            && $product->expires
            && $product->on_expiration === Product::EXPIRES_PREVENT_SALES) {
            throw new NotAllowedException('å•†å“å·²è¿‡æœŸï¼Œæ— æ³•é”€å”®');
        }

        $product->procurement_product_id = $procurementProduct->id;
    } elseif ($productUnitQuantity instanceof ProductUnitQuantity) {
        $productUnitQuantity->load('unit');
        $product = Product::find($productUnitQuantity->product_id);
        $product->load('unit_quantities.unit', 'tax_group.taxes');
        $product->selectedUnitQuantity = $productUnitQuantity;
    } elseif ($product instanceof Product) {
        $product->load('unit_quantities', 'tax_group.taxes');
    } else {
        throw new NotFoundException("æ‰¾ä¸åˆ°æ¡å½¢ç å¯¹åº”çš„å•†å“");
    }

    // è·å–é»˜è®¤å•ä½
    $unit = $product->selectedUnitQuantity->unit ?? $product->unit_quantities[0]->unit;
    $unitQuantity = $product->selectedUnitQuantity ?? $product->unit_quantities[0];

    return [
        'type' => 'product',
        'unit' => $unit,
        'unitQuantity' => $unitQuantity,
        'product' => $product->toArray(),
    ];
}
```

### 7. æ¡å½¢ç æ‰«æå™¨ç¡¬ä»¶å¯¹æ¥

#### 7.1 å…¼å®¹çš„æ‰«æå™¨ç±»å‹

âœ… **USB æ¥å£æ‰«ææª**ï¼ˆæ¨èï¼‰
- å³æ’å³ç”¨ï¼Œæ¨¡æ‹Ÿé”®ç›˜è¾“å…¥
- æ— éœ€é©±åŠ¨å’Œé¢å¤–é…ç½®
- æ‰«æåè‡ªåŠ¨å›è½¦

âœ… **è“ç‰™æ‰«ææª**
- æ— çº¿æ“ä½œï¼Œæ–¹ä¾¿ç§»åŠ¨
- é…å¯¹åæ¨¡æ‹Ÿé”®ç›˜è¾“å…¥
- å»ºè®®é…ç½®è‡ªåŠ¨å›è½¦

âœ… **æ‰‹æœºæ‰«æ App**
- é€šè¿‡æµè§ˆå™¨è®¿é—® POS é¡µé¢
- ä½¿ç”¨æ‰‹æœºæ‘„åƒå¤´æ‰«æ
- é€‚åˆä¸´æ—¶æˆ–ä½æˆæœ¬æ–¹æ¡ˆ

âŒ **ä¸æ”¯æŒ**: RS232 ä¸²å£æ‰«æå™¨ï¼ˆéœ€è¦é¢å¤–å¼€å‘ï¼‰

#### 7.2 æ‰«æå™¨é…ç½®å»ºè®®

**æ¨èè®¾ç½®**:
1. **åç¼€è®¾ç½®** - é…ç½®æ‰«æåè‡ªåŠ¨å‘é€ `Enter` é”®
2. **å‰ç¼€è®¾ç½®** - æ— éœ€å‰ç¼€ï¼ˆä¿æŒé»˜è®¤ï¼‰
3. **æ‰«ææ¨¡å¼** - è¿ç»­æ‰«ææ¨¡å¼
4. **èœ‚é¸£å£°** - å¼€å¯ï¼ˆç¡®è®¤æ‰«ææˆåŠŸï¼‰
5. **æ‰«æé€Ÿåº¦** - å¿«é€Ÿæ¨¡å¼

**æµ‹è¯•æ–¹æ³•**:
1. æ‰“å¼€è®°äº‹æœ¬æˆ–æ–‡æœ¬ç¼–è¾‘å™¨
2. æ‰«ææ¡å½¢ç 
3. ç¡®è®¤æ˜¾ç¤ºå®Œæ•´æ¡å½¢ç  + è‡ªåŠ¨æ¢è¡Œ
4. å¦‚æœæˆåŠŸï¼Œå³å¯åœ¨ NexoPOS ä¸­ä½¿ç”¨

#### 7.3 POS ä½¿ç”¨æµç¨‹

1. **æ‰“å¼€ POS é¡µé¢**
   ```
   URL: /pos
   æˆ–: ä»ªè¡¨æ¿ â†’ POS
   ```

2. **å¯ç”¨è‡ªåŠ¨èšç„¦**
   - ç‚¹å‡»æ¡å½¢ç å›¾æ ‡æŒ‰é’®ï¼ˆå˜è“è‰²è¡¨ç¤ºå·²å¯ç”¨ï¼‰
   - ç³»ç»Ÿæ¯ 500ms è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†

3. **æ‰«æå•†å“**
   - ç›´æ¥ç”¨æ‰«ææªæ‰«æå•†å“æ¡å½¢ç 
   - ç³»ç»Ÿè‡ªåŠ¨æœç´¢å•†å“ï¼ˆ200ms é˜²æŠ–ï¼‰
   - æ‰¾åˆ°å•†å“åè‡ªåŠ¨æ·»åŠ åˆ°è´­ç‰©è½¦

4. **ç§°é‡å•†å“å¤„ç†**
   - æ‰«æç”µå­ç§¤ç”Ÿæˆçš„æ¡å½¢ç 
   - ç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«å¹¶æå–é‡é‡/ä»·æ ¼
   - è‡ªåŠ¨è®¾ç½®å•†å“æ•°é‡
   - æ˜¾ç¤ºæç¤ºä¿¡æ¯ï¼ˆå¦‚ "ç§°é‡æ¡å½¢ç ï¼š1.500 kg"ï¼‰

5. **å®Œæˆé”€å”®**
   - ç»§ç»­æ‰«æå…¶ä»–å•†å“
   - ç‚¹å‡»"è´­ç‰©è½¦"æŸ¥çœ‹å·²æ·»åŠ å•†å“
   - é€‰æ‹©æ”¯ä»˜æ–¹å¼å®Œæˆäº¤æ˜“

### 8. æ¡å½¢ç æ ‡ç­¾æ‰“å°

#### 8.1 æ‰“å°é¡µé¢

**æ–‡ä»¶ä½ç½®**: `resources/ts/pages/dashboard/products/ns-print-label.vue`

**è®¿é—®è·¯å¾„**: `ä»ªè¡¨æ¿ â†’ å•†å“ â†’ æ‰“å°æ ‡ç­¾`

#### 8.2 åŠŸèƒ½ç‰¹æ€§

- æ‰¹é‡æ‰“å°å•†å“æ¡å½¢ç æ ‡ç­¾
- å¯è‡ªå®šä¹‰æ ‡ç­¾æ¨¡æ¿
- æ”¯æŒé…ç½®æ ‡ç­¾å°ºå¯¸
- å¯åŒ…å«å•†å“åç§°ã€ä»·æ ¼ã€SKU

#### 8.3 æ ‡ç­¾è®¾ç½®é¡µé¢

**æ–‡ä»¶ä½ç½®**: `resources/ts/pages/dashboard/products/ns-print-label-settings.vue`

**é…ç½®é¡¹**:
- æ ‡ç­¾å®½åº¦å’Œé«˜åº¦
- æ¡å½¢ç é«˜åº¦
- æ–‡å­—å­—ä½“å’Œå¤§å°
- æ˜¯å¦æ˜¾ç¤ºä»·æ ¼

---

## å‰ç«¯æ“ä½œæŒ‡å—

### 1. å•†å“ç®¡ç†é¡µé¢

#### 1.1 å•†å“åˆ—è¡¨

**è·¯å¾„**: `ä»ªè¡¨æ¿ â†’ å•†å“ â†’ æ‰€æœ‰å•†å“`
**URL**: `/dashboard/products`

**åŠŸèƒ½**:
- æŸ¥çœ‹æ‰€æœ‰å•†å“
- æœç´¢å•†å“ï¼ˆåç§°/SKU/æ¡å½¢ç ï¼‰
- ç¼–è¾‘å•†å“
- åˆ é™¤å•†å“
- æŸ¥çœ‹åº“å­˜çŠ¶æ€

#### 1.2 åˆ›å»ºå•†å“

**è·¯å¾„**: `ä»ªè¡¨æ¿ â†’ å•†å“ â†’ åˆ›å»ºå•†å“`
**URL**: `/dashboard/products/create`
**æ–‡ä»¶**: `resources/ts/pages/dashboard/products/create.vue`

**è¡¨å•åˆ†ç»„**:
1. **åŸºæœ¬ä¿¡æ¯** - åç§°ã€ç±»å‹ã€åˆ†ç±»ã€æ¡å½¢ç 
2. **åº“å­˜é…ç½®** - åº“å­˜ç®¡ç†ã€ç²¾ç¡®è¿½è¸ªã€ä½åº“å­˜è­¦æŠ¥
3. **å•ä½å’Œä»·æ ¼** - é”€å”®å•ä½ã€ä»·æ ¼ã€æˆæœ¬
4. **ç¨åŠ¡é…ç½®** - ç¨ç»„ã€ç¨ç‡ã€ç¨ç±»å‹
5. **å›¾ç‰‡** - å•†å“å›¾åº“
6. **æè¿°** - è¯¦ç»†æè¿°å’Œè¯´æ˜

#### 1.3 åº“å­˜è°ƒæ•´

**è·¯å¾„**: `ä»ªè¡¨æ¿ â†’ å•†å“ â†’ åº“å­˜è°ƒæ•´`
**URL**: `/dashboard/products/stock-adjustment`
**æ–‡ä»¶**: `resources/ts/pages/dashboard/products/ns-stock-adjustment.vue`

**æ“ä½œæ­¥éª¤**:
1. æœç´¢å•†å“ï¼ˆæ”¯æŒé‡‡è´­å†å²ï¼‰
2. é€‰æ‹©è°ƒæ•´ç±»å‹ï¼ˆAdded/Removed/Deletedï¼‰
3. é€‰æ‹©å•ä½
4. è¾“å…¥æ•°é‡
5. å¡«å†™åŸå› 
6. æäº¤è°ƒæ•´

### 2. é‡‡è´­ç®¡ç†é¡µé¢

#### 2.1 é‡‡è´­åˆ—è¡¨

**è·¯å¾„**: `ä»ªè¡¨æ¿ â†’ é‡‡è´­ â†’ æ‰€æœ‰é‡‡è´­`
**URL**: `/dashboard/procurements`

#### 2.2 åˆ›å»ºé‡‡è´­å•

**è·¯å¾„**: `ä»ªè¡¨æ¿ â†’ é‡‡è´­ â†’ åˆ›å»ºé‡‡è´­`
**URL**: `/dashboard/procurements/create`
**æ–‡ä»¶**: `resources/ts/pages/dashboard/procurements/ns-procurement.vue`

**æ“ä½œæµç¨‹**:
1. é€‰æ‹©ä¾›åº”å•†
2. è¾“å…¥é‡‡è´­å•åç§°
3. æ·»åŠ å•†å“
   - æ–‡ä»¶: `resources/ts/pages/dashboard/procurements/manage-products.vue`
   - æœç´¢å•†å“
   - é€‰æ‹©å•ä½
   - è¾“å…¥æ•°é‡å’Œé‡‡è´­ä»·
   - è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆå¯é€‰ï¼‰
4. ä¿å­˜ä¸ºè‰ç¨¿æˆ–ç›´æ¥å…¥åº“

### 3. POS æ”¶é“¶é¡µé¢

#### 3.1 POS ä¸»ç•Œé¢

**è·¯å¾„**: `ä»ªè¡¨æ¿ â†’ POS`
**URL**: `/dashboard/pos` ï¼ˆéœ€è¦ç™»å½•ï¼‰
**ä¸»æ–‡ä»¶**: `resources/ts/pos.ts`

**ç»„ä»¶ç»“æ„**:
```
ns-pos (å®¹å™¨)
â”œâ”€â”€ ns-pos-grid (å•†å“ç½‘æ ¼)
â”‚   â”œâ”€â”€ æ¡å½¢ç è¾“å…¥æ¡†
â”‚   â”œâ”€â”€ è‡ªåŠ¨èšç„¦æŒ‰é’®
â”‚   â”œâ”€â”€ åˆ†ç±»æµè§ˆ
â”‚   â””â”€â”€ å•†å“å±•ç¤º
â”œâ”€â”€ ns-pos-cart (è´­ç‰©è½¦)
â”‚   â”œâ”€â”€ å•†å“åˆ—è¡¨
â”‚   â”œâ”€â”€ æ•°é‡è°ƒæ•´
â”‚   â”œâ”€â”€ ä»·æ ¼æ˜¾ç¤º
â”‚   â””â”€â”€ å°è®¡
â””â”€â”€ ns-pos-payment (æ”¯ä»˜)
    â”œâ”€â”€ æ”¯ä»˜æ–¹å¼é€‰æ‹©
    â”œâ”€â”€ é‡‘é¢è¾“å…¥
    â””â”€â”€ æ‰¾é›¶è®¡ç®—
```

#### 3.2 å•†å“æœç´¢å¼¹çª—

**æ–‡ä»¶**: `resources/ts/popups/ns-pos-search-product.vue`

**è§¦å‘æ–¹å¼**:
- ç‚¹å‡»æœç´¢æŒ‰é’®
- å¿«æ·é”®ï¼ˆå¯é…ç½®ï¼‰

**æœç´¢åŠŸèƒ½**:
- æŒ‰åç§°æœç´¢
- æŒ‰ SKU æœç´¢
- æŒ‰æ¡å½¢ç æœç´¢
- å®æ—¶æœç´¢ï¼ˆ500ms é˜²æŠ–ï¼‰
- å•ç»“æœè‡ªåŠ¨é€‰æ‹©

#### 3.3 è´­ç‰©è½¦æ“ä½œ

**æ–‡ä»¶**: `resources/ts/pages/dashboard/pos/ns-pos-cart.vue`

**åŠŸèƒ½**:
- æŸ¥çœ‹å·²æ·»åŠ å•†å“
- è°ƒæ•´å•†å“æ•°é‡
- åˆ é™¤å•†å“
- åº”ç”¨æŠ˜æ‰£/ä¼˜æƒ åˆ¸
- è®¡ç®—æ€»ä»·å’Œç¨é¢

### 4. æŠ¥è¡¨é¡µé¢

#### 4.1 åº“å­˜æŠ¥è¡¨

**è·¯å¾„**: `ä»ªè¡¨æ¿ â†’ æŠ¥è¡¨ â†’ åº“å­˜æŠ¥è¡¨`
**æ–‡ä»¶**: `resources/ts/pages/dashboard/reports/ns-stock-report.vue`

**å†…å®¹**:
- å½“å‰åº“å­˜é‡
- åº“å­˜ä»·å€¼
- æŒ‰åˆ†ç±»ç»Ÿè®¡
- æŒ‰å•ä½ç»Ÿè®¡

#### 4.2 ä½åº“å­˜æŠ¥è¡¨

**è·¯å¾„**: `ä»ªè¡¨æ¿ â†’ æŠ¥è¡¨ â†’ ä½åº“å­˜æŠ¥è¡¨`
**æ–‡ä»¶**: `resources/ts/pages/dashboard/reports/ns-low-stock-report.vue`

**å†…å®¹**:
- ä½äºé˜ˆå€¼çš„å•†å“
- åº“å­˜é¢„è­¦åˆ—è¡¨
- å»ºè®®é‡‡è´­æ•°é‡

#### 4.3 é”€å”®åº“å­˜æŠ¥è¡¨

**è·¯å¾„**: `ä»ªè¡¨æ¿ â†’ æŠ¥è¡¨ â†’ é”€å”®åº“å­˜æŠ¥è¡¨`
**æ–‡ä»¶**: `resources/ts/pages/dashboard/reports/ns-sold-stock-report.vue`

**å†…å®¹**:
- å·²é”€å”®å•†å“
- é”€å”®æ•°é‡å’Œé‡‘é¢
- æŒ‰æ—¶é—´æ®µç»Ÿè®¡

#### 4.4 ç»¼åˆåº“å­˜æŠ¥è¡¨

**è·¯å¾„**: `ä»ªè¡¨æ¿ â†’ æŠ¥è¡¨ â†’ ç»¼åˆåº“å­˜æŠ¥è¡¨`
**æ–‡ä»¶**: `resources/ts/pages/dashboard/reports/ns-stock-combined-report.vue`

**å†…å®¹**:
- åº“å­˜æµæ°´æ±‡æ€»
- å…¥åº“/å‡ºåº“ç»Ÿè®¡
- åº“å­˜å‘¨è½¬ç‡

---

## API æ¥å£è¯´æ˜

### 1. å•†å“ç›¸å…³ API

**è·¯ç”±æ–‡ä»¶**: `routes/api/products.php`

#### 1.1 å•†å“ CRUD

```http
# è·å–å•†å“åˆ—è¡¨
GET /api/products
Query: ?page=1&per_page=20&search=å…³é”®è¯

# è·å–å•ä¸ªå•†å“
GET /api/products/{id}
Response: åŒ…å« unit_quantities, category, tax_group

# åˆ›å»ºå•†å“
POST /api/products
Body: {
  "name": "å•†å“åç§°",
  "type": "materialized",
  "category_id": 1,
  "unit_group": 1,
  "units": [
    {
      "unit_id": 1,
      "sale_price": 100,
      "quantity": 0
    }
  ]
}

# æ›´æ–°å•†å“
PUT /api/products/{id}
Body: åŒåˆ›å»ºå•†å“

# åˆ é™¤å•†å“
DELETE /api/products/{id}
```

#### 1.2 å•†å“æœç´¢

```http
# æŒ‰æ¡å½¢ç æœç´¢ï¼ˆæ ¸å¿ƒ APIï¼‰
GET /api/products/search/using-barcode/{barcode}
Response: {
  "type": "product",
  "product": {...},
  "unit": {...},
  "unitQuantity": {...},
  "scale": {              // ä»…ç§°é‡æ¡å½¢ç è¿”å›
    "product_code": "12345",
    "value": 1.5,
    "type": "weight",
    "original_barcode": "2123450150003"
  }
}

# é€šç”¨æœç´¢
POST /api/products/search
Body: {
  "search": "å…³é”®è¯",      // æœç´¢åç§°/SKU/æ¡å½¢ç 
  "category_id": 1,       // å¯é€‰
  "limit": 20
}
```

#### 1.3 åº“å­˜æ“ä½œ

```http
# åº“å­˜è°ƒæ•´
POST /api/products/adjustments
Body: {
  "products": [
    {
      "id": 123,
      "adjust_action": "added",  // added/removed/deleted
      "adjust_quantity": 10,
      "adjust_unit": {
        "unit_id": 1,
        "sale_price": 100
      },
      "adjust_reason": "é‡‡è´­å…¥åº“",
      "procurement_product_id": 789  // å¯é€‰
    }
  ]
}

# è·å–åº“å­˜å•ä½
GET /api/products/{id}/units/quantities
Response: [
  {
    "id": 1,
    "unit_id": 1,
    "quantity": 100,
    "sale_price": 50,
    "barcode": "12345678-1",
    "scale_plu": "12345"
  }
]

# è·å–åº“å­˜å†å²
GET /api/products/{id}/history
Query: ?page=1&per_page=20
Response: åˆ†é¡µçš„å†å²è®°å½•åˆ—è¡¨
```

#### 1.4 å•ä½è½¬æ¢

```http
# å•ä½è½¬æ¢
POST /api/products/{product}/units/conversion
Body: {
  "from_unit_id": 1,
  "to_unit_id": 2,
  "quantity": 10
}
```

### 2. é‡‡è´­ç›¸å…³ API

**è·¯ç”±æ–‡ä»¶**: `routes/api/procurements.php`

#### 2.1 é‡‡è´­å• CRUD

```http
# è·å–é‡‡è´­å•åˆ—è¡¨
GET /api/procurements
Query: ?page=1&status=PENDING

# è·å–å•ä¸ªé‡‡è´­å•
GET /api/procurements/{id}

# åˆ›å»ºé‡‡è´­å•
POST /api/procurements
Body: {
  "name": "é‡‡è´­å•åç§°",
  "provider_id": 1,
  "invoice_reference": "INV-001",
  "products": [
    {
      "product_id": 123,
      "unit_id": 1,
      "quantity": 100,
      "purchase_price": 50,
      "expiration_date": "2026-12-31"
    }
  ]
}

# æ›´æ–°é‡‡è´­å•
PUT /api/procurements/{id}
Body: åŒåˆ›å»º

# åˆ é™¤é‡‡è´­å•
DELETE /api/procurements/{id}
```

#### 2.2 é‡‡è´­å•†å“æ“ä½œ

```http
# è·å–é‡‡è´­å•†å“
GET /api/procurements/{id}/products

# æ·»åŠ å•†å“åˆ°é‡‡è´­å•
POST /api/procurements/{id}/products
Body: {
  "products": [...]
}

# æœç´¢é‡‡è´­å•†å“ï¼ˆç”¨äºåº“å­˜è°ƒæ•´ï¼‰
POST /api/procurements/products/search-procurement-product
Body: {
  "search": "å…³é”®è¯",
  "procurement_id": 1  // å¯é€‰
}
```

### 3. åˆ†ç±»ç›¸å…³ API

```http
# POS åˆ†ç±»å’Œå•†å“
GET /api/categories/pos/{parent_id?}
Response: {
  "categories": [...],
  "products": [...],
  "previousCategory": {...},
  "currentCategory": {...}
}

# è·å–æ‰€æœ‰åˆ†ç±»
GET /api/categories
```

### 4. CRUD è¡¨å•é…ç½® API

```http
# è·å–å•†å“åˆ›å»ºè¡¨å•é…ç½®
GET /api/crud/ns.products/form-config

# è·å–å•†å“åˆ—è¡¨é…ç½®
GET /api/crud/ns.products/config

# è·å–å•†å“æ•°æ®ï¼ˆåˆ†é¡µï¼‰
GET /api/crud/ns.products?page=1&per_page=20
```

### 5. å“åº”æ ¼å¼

#### æˆåŠŸå“åº”

```json
{
  "status": "success",
  "message": "æ“ä½œæˆåŠŸ",
  "data": {...}
}
```

#### é”™è¯¯å“åº”

```json
{
  "status": "error",
  "message": "é”™è¯¯ä¿¡æ¯",
  "errors": {
    "field_name": ["éªŒè¯é”™è¯¯"]
  }
}
```

#### åˆ†é¡µå“åº”

```json
{
  "data": [...],
  "current_page": 1,
  "last_page": 10,
  "per_page": 20,
  "total": 200
}
```

---

## æ•°æ®åº“ç»“æ„

### 1. æ ¸å¿ƒè¡¨å…³ç³»å›¾

```
ns_products (å•†å“ä¸»è¡¨)
    â”‚
    â”œâ”€â”€â”€ 1:N â”€â”€â†’ ns_products_unit_quantities (åº“å­˜/ä»·æ ¼)
    â”‚                 â”‚
    â”‚                 â””â”€â”€â”€ N:1 â”€â”€â†’ ns_units (å•ä½)
    â”‚
    â”œâ”€â”€â”€ 1:N â”€â”€â†’ ns_products_histories (å†å²è®°å½•)
    â”‚
    â”œâ”€â”€â”€ 1:N â”€â”€â†’ ns_products_gallery (å›¾ç‰‡)
    â”‚
    â”œâ”€â”€â”€ 1:N â”€â”€â†’ ns_products_taxes (ç¨åŠ¡)
    â”‚
    â”œâ”€â”€â”€ N:1 â”€â”€â†’ ns_products_categories (åˆ†ç±»)
    â”‚
    â”œâ”€â”€â”€ N:1 â”€â”€â†’ ns_tax_groups (ç¨ç»„)
    â”‚
    â””â”€â”€â”€ N:1 â”€â”€â†’ ns_unit_groups (å•ä½ç»„)

ns_procurements (é‡‡è´­å•)
    â”‚
    â””â”€â”€â”€ 1:N â”€â”€â†’ ns_procurements_products (é‡‡è´­å•†å“)
                      â”‚
                      â”œâ”€â”€â”€ N:1 â”€â”€â†’ ns_products
                      â”‚
                      â””â”€â”€â”€ N:1 â”€â”€â†’ ns_units
```

### 2. ç´¢å¼•ä¼˜åŒ–å»ºè®®

**é«˜é¢‘æŸ¥è¯¢å­—æ®µ**:
```sql
-- å•†å“è¡¨ç´¢å¼•
CREATE INDEX idx_products_barcode ON ns_products(barcode);
CREATE INDEX idx_products_sku ON ns_products(sku);
CREATE INDEX idx_products_category ON ns_products(category_id);
CREATE INDEX idx_products_status ON ns_products(status);
CREATE INDEX idx_products_type ON ns_products(type, product_type);

-- åº“å­˜è¡¨ç´¢å¼•
CREATE INDEX idx_unit_qty_barcode ON ns_products_unit_quantities(barcode);
CREATE INDEX idx_unit_qty_plu ON ns_products_unit_quantities(scale_plu);
CREATE UNIQUE INDEX idx_unit_qty_unique ON ns_products_unit_quantities(product_id, unit_id);

-- å†å²è¡¨ç´¢å¼•
CREATE INDEX idx_history_product ON ns_products_histories(product_id);
CREATE INDEX idx_history_operation ON ns_products_histories(operation_type);
CREATE INDEX idx_history_order ON ns_products_histories(order_id);
CREATE INDEX idx_history_procurement ON ns_products_histories(procurement_id);
CREATE INDEX idx_history_created ON ns_products_histories(created_at);
```

### 3. æ•°æ®å®Œæ•´æ€§çº¦æŸ

```sql
-- å¤–é”®çº¦æŸï¼ˆå¦‚æœå¯ç”¨ï¼‰
ALTER TABLE ns_products_unit_quantities
  ADD CONSTRAINT fk_puq_product
  FOREIGN KEY (product_id) REFERENCES ns_products(id) ON DELETE CASCADE;

ALTER TABLE ns_products_histories
  ADD CONSTRAINT fk_ph_product
  FOREIGN KEY (product_id) REFERENCES ns_products(id) ON DELETE CASCADE;

ALTER TABLE ns_procurements_products
  ADD CONSTRAINT fk_pp_product
  FOREIGN KEY (product_id) REFERENCES ns_products(id) ON DELETE RESTRICT;
```

---

## é™„å½•

### A. å¸¸ç”¨æŸ¥è¯¢ç¤ºä¾‹

#### A.1 è·å–ä½åº“å­˜å•†å“

```sql
SELECT
  p.name,
  p.sku,
  puq.quantity AS current_stock,
  puq.low_quantity AS threshold,
  u.name AS unit_name
FROM ns_products p
INNER JOIN ns_products_unit_quantities puq ON p.id = puq.product_id
INNER JOIN ns_units u ON puq.unit_id = u.id
WHERE puq.stock_alert_enabled = 1
  AND puq.quantity <= puq.low_quantity
  AND p.stock_management = 'enabled'
ORDER BY puq.quantity ASC;
```

#### A.2 æŸ¥è¯¢å•†å“åº“å­˜å˜åŠ¨å†å²

```sql
SELECT
  ph.created_at,
  ph.operation_type,
  ph.before_quantity,
  ph.quantity AS change_quantity,
  ph.after_quantity,
  u.name AS unit_name,
  COALESCE(us.username, 'System') AS operator
FROM ns_products_histories ph
INNER JOIN ns_units u ON ph.unit_id = u.id
LEFT JOIN ns_users us ON ph.author = us.id
WHERE ph.product_id = 123
ORDER BY ph.created_at DESC
LIMIT 50;
```

#### A.3 è®¡ç®—å•†å“åº“å­˜æ€»å€¼

```sql
SELECT
  SUM(puq.quantity * puq.sale_price) AS total_inventory_value,
  SUM(puq.quantity * puq.cogs) AS total_cost_value,
  SUM(puq.quantity * (puq.sale_price - puq.cogs)) AS potential_profit
FROM ns_products_unit_quantities puq
INNER JOIN ns_products p ON puq.product_id = p.id
WHERE p.stock_management = 'enabled'
  AND p.status = 'available';
```

#### A.4 æŸ¥è¯¢å³å°†è¿‡æœŸçš„é‡‡è´­å•†å“

```sql
SELECT
  p.name AS product_name,
  pp.expiration_date,
  pp.available_quantity,
  u.name AS unit_name,
  DATEDIFF(pp.expiration_date, NOW()) AS days_until_expiry
FROM ns_procurements_products pp
INNER JOIN ns_products p ON pp.product_id = p.id
INNER JOIN ns_units u ON pp.unit_id = u.id
WHERE pp.expiration_date IS NOT NULL
  AND pp.available_quantity > 0
  AND pp.expiration_date <= DATE_ADD(NOW(), INTERVAL 30 DAY)
ORDER BY pp.expiration_date ASC;
```

### B. äº‹ä»¶å’Œé’©å­åˆ—è¡¨

#### B.1 å•†å“äº‹ä»¶

```php
// åˆ›å»ºå‰/å
ProductBeforeCreatedEvent
ProductAfterCreatedEvent

// æ›´æ–°å‰/å
ProductBeforeUpdatedEvent
ProductAfterUpdatedEvent

// åˆ é™¤å‰/å
ProductBeforeDeleteEvent
ProductAfterDeleteEvent

// åº“å­˜è°ƒæ•´å
ProductAfterStockAdjustmentEvent

// é‡ç½®
ProductResetEvent
```

#### B.2 é‡‡è´­äº‹ä»¶

```php
// é‡‡è´­å•åˆ›å»ºå‰/å
ProcurementBeforeCreateEvent
ProcurementAfterCreateEvent

// é‡‡è´­å•æ›´æ–°å‰/å
ProcurementBeforeUpdateEvent
ProcurementAfterUpdateEvent

// é‡‡è´­å•†å“åˆ›å»º/åˆ é™¤å
ProcurementProductAfterCreateEvent
ProcurementProductAfterDeleteEvent
```

#### B.3 é’©å­è¿‡æ»¤å™¨

```php
// è‡ªå®šä¹‰å‡å°‘åº“å­˜çš„æ“ä½œç±»å‹
Hook::addFilter('ns-products-decrease-actions', function($actions) {
    $actions[] = 'CUSTOM_REDUCTION';
    return $actions;
});

// è‡ªå®šä¹‰å¢åŠ åº“å­˜çš„æ“ä½œç±»å‹
Hook::addFilter('ns-products-increase-actions', function($actions) {
    $actions[] = 'CUSTOM_ADDITION';
    return $actions;
});

// è‡ªå®šä¹‰å•ä½æ•°é‡å­—æ®µ
Hook::addFilter('ns-products-units-quantities-fields-names', function($fields) {
    $fields[] = 'custom_field';
    return $fields;
});

// è‡ªå®šä¹‰POSæ¡å½¢ç æœç´¢URL
Hook::addFilter('ns-pos-submit-search-url', function($url, $barcode) {
    // ä¿®æ”¹æœç´¢URL
    return $url;
}, 10, 2);
```

### C. æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### C.1 æ•°æ®åº“ä¼˜åŒ–

1. **ä½¿ç”¨é¢„åŠ è½½å‡å°‘ N+1 æŸ¥è¯¢**
```php
// å·®ï¼šä¼šäº§ç”Ÿ N+1 æŸ¥è¯¢
$products = Product::all();
foreach ($products as $product) {
    echo $product->category->name;  // æ¯æ¬¡å¾ªç¯éƒ½æŸ¥è¯¢
}

// ä¼˜ï¼šä½¿ç”¨é¢„åŠ è½½
$products = Product::with('category')->get();
foreach ($products as $product) {
    echo $product->category->name;  // åªæŸ¥è¯¢ä¸€æ¬¡
}
```

2. **æ‰¹é‡æ’å…¥å†å²è®°å½•**
```php
// å·®ï¼šå¾ªç¯æ’å…¥
foreach ($changes as $change) {
    ProductHistory::create($change);
}

// ä¼˜ï¼šæ‰¹é‡æ’å…¥
ProductHistory::insert($changes);
```

3. **ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡**
```php
DB::transaction(function () {
    // å•†å“åˆ›å»ºå’Œåº“å­˜åˆå§‹åŒ–
    $product = Product::create($data);
    $product->unit_quantities()->createMany($units);
});
```

#### C.2 ç¼“å­˜ç­–ç•¥

```php
// ç¼“å­˜ä½åº“å­˜å•†å“åˆ—è¡¨ï¼ˆ15åˆ†é’Ÿï¼‰
$lowStockProducts = Cache::remember('low_stock_products', 900, function () {
    return ProductUnitQuantity::stockAlertEnabled()
        ->whereColumn('quantity', '<=', 'low_quantity')
        ->with('product', 'unit')
        ->get();
});

// ç¼“å­˜å•†å“åˆ†ç±»æ ‘ï¼ˆ1å°æ—¶ï¼‰
$categories = Cache::remember('product_categories_tree', 3600, function () {
    return ProductCategory::with('children')->whereNull('parent_id')->get();
});
```

#### C.3 å‰ç«¯ä¼˜åŒ–

1. **ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨åŠ è½½å¤§é‡å•†å“**
2. **å®ç°æœç´¢é˜²æŠ–ï¼ˆå·²å®ç° 200msï¼‰**
3. **æ‡’åŠ è½½å•†å“å›¾ç‰‡**
4. **ä½¿ç”¨ Service Worker ç¼“å­˜é™æ€èµ„æº**

### D. æ•…éšœæ’æŸ¥æŒ‡å—

#### D.1 æ¡å½¢ç æ‰«æä¸å·¥ä½œ

**é—®é¢˜**: æ‰«æåæ— ååº”

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥è‡ªåŠ¨èšç„¦æ˜¯å¦å¯ç”¨ï¼ˆæ¡å½¢ç å›¾æ ‡æŒ‰é’®æ˜¯å¦é«˜äº®ï¼‰
2. åœ¨æµè§ˆå™¨æ§åˆ¶å°æ£€æŸ¥æ˜¯å¦æœ‰ JavaScript é”™è¯¯
3. æ£€æŸ¥ API å“åº”ï¼š`/api/products/search/using-barcode/{barcode}`
4. éªŒè¯æ¡å½¢ç æ˜¯å¦å­˜åœ¨äºæ•°æ®åº“ä¸­
5. æµ‹è¯•æ‰«ææªæ˜¯å¦æ­£å¸¸å·¥ä½œï¼ˆåœ¨è®°äº‹æœ¬æµ‹è¯•ï¼‰

**å¸¸è§è§£å†³æ–¹æ¡ˆ**:
- åˆ·æ–°é¡µé¢å¹¶é‡æ–°å¯ç”¨è‡ªåŠ¨èšç„¦
- æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- éªŒè¯å•†å“çŠ¶æ€ä¸º `available`

#### D.2 åº“å­˜æ•°é‡ä¸å‡†ç¡®

**é—®é¢˜**: æ˜¾ç¤ºçš„åº“å­˜ä¸å®é™…ä¸ç¬¦

**æ’æŸ¥æ­¥éª¤**:
1. æŸ¥è¯¢åº“å­˜å†å²è¡¨ç¡®è®¤æ‰€æœ‰å˜åŠ¨è®°å½•
2. æ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„è®¢å•æˆ–é‡‡è´­å•
3. éªŒè¯å•ä½è½¬æ¢é…ç½®æ˜¯å¦æ­£ç¡®
4. æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†ç²¾ç¡®è¿½è¸ªä½†æœªæ­£ç¡®ä½¿ç”¨

**è§£å†³æ–¹æ¡ˆ**:
```sql
-- é‡æ–°è®¡ç®—å•†å“åº“å­˜ï¼ˆæ ¹æ®å†å²è®°å½•ï¼‰
UPDATE ns_products_unit_quantities puq
SET quantity = (
    SELECT COALESCE(SUM(
        CASE
            WHEN ph.operation_type IN ('STOCKED', 'ADDED', 'RETURNED', 'TRANSFER_IN')
            THEN ph.quantity
            WHEN ph.operation_type IN ('SOLD', 'REMOVED', 'DEFECTIVE', 'LOST', 'TRANSFER_OUT')
            THEN -ph.quantity
            ELSE 0
        END
    ), 0)
    FROM ns_products_histories ph
    WHERE ph.product_id = puq.product_id
      AND ph.unit_id = puq.unit_id
)
WHERE puq.product_id = 123;  -- æ›¿æ¢ä¸ºå®é™…å•†å“ID
```

#### D.3 ç§°é‡æ¡å½¢ç æ— æ³•è¯†åˆ«

**é—®é¢˜**: ç”µå­ç§¤æ¡å½¢ç æ‰«æåæŠ¥é”™

**æ’æŸ¥æ­¥éª¤**:
1. ç¡®è®¤ç§°é‡æ¡å½¢ç åŠŸèƒ½å·²å¯ç”¨ï¼š`è®¾ç½® â†’ POS â†’ Scale Barcode`
2. éªŒè¯ `ns_scale_barcode_enabled = yes`
3. æ£€æŸ¥å‰ç¼€é…ç½®æ˜¯å¦ä¸ç”µå­ç§¤ä¸€è‡´
4. éªŒè¯å•†å“æ˜¯å¦è®¾ç½®äº† PLU ç 
5. æ£€æŸ¥æ¡å½¢ç é•¿åº¦æ˜¯å¦ç¬¦åˆé…ç½®

**æµ‹è¯•æ–¹æ³•**:
```php
// åœ¨ Tinker ä¸­æµ‹è¯•
php artisan tinker

// æµ‹è¯•æ¡å½¢ç è§£æ
$barcode = '2123450150003';
$result = app(App\Services\ProductService::class)->parseScaleBarcode($barcode);
dd($result);

// è¾“å‡ºåº”åŒ…å«ï¼š
// [
//   "product_code" => "12345",
//   "value" => 1.5,
//   "type" => "weight",
//   "original_barcode" => "2123450150003"
// ]
```

---

## æ€»ç»“

NexoPOS æä¾›äº†**å®Œæ•´çš„ä¼ä¸šçº§åº“å­˜ç®¡ç†ç³»ç»Ÿ**ï¼Œå…·å¤‡ä»¥ä¸‹ä¼˜åŠ¿ï¼š

âœ… **æ¡å½¢ç æ‰«æå™¨åŸç”Ÿæ”¯æŒ** - å³æ’å³ç”¨ï¼Œæ— éœ€é¢å¤–å¼€å‘
âœ… **ç²¾ç¡®åº“å­˜è¿½è¸ª** - å®Œæ•´çš„å®¡è®¡æ—¥å¿—å’Œæ‰¹æ¬¡ç®¡ç†
âœ… **ç§°é‡å•†å“æ”¯æŒ** - PLU ç è‡ªåŠ¨è¯†åˆ«å’Œè§£æ
âœ… **å¤šå•ä½ç®¡ç†** - çµæ´»çš„å•ä½è½¬æ¢å’Œä»·æ ¼ä½“ç³»
âœ… **è‡ªåŠ¨æˆæœ¬æ ¸ç®—** - COGS è‡ªåŠ¨è®¡ç®—
âœ… **ä½åº“å­˜é¢„è­¦** - å¯é…ç½®é˜ˆå€¼å’Œé€šçŸ¥
âœ… **é‡‡è´­é›†æˆ** - é‡‡è´­å…¥åº“è‡ªåŠ¨æ›´æ–°åº“å­˜

**å»ºè®®ä½¿ç”¨æ¡å½¢ç æ‰«æå™¨å‹å·**:
- USB æ‰«ææªï¼ˆæ¨èï¼‰
- è“ç‰™æ‰«ææª
- æ‰‹æŒ PDA è®¾å¤‡
- æ‰‹æœºæ‘„åƒå¤´æ‰«æ

**å¼€å§‹ä½¿ç”¨**:
1. å¯ç”¨ POS è‡ªåŠ¨èšç„¦åŠŸèƒ½
2. é…ç½®ç§°é‡æ¡å½¢ç ï¼ˆå¦‚éœ€è¦ï¼‰
3. è¿æ¥ USB æ‰«ææª
4. å¼€å§‹æ‰«æé”€å”®ï¼

---

**æ–‡æ¡£ç»´æŠ¤**: å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æäº¤ Issue
**æœ€åæ›´æ–°**: 2026-01-23
**ä½œè€…**: NexoPOS å¼€å‘å›¢é˜Ÿ
