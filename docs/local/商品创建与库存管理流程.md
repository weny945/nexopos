# NexoPOS 商品创建与库存管理完整流程指南

## 📋 目录

- [核心概念](#核心概念)
- [实体关系详解](#实体关系详解)
- [商品创建流程](#商品创建流程)
- [库存管理方式](#库存管理方式)
- [实战演练](#实战演练)
- [常见问题解答](#常见问题解答)

## 核心概念

### ⚠️ 重要：商品创建 ≠ 库存数量

在 NexoPOS 中，**创建商品和添加库存是两个独立的步骤**：

```
第一步：创建商品（定义商品信息）
   ↓
   - 商品名称、分类、条形码
   - 单位配置、价格设置
   - ❌ 此时库存为 0

第二步：采购入库（添加库存数量）
   ↓
   - 创建采购单
   - 填写商品数量 ← 这里才填写 quantity！
   - ✅ 库存更新
```

### 为什么这样设计？

1. **符合真实业务流程**
   ```
   现实中：定义商品信息 → 采购进货 → 销售
   系统中：创建商品 → 采购单入库 → POS 销售
   ```

2. **库存追溯和审计**
   - 每次库存变动都有完整记录
   - 可追溯库存来源（供应商、时间、价格）
   - 符合财务和税务要求

3. **成本管理**
   - 采购单记录采购价格（COGS）
   - 销售时自动计算毛利润
   - 支持加权平均成本法

## 实体关系详解

### 完整关系图

```
Categories (产品分类)
    ↓ 一对多
Products (产品)
    ↓ 多对一
Unit Groups (单位组)
    ↓ 一对多
Units (单位)
    ↓ 通过中间表
ProductUnitQuantity (产品单位数量/库存)
```

### 数据库表结构

#### 1. Categories (ns_products_categories) - 产品分类

**字段结构：**
```sql
id              BIGINT      主键
name            VARCHAR     分类名称
parent_id       INT         父分类ID（支持多级分类）
displays_on_pos BOOLEAN     是否在POS显示
description     TEXT        描述
```

**关系：**
- `hasMany(Product)` - 一个分类包含多个产品
- `hasMany(self)` - 可以有子分类（树形结构）

**示例数据：**
```sql
id  name          parent_id  displays_on_pos
1   食品          0          true
2   主食          1          true
3   大米          2          true
4   饮料          1          true
5   碳酸饮料      4          true
6   日用品        0          true
```

#### 2. Unit Groups (ns_units_groups) - 单位组

**字段结构：**
```sql
id          BIGINT      主键
name        VARCHAR     单位组名称
description TEXT        描述
```

**关系：**
- `hasMany(Unit)` - 包含多个单位
- `hasMany(Product)` - 被多个产品使用

**示例数据：**
```sql
id  name          description
1   重量单位组    用于称重商品的单位
2   容量单位组    用于液体商品的单位
3   计数单位组    用于按个/箱销售的商品
```

#### 3. Units (ns_units) - 单位

**字段结构：**
```sql
id          BIGINT      主键
name        VARCHAR     单位名称
identifier  VARCHAR     单位标识符（唯一）
group_id    INT         所属单位组ID
value       FLOAT       换算值（相对于基础单位）
base_unit   BOOLEAN     是否为基础单位
```

**关系：**
- `belongsTo(UnitGroup)` - 属于某个单位组
- `hasMany(ProductUnitQuantity)` - 被多个产品使用

**示例数据：**
```sql
-- 重量单位组
id  name  identifier  group_id  value    base_unit
1   吨    T           1         1000     false
2   千克  KG          1         1        true   ← 基础单位
3   克    G           1         0.001    false
4   斤    JIN         1         0.5      false

-- 容量单位组
5   升    L           2         1        true   ← 基础单位
6   毫升  ML          2         0.001    false
7   加仑  GALLON      2         3.785    false

-- 计数单位组
8   件    PIECE       3         1        true   ← 基础单位
9   箱    BOX         3         12       false
10  打    DOZEN       3         12       false
```

#### 4. Products (ns_products) - 产品

**字段结构：**
```sql
id                  BIGINT      主键
name                VARCHAR     商品名称
category_id         INT         分类ID
unit_group          INT         单位组ID
barcode             VARCHAR     条形码
sku                 VARCHAR     SKU编码
status              VARCHAR     状态（available/unavailable）
stock_management    VARCHAR     库存管理（enabled/disabled）
product_type        VARCHAR     产品类型（product/variation/variable）
type                VARCHAR     类型（tangible/intangible）
```

**关系：**
- `belongsTo(Category)` - 属于某个分类
- `belongsTo(UnitGroup)` - 选择一个单位组
- `hasMany(ProductUnitQuantity)` - 有多个单位数量配置

**示例数据：**
```sql
id  name          category_id  unit_group  barcode          sku
1   泰国香米      3            1           6901234567890    RICE-TH-001
2   可口可乐      5            2           6902345678901    COKE-001
3   蓝月亮洗衣液  6            3           6903456789012    DETERGENT-001
```

#### 5. ProductUnitQuantity (ns_products_unit_quantities) - 产品单位数量/库存

**字段结构：**
```sql
id                          BIGINT      主键
product_id                  INT         产品ID
unit_id                     INT         单位ID
quantity                    FLOAT       库存数量 ← 重点！
low_quantity                FLOAT       低库存预警值
stock_alert_enabled         BOOLEAN     是否启用库存预警
barcode                     VARCHAR     该规格的条形码
sale_price                  FLOAT       零售价
wholesale_price             FLOAT       批发价
custom_price                FLOAT       自定义价
cogs                        FLOAT       销货成本
```

**关系：**
- `belongsTo(Product)` - 属于某个产品
- `belongsTo(Unit)` - 使用某个单位

**示例数据：**
```sql
-- 泰国香米的多规格库存
id  product_id  unit_id  quantity  barcode          sale_price  wholesale_price
1   1           3        500000    2100001          0.012       0.010
2   1           2        200       6901234567891    65.00       55.00
3   1           2        50        6901234567892    300.00      260.00

-- 可口可乐的多规格库存
4   2           6        1000      6902345678902    3.50        2.80
5   2           6        500       6902345678903    4.50        3.60
6   2           5        300       6902345678904    7.50        6.00
7   2           9        100       6902345678905    75.00       60.00
```

#### 6. Procurements (ns_procurements) - 采购单

**字段结构：**
```sql
id                  BIGINT      主键
name                VARCHAR     采购单名称
provider_id         INT         供应商ID
delivery_status     VARCHAR     交付状态
payment_status      VARCHAR     付款状态
invoice_reference   VARCHAR     发票号
created_at          DATETIME    创建时间
```

#### 7. ProcurementProducts (ns_procurements_products) - 采购明细

**字段结构：**
```sql
id                  BIGINT      主键
procurement_id      INT         采购单ID
product_id          INT         产品ID
unit_id             INT         单位ID
quantity            FLOAT       采购数量 ← 这里填写入库数量！
purchase_price      FLOAT       采购价格
total_price         FLOAT       小计
```

### 完整实例：超市商品管理系统

#### 示例：可口可乐商品

**1. 分类层级**
```
食品 (id=1)
  └─ 饮料 (id=4, parent_id=1)
       └─ 碳酸饮料 (id=5, parent_id=4)
            └─ 可口可乐 (product_id=2, category_id=5)
```

**2. 单位系统**
```
容量单位组 (id=2)
  ├─ 升 (id=5, value=1, base_unit=true)
  ├─ 毫升 (id=6, value=0.001, base_unit=false)
  └─ 箱 (id=9, value=12, base_unit=false)
```

**3. 商品信息**
```sql
-- ns_products
id: 2
name: 可口可乐
category_id: 5 (碳酸饮料)
unit_group: 2 (容量单位组)
barcode: 6902345678901
sku: COKE-001
```

**4. 多规格库存**
```
可口可乐 (product_id=2)
├─ 330ML 听装
│  ├─ unit_id: 6 (毫升)
│  ├─ quantity: 1000 听
│  ├─ barcode: 6902345678902
│  └─ sale_price: 3.50

├─ 500ML 瓶装
│  ├─ unit_id: 6 (毫升)
│  ├─ quantity: 500 瓶
│  ├─ barcode: 6902345678903
│  └─ sale_price: 4.50

├─ 1.25L 大瓶
│  ├─ unit_id: 5 (升)
│  ├─ quantity: 300 瓶
│  ├─ barcode: 6902345678904
│  └─ sale_price: 7.50

└─ 24听整箱
   ├─ unit_id: 9 (箱)
   ├─ quantity: 100 箱
   ├─ barcode: 6902345678905
   └─ sale_price: 75.00
```

## 商品创建流程

### 阶段 1：创建商品（定义商品信息）

#### 操作路径
```
仪表板 → 商品 (Products) → 创建 (Create)
或访问 URL: /dashboard/products/create
```

#### 表单填写详解

**1. 基本信息 (Identification)**
```
┌─────────────────────────────────────────┐
│ 商品名称 *        [可口可乐          ]  │
│ SKU编码 *         [COKE-001          ]  │
│ 条形码           [6901234567890      ]  │
│ 条形码类型       [EAN-13 ▼]            │
│ 描述             [清爽的碳酸饮料...  ]  │
└─────────────────────────────────────────┘
```

**2. 分类选择 (Category)**
```
┌─────────────────────────────────────────┐
│ 商品分类 *       [饮料 → 碳酸饮料 ▼]   │
│ 是否在POS显示   [✓] 显示               │
└─────────────────────────────────────────┘
```

**3. 单位组选择 (Unit Group)**
```
┌─────────────────────────────────────────┐
│ 单位组 *         [容量单位组 ▼]        │
│                                         │
│ 说明：选择单位组后，可配置该组内的单位 │
└─────────────────────────────────────────┘
```

**4. 单位配置 (Units) - ⚠️ 重点**
```
┌─────────────────────────────────────────┐
│ 单位配置                                │
├─────────────────────────────────────────┤
│ 规格 1：330ML 听装                      │
│ ├─ 选择单位 *    [毫升 ▼]              │
│ ├─ 条形码        [6902345678902     ]  │
│ ├─ 零售价 *      [3.50              ]  │
│ ├─ 批发价        [2.80              ]  │
│ ├─ 自定义价      [0.00              ]  │
│ └─ 库存数量      [留空或显示0]          │
│                  ⚠️ 注意：这里不填数量！ │
│                                         │
│ 规格 2：1.25L 瓶装                      │
│ ├─ 选择单位 *    [升 ▼]                │
│ ├─ 条形码        [6902345678904     ]  │
│ ├─ 零售价 *      [7.50              ]  │
│ ├─ 批发价        [6.00              ]  │
│ └─ 库存数量      [留空或显示0]          │
│                  ⚠️ 注意：这里不填数量！ │
│                                         │
│ [+ 添加更多单位]                        │
└─────────────────────────────────────────┘
```

**5. 库存设置 (Stock Settings)**
```
┌─────────────────────────────────────────┐
│ 库存管理         [✓] 启用库存管理      │
│ 精确追踪         [✓] 启用精确追踪      │
│ 商品状态         [可用 ▼]              │
│ 可搜索           [✓] 在POS可搜索        │
└─────────────────────────────────────────┘
```

**6. 税务设置 (Tax Settings)**
```
┌─────────────────────────────────────────┐
│ 税组             [标准税率组 ▼]        │
│ 税务类型         [含税 ▼]              │
└─────────────────────────────────────────┘
```

#### 点击"创建"后的结果

**数据库记录：**
```sql
-- ns_products 表
INSERT INTO ns_products (
    name, category_id, unit_group, barcode, sku
) VALUES (
    '可口可乐', 5, 2, '6901234567890', 'COKE-001'
);

-- ns_products_unit_quantities 表（自动创建）
INSERT INTO ns_products_unit_quantities (
    product_id, unit_id, quantity, barcode, sale_price
) VALUES
    (2, 6, 0, '6902345678902', 3.50),  -- 330ML，quantity = 0
    (2, 5, 0, '6902345678904', 7.50);  -- 1.25L，quantity = 0
```

**此时商品状态：**
- ✅ 商品信息已保存
- ✅ 价格已设置
- ✅ 可以在商品列表中查看
- ❌ **库存为 0**
- ❌ **无法在 POS 销售**（提示库存不足）

### 阶段 2：采购入库（添加库存数量）

#### 操作路径
```
仪表板 → 采购 (Procurements) → 创建 (Create)
或访问 URL: /dashboard/procurements/create
```

#### 采购单填写详解

**1. 基本信息**
```
┌─────────────────────────────────────────┐
│ 采购单基本信息                          │
├─────────────────────────────────────────┤
│ 供应商 *         [可口可乐公司 ▼]      │
│ 采购日期 *       [2026-01-24      ]    │
│ 发票号           [INV-2024-001    ]    │
│ 付款状态 *       [已付款 ▼]            │
│ 交付状态 *       [已交付 ▼]            │
│ 描述             [春节备货...     ]    │
└─────────────────────────────────────────┘
```

**2. 添加商品（重点：这里填写数量！）**
```
┌─────────────────────────────────────────┐
│ 商品列表                                │
├─────────────────────────────────────────┤
│ 搜索商品：[可口可乐________] [搜索]    │
│                                         │
│ 已添加商品：                            │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ 商品 1：可口可乐 330ML              │ │
│ │                                     │ │
│ │ 选择单位 *   [毫升 ▼]               │ │
│ │ 数量 *       [1000  ]  ← 这里填！  │ │
│ │ 采购价 *     [2.50  ]               │ │
│ │ 销售价       [3.50  ]（可选更新）   │ │
│ │ 税务         [标准税率 ▼]           │ │
│ │ 小计         2500.00                │ │
│ │                        [删除] [编辑] │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ 商品 2：可口可乐 1.25L              │ │
│ │                                     │ │
│ │ 选择单位 *   [升 ▼]                 │ │
│ │ 数量 *       [300   ]  ← 这里填！  │ │
│ │ 采购价 *     [5.00  ]               │ │
│ │ 销售价       [7.50  ]               │ │
│ │ 小计         1500.00                │ │
│ │                        [删除] [编辑] │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ [+ 添加商品]                            │
├─────────────────────────────────────────┤
│ 总计           4000.00                  │
│ 已付           4000.00                  │
│ 欠款           0.00                     │
└─────────────────────────────────────────┘
```

**3. 付款信息（可选）**
```
┌─────────────────────────────────────────┐
│ 付款方式         [现金 ▼]              │
│ 付款金额 *       [4000.00         ]    │
│ 付款日期         [2026-01-24      ]    │
└─────────────────────────────────────────┘
```

#### 点击"保存采购单"后的结果

**数据库更新：**

```sql
-- 1. 创建采购单
INSERT INTO ns_procurements (
    name, provider_id, delivery_status, payment_status
) VALUES (
    '采购单-20260124-001', 1, 'delivered', 'paid'
);

-- 2. 创建采购明细
INSERT INTO ns_procurements_products (
    procurement_id, product_id, unit_id, quantity, purchase_price
) VALUES
    (1, 2, 6, 1000, 2.50),  -- 330ML × 1000
    (1, 2, 5, 300, 5.00);   -- 1.25L × 300

-- 3. 更新库存数量 ← 关键操作！
UPDATE ns_products_unit_quantities
SET quantity = quantity + 1000,
    cogs = 2.50
WHERE product_id = 2 AND unit_id = 6;

UPDATE ns_products_unit_quantities
SET quantity = quantity + 300,
    cogs = 5.00
WHERE product_id = 2 AND unit_id = 5;

-- 4. 创建库存历史记录
INSERT INTO ns_products_histories (
    product_id, procurement_id, operation_type,
    unit_id, quantity, before_quantity, after_quantity
) VALUES
    (2, 1, 'STOCKED', 6, 1000, 0, 1000),
    (2, 1, 'STOCKED', 5, 300, 0, 300);
```

**此时商品状态：**
- ✅ 可口可乐 330ML - 库存 **1000 听**
- ✅ 可口可乐 1.25L - 库存 **300 瓶**
- ✅ **可以在 POS 销售**
- ✅ 有完整的采购记录
- ✅ 成本价已记录（COGS）

## 库存管理方式

### 方式 1：采购入库（Procurement）← **主要方式**

**适用场景：**
- 从供应商批量采购商品
- 需要记录采购成本
- 需要追溯库存来源

**操作流程：**
```
1. 仪表板 → 采购 → 创建采购单
2. 选择供应商
3. 添加商品并填写数量
4. 填写采购价格
5. 保存采购单
6. 库存自动增加
```

**优点：**
- ✅ 完整的业务流程记录
- ✅ 自动记录采购成本（COGS）
- ✅ 支持批量导入
- ✅ 可以打印采购单

**数据库操作：**
```sql
-- 创建采购单 → 创建明细 → 增加库存 → 记录历史
```

### 方式 2：库存调整（Stock Adjustment）

**适用场景：**
- 库存盘点后调整
- 商品损耗
- 数据修正
- 快速添加库存（测试环境）

**操作流程：**
```
1. 仪表板 → 商品 → 库存调整
   或访问：/dashboard/products/stock-adjustment

2. 搜索商品

3. 选择调整操作：
   ├─ add（添加库存）
   ├─ remove（扣减库存）
   ├─ set（设置库存为指定值）
   └─ deleted（删除库存）

4. 填写数量

5. 填写调整原因

6. 保存
```

**调整类型详解：**

```
添加库存 (add)
├─ 输入：增加 100
├─ 当前库存：500
└─ 结果：600

扣减库存 (remove)
├─ 输入：减少 50
├─ 当前库存：500
└─ 结果：450

设置库存 (set)
├─ 输入：设为 300
├─ 当前库存：500
└─ 结果：300（直接设置）

删除库存 (deleted)
├─ 当前库存：500
└─ 结果：0（清零）
```

**优点：**
- ✅ 快速简单
- ✅ 适合小批量调整
- ✅ 有调整原因记录

**缺点：**
- ❌ 不记录采购成本
- ❌ 不关联供应商
- ❌ 不适合大批量采购

**数据库操作：**
```sql
-- 直接更新库存 → 记录历史
UPDATE ns_products_unit_quantities
SET quantity = quantity + 100
WHERE product_id = 1 AND unit_id = 2;

INSERT INTO ns_products_histories (
    operation_type, quantity, reason
) VALUES (
    'ADJUSTMENT_ADD', 100, '盘点补充'
);
```

### 方式 3：单位转换（Unit Conversion）

**适用场景：**
- 将批发装拆分为零售装
- 将零售装合并为批发装
- 在不同单位间转换库存

**操作流程：**
```
1. 商品列表 → 选择商品 → 操作 → 转换单位
   或 API：POST /api/products/{id}/units/convert

2. 选择源单位（From）
   例如：箱（24听/箱）

3. 选择目标单位（To）
   例如：听

4. 填写转换数量
   例如：10箱

5. 确认转换
   结果：
   - 箱库存：-10
   - 听库存：+240
```

**转换示例：**

```
案例 1：拆箱
├─ 可口可乐 24听整箱：100 箱
├─ 拆分：10 箱 → 240 听
└─ 结果：
    ├─ 箱：90 箱
    └─ 听：+240 听

案例 2：合箱
├─ 可口可乐 330ML：500 听
├─ 合并：240 听 → 10 箱
└─ 结果：
    ├─ 听：260 听
    └─ 箱：+10 箱
```

**数据库操作：**
```sql
-- 扣减源单位库存
UPDATE ns_products_unit_quantities
SET quantity = quantity - 10
WHERE product_id = 2 AND unit_id = 9; -- 箱

-- 增加目标单位库存
UPDATE ns_products_unit_quantities
SET quantity = quantity + 240
WHERE product_id = 2 AND unit_id = 8; -- 听

-- 记录转换历史
INSERT INTO ns_products_histories ...
```

### 方式 4：POS 销售（自动扣减）

**适用场景：**
- 正常销售流程
- 库存自动扣减
- 无需手动操作

**流程：**
```
1. 打开 POS 收银台
2. 扫描商品条形码或搜索商品
3. 添加到购物车
4. 结账
5. 系统自动扣减库存
```

**数据库操作：**
```sql
-- POS 销售后自动执行
UPDATE ns_products_unit_quantities
SET quantity = quantity - 1
WHERE product_id = 2 AND unit_id = 6;

INSERT INTO ns_products_histories (
    operation_type, quantity, order_id
) VALUES (
    'SOLD', -1, 123
);
```

### 方式 5：退货处理（Returns）

**适用场景：**
- 客户退货
- 库存退回

**流程：**
```
1. 订单管理 → 选择订单 → 退款/退货
2. 选择退货商品
3. 填写退货数量
4. 确认退货
5. 库存自动增加
```

**数据库操作：**
```sql
-- 退货后库存增加
UPDATE ns_products_unit_quantities
SET quantity = quantity + 1
WHERE product_id = 2 AND unit_id = 6;

INSERT INTO ns_products_histories (
    operation_type, quantity, order_id
) VALUES (
    'RETURNED', 1, 123
);
```

## 实战演练

### 完整示例：从创建到销售

#### 场景：新增农夫山泉矿泉水

**第一步：创建商品**

```
1. 访问：仪表板 → 商品 → 创建

2. 填写基本信息：
   ┌────────────────────────────┐
   │ 商品名称：农夫山泉         │
   │ SKU：WATER-NFS-001         │
   │ 条形码：6903456789100      │
   │ 分类：饮料 → 矿泉水        │
   │ 单位组：容量单位组         │
   └────────────────────────────┘

3. 配置单位（quantity 留空）：
   ┌────────────────────────────┐
   │ 规格 1：500ML 瓶装         │
   │ ├─ 单位：毫升              │
   │ ├─ 条形码：6903456789101   │
   │ ├─ 零售价：2.50            │
   │ ├─ 批发价：2.00            │
   │ └─ 库存：（留空）          │
   │                            │
   │ 规格 2：24瓶整箱           │
   │ ├─ 单位：箱                │
   │ ├─ 条形码：6903456789102   │
   │ ├─ 零售价：55.00           │
   │ ├─ 批发价：45.00           │
   │ └─ 库存：（留空）          │
   └────────────────────────────┘

4. 保存商品
```

**结果：**
```sql
-- ns_products
id: 10
name: 农夫山泉
category_id: 7 (矿泉水)
unit_group: 2 (容量单位组)

-- ns_products_unit_quantities
id  product_id  unit_id  quantity  barcode          sale_price
20  10          6        0         6903456789101    2.50
21  10          9        0         6903456789102    55.00
```

**状态：**
- ✅ 商品已创建
- ❌ 库存为 0
- ❌ 无法销售

**第二步：采购入库**

```
1. 访问：仪表板 → 采购 → 创建采购单

2. 填写采购信息：
   ┌────────────────────────────┐
   │ 供应商：农夫山泉公司       │
   │ 采购日期：2026-01-24       │
   │ 发票号：INV-NFS-001        │
   │ 付款状态：已付款           │
   └────────────────────────────┘

3. 添加商品（填写数量）：
   ┌────────────────────────────┐
   │ 商品 1：农夫山泉           │
   │ ├─ 单位：毫升 (500ML)      │
   │ ├─ 数量：2000 瓶  ← 填！  │
   │ ├─ 采购价：1.80            │
   │ └─ 小计：3600.00           │
   │                            │
   │ 商品 2：农夫山泉           │
   │ ├─ 单位：箱 (24瓶)         │
   │ ├─ 数量：100 箱   ← 填！  │
   │ ├─ 采购价：40.00           │
   │ └─ 小计：4000.00           │
   ├────────────────────────────┤
   │ 总计：7600.00              │
   └────────────────────────────┘

4. 保存采购单
```

**结果：**
```sql
-- ns_procurements
id: 5
name: 采购单-20260124-005
provider_id: 5 (农夫山泉公司)

-- ns_procurements_products
id  procurement_id  product_id  unit_id  quantity  purchase_price
50  5              10          6        2000      1.80
51  5              10          9        100       40.00

-- ns_products_unit_quantities (更新)
id  product_id  unit_id  quantity  barcode          sale_price
20  10          6        2000      6903456789101    2.50
21  10          9        100       6903456789102    55.00
```

**状态：**
- ✅ 库存已更新
- ✅ 500ML：2000 瓶
- ✅ 24瓶装：100 箱
- ✅ 可以销售

**第三步：POS 销售**

```
1. 访问：POS 收银台 (/dashboard/pos)

2. 扫描条形码：6903456789101

3. 系统自动：
   ├─ 识别商品：农夫山泉 500ML
   ├─ 价格：2.50
   ├─ 添加到购物车
   └─ 数量：1

4. 结账：
   ├─ 总计：2.50
   ├─ 收款：5.00
   └─ 找零：2.50

5. 完成交易
```

**结果：**
```sql
-- ns_orders (创建订单)
id: 123
total: 2.50
payment_status: paid

-- ns_orders_products (订单商品)
id  order_id  product_id  quantity  unit_price
200 123       10          1         2.50

-- ns_products_unit_quantities (库存扣减)
UPDATE ns_products_unit_quantities
SET quantity = 1999  -- 2000 - 1
WHERE id = 20;

-- ns_products_histories (历史记录)
id  product_id  operation_type  quantity  before  after
300 10          SOLD           -1        2000    1999
```

**状态：**
- ✅ 销售完成
- ✅ 库存自动扣减
- ✅ 当前库存：1999 瓶

**第四步：查看库存历史**

```
1. 访问：商品列表 → 农夫山泉 → 历史记录

2. 查看记录：
   ┌─────────────────────────────────────┐
   │ 日期         操作     数量    余额   │
   ├─────────────────────────────────────┤
   │ 2026-01-24  STOCKED  +2000   2000  │
   │ 2026-01-24  SOLD     -1      1999  │
   │ 2026-01-24  SOLD     -1      1998  │
   └─────────────────────────────────────┘
```

### 示例 2：库存调整（快速方式）

#### 场景：测试环境快速添加库存

```
1. 访问：仪表板 → 商品 → 库存调整

2. 搜索商品：农夫山泉

3. 选择规格：500ML 瓶装

4. 调整操作：
   ┌────────────────────────────┐
   │ 操作类型：添加 (add)       │
   │ 数量：500                  │
   │ 原因：测试数据             │
   └────────────────────────────┘

5. 保存

6. 结果：
   库存：1999 → 2499
```

### 示例 3：单位转换

#### 场景：拆箱销售

```
1. 当前库存：
   ├─ 24瓶整箱：100 箱
   └─ 500ML 瓶装：2499 瓶

2. 操作：拆 10 箱为单瓶
   ├─ 源单位：箱
   ├─ 目标单位：瓶（500ML）
   ├─ 数量：10 箱
   └─ 换算：10 × 24 = 240 瓶

3. 结果：
   ├─ 24瓶整箱：90 箱
   └─ 500ML 瓶装：2739 瓶
```

## 常见问题解答

### Q1: 创建商品时为什么没有数量字段？

**A:** 这是 NexoPOS 的设计理念。

**原因：**
- 符合真实业务流程（先定义商品，再采购入库）
- 保证库存追溯性（每次入库都有来源记录）
- 支持成本管理（采购单记录成本价）

**解决方案：**
- 创建商品后，通过**采购单**添加库存
- 或使用**库存调整**功能快速添加

### Q2: 已创建的商品如何添加库存？

**A:** 有两种主要方式：

**方式 1：采购单（推荐）**
```
仪表板 → 采购 → 创建采购单
→ 选择供应商
→ 添加商品
→ 填写数量
→ 保存
```

**方式 2：库存调整（快速）**
```
仪表板 → 商品 → 库存调整
→ 搜索商品
→ 选择"添加"操作
→ 填写数量
→ 保存
```

### Q3: 如何查看商品当前库存？

**A:** 多种方式：

**方式 1：商品列表**
```
仪表板 → 商品 → 列表
每个商品显示总库存数量
```

**方式 2：商品详情**
```
商品列表 → 点击商品名称
查看各单位的详细库存
```

**方式 3：库存报表**
```
仪表板 → 报表 → 库存报表
查看所有商品库存汇总
```

**方式 4：API 查询**
```bash
GET /api/products/{id}/units
```

### Q4: 同一商品可以有多个规格的库存吗？

**A:** 可以！这是 NexoPOS 的核心功能。

**示例：**
```
可口可乐
├─ 330ML 听装 - 库存 1000 听
├─ 500ML 瓶装 - 库存 500 瓶
├─ 1.25L 大瓶 - 库存 300 瓶
└─ 24听整箱 - 库存 100 箱

每个规格：
- 独立的库存数量
- 独立的条形码
- 独立的价格
```

### Q5: 库存变动有历史记录吗？

**A:** 有完整的审计日志。

**记录内容：**
- 操作类型（STOCKED、SOLD、ADJUSTMENT_ADD 等）
- 变动数量
- 变动前后库存
- 操作人
- 操作时间
- 关联单据（采购单、销售单）

**查看方式：**
```
商品列表 → 选择商品 → 历史记录
或 URL：/dashboard/products/{id}/history
```

### Q6: 采购单和库存调整有什么区别？

**A:** 对比如下：

| 特性 | 采购单 | 库存调整 |
|------|--------|----------|
| **适用场景** | 从供应商采购 | 盘点、损耗、修正 |
| **记录成本** | ✅ 记录采购价 | ❌ 不记录成本 |
| **关联供应商** | ✅ 是 | ❌ 否 |
| **批量操作** | ✅ 支持 | ✅ 支持 |
| **打印单据** | ✅ 可打印 | ❌ 不打印 |
| **财务记录** | ✅ 完整 | ⚠️ 简单 |
| **推荐用途** | 正式采购 | 快速调整 |

**建议：**
- 正式采购：使用**采购单**
- 快速测试、盘点调整：使用**库存调整**

### Q7: 创建商品时可以设置初始库存吗？

**A:** 不可以，必须分两步操作。

**原因：**
1. 初始库存也需要记录来源
2. 需要记录成本价
3. 符合会计准则

**解决方案：**
```
步骤 1：创建商品（quantity = 0）
步骤 2：创建"期初库存"采购单
        - 供应商：选择"期初库存"
        - 填写初始数量
        - 填写成本价
        - 保存
```

### Q8: 如何设置库存预警？

**A:** 在单位配置中设置。

**操作：**
```
1. 编辑商品

2. 在单位配置中：
   ┌────────────────────────────┐
   │ 单位：毫升 (500ML)         │
   │ 当前库存：1999             │
   │ 低库存预警：[✓] 启用       │
   │ 预警值：100                │
   └────────────────────────────┘

3. 保存

4. 当库存 < 100 时：
   - 商品列表显示警告图标
   - 仪表板显示低库存提醒
   - 可配置邮件通知
```

### Q9: 误操作如何恢复库存？

**A:** 使用库存调整功能。

**场景 1：误删除库存**
```
库存调整 → 选择"添加" → 填写数量 → 原因"误删除恢复"
```

**场景 2：误扣减库存**
```
库存调整 → 选择"添加" → 填写扣减的数量
```

**场景 3：误增加库存**
```
库存调整 → 选择"扣减" → 填写增加的数量
```

### Q10: 可以批量导入商品和库存吗？

**A:** 可以，但需要分两步。

**步骤 1：批量导入商品**
```
方式 1：使用 CSV 导入
仪表板 → 商品 → 导入

方式 2：使用 API
POST /api/products/bulk-create
```

**步骤 2：批量创建采购单**
```
方式 1：手动创建采购单
仪表板 → 采购 → 创建 → 添加多个商品

方式 2：使用 API
POST /api/procurements
```

**CSV 格式示例：**
```csv
name,sku,barcode,category,unit_group,unit,price,quantity
农夫山泉,WATER-001,6901234567890,饮料,容量单位组,毫升,2.50,0
可口可乐,COKE-001,6902345678901,饮料,容量单位组,毫升,3.50,0
```

## 📊 数据流程图

### 完整业务流程

```
┌─────────────┐
│ 创建商品    │  quantity = 0
│ (Product)   │  定义商品信息、价格
└──────┬──────┘
       │
       ↓
┌─────────────┐
│ 采购入库    │  填写 quantity
│ (Procurement) │  记录成本价
└──────┬──────┘
       │
       ↓
┌─────────────┐
│ 库存增加    │  quantity += n
│ (Stock Up)  │  创建历史记录
└──────┬──────┘
       │
       ↓
┌─────────────┐
│ POS 销售    │  扫描条形码
│ (Sales)     │  添加到购物车
└──────┬──────┘
       │
       ↓
┌─────────────┐
│ 库存扣减    │  quantity -= n
│ (Stock Down)│  创建销售记录
└─────────────┘
```

### 数据表关系流程

```
ns_products
    ↓ (创建时)
ns_products_unit_quantities (quantity = 0)
    ↓ (采购单)
ns_procurements → ns_procurements_products
    ↓ (更新库存)
ns_products_unit_quantities (quantity += n)
    ↓ (记录历史)
ns_products_histories (operation_type = STOCKED)
    ↓ (POS 销售)
ns_orders → ns_orders_products
    ↓ (扣减库存)
ns_products_unit_quantities (quantity -= n)
    ↓ (记录历史)
ns_products_histories (operation_type = SOLD)
```

## 🔗 相关资源

### 文档
- [本地启动指南](本地启动指南.md) - 如何启动开发环境
- [库存管理系统完整指南](库存管理系统完整指南.md) - 系统架构详解
- [条形码扫描器快速上手指南](条形码扫描器快速上手指南.md) - 扫描功能使用

### 源代码
- **商品服务**: `app/Services/ProductService.php`
- **采购服务**: `app/Services/ProcurementService.php`
- **商品模型**: `app/Models/Product.php`
- **库存模型**: `app/Models/ProductUnitQuantity.php`
- **采购页面**: `resources/ts/pages/dashboard/procurements/ns-procurement.vue`

### API 端点
```
POST   /api/products              创建商品
GET    /api/products/{id}         查看商品
PUT    /api/products/{id}         更新商品
GET    /api/products/{id}/units   查看库存
POST   /api/procurements          创建采购单
POST   /api/products/stock-adjustment  库存调整
```

### 数据库表
```
ns_products                    商品主表
ns_products_categories         商品分类
ns_products_unit_quantities    产品单位数量（库存）
ns_units_groups                单位组
ns_units                       单位
ns_procurements                采购单
ns_procurements_products       采购明细
ns_products_histories          库存历史
```

## 📝 总结

### 核心要点

1. **商品创建时不填数量**
   - 创建商品 = 定义商品信息
   - quantity 字段自动为 0
   - 需要通过采购单或库存调整添加库存

2. **采购单是主要入库方式**
   - 记录供应商、成本价
   - 支持批量添加商品
   - 自动更新库存并创建历史

3. **库存调整用于快速修正**
   - 适合盘点、损耗、测试
   - 操作简单快速
   - 不记录详细成本信息

4. **多规格独立管理**
   - 同一商品可有多个规格
   - 每个规格独立库存、价格、条形码
   - 支持单位间转换

5. **完整的历史追溯**
   - 所有库存变动都有记录
   - 可追溯到具体操作和单据
   - 支持审计和对账

### 快速操作指南

```
创建商品：
仪表板 → 商品 → 创建 → 填写信息 → 保存

添加库存：
仪表板 → 采购 → 创建 → 添加商品 → 填写数量 → 保存

查看库存：
仪表板 → 商品 → 列表 → 查看数量

调整库存：
仪表板 → 商品 → 库存调整 → 搜索 → 调整 → 保存
```

---

**最后更新**: 2026-01-24
**适用版本**: NexoPOS 5.x (Laravel 12.x)
**维护者**: NexoPOS 开发团队
